<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ú©Ø§Ø±Øªâ€ŒØ¨Ù‡â€ŒÚ©Ø§Ø±Øª â€” Ú©Ø¯ Ù¾ÙˆÛŒØ§</title>

  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />

  <style>
    /* ---------------------- Ø·Ø±Ø§Ø­ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ ÙÛŒÙ†â€ŒØªÚ© (Ø¨Ø§Ù†Ú©Ø¯Ø§Ø±ÛŒ Ù…Ø¯Ø±Ù†) ---------------------- */
    :root {
      --color-primary: #002d62;       /* Ø¢Ø¨ÛŒ ØªÛŒØ±Ù‡ Ø³Ù„Ø·Ù†ØªÛŒ (Navy Blue) */
      --color-secondary: #004a99;     /* Ø¢Ø¨ÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ùˆ Ù‡Ø§ÛŒÙ„Ø§ÛŒØª */
      --color-text: #1f2937;          /* Ø®Ø§Ú©Ø³ØªØ±ÛŒ Ø°ØºØ§Ù„ÛŒ ØªÛŒØ±Ù‡ Ø¨Ø±Ø§ÛŒ Ù…ØªÙ† Ø§ØµÙ„ÛŒ */
      --color-muted: #6b7280;         /* Ø®Ø§Ú©Ø³ØªØ±ÛŒ Ù…ØªÙˆØ³Ø· Ø¨Ø±Ø§ÛŒ Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ */
      --color-background: #f8f9fa;    /* Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø®ÛŒÙ„ÛŒ Ø±ÙˆØ´Ù† */
      --color-card-bg: #ffffff;       /* Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ú©Ø§Ø±Øª Ø³ÙÛŒØ¯ Ø®Ø§Ù„Øµ */
      --color-border: #e5e7eb;        /* Ø®Ø·ÙˆØ· Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ Ù†Ø§Ø²Ú© */
      --color-success: #16a34a;       /* Ø³Ø¨Ø² ØªØ§ÛŒÛŒØ¯ */
      --color-danger: #dc2626;        /* Ù‚Ø±Ù…Ø² Ù‡Ø´Ø¯Ø§Ø± */
      --color-warning: #facc15;       /* Ø²Ø±Ø¯ Ù‡Ø´Ø¯Ø§Ø± */
      --radius-default: 8px;          /* Ø´Ø¹Ø§Ø¹ Ú¯ÙˆØ´Ù‡â€ŒÙ‡Ø§ */
      --shadow-main: 0 10px 30px rgba(0, 0, 0, 0.05);
    }

    * {
      box-sizing: border-box;
      font-family: 'Vazirmatn', Tahoma, Arial, 'Segoe UI', system-ui, sans-serif;
      direction: rtl;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background-color: var(--color-background);
      color: var(--color-text);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
    }

    .wrap { width: 100%; max-width: 550px; }

    header { display: flex; flex-direction: column; margin-bottom: 25px; }
    h1 {
      margin: 0;
      color: var(--color-primary);
      font-size: 28px;
      font-weight: 700;
      padding-bottom: 5px;
    }
    h2 {
      font-size: 20px;
      font-weight: 600;
      color: var(--color-text);
      margin: 20px 0 15px 0;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--color-border);
    }
    h3 {
        font-size: 18px;
        font-weight: 600;
        color: var(--color-text);
        margin: 25px 0 15px 0;
    }

    .card {
      background: var(--color-card-bg);
      padding: 30px;
      border-radius: var(--radius-default);
      box-shadow: var(--shadow-main);
      border: 1px solid var(--color-border);
    }

    /* ÙØ±Ù… Ùˆ Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ */
    label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--color-text);
      margin-bottom: 8px;
    }

    input, textarea, select {
      width: 100%;
      padding: 13px 15px;
      border-radius: 6px;
      border: 1px solid var(--color-border);
      background: var(--color-background);
      color: var(--color-text);
      font-size: 16px;
      transition: all 0.2s ease;
    }
    input:focus, textarea:focus {
      border-color: var(--color-secondary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 74, 153, 0.1);
    }

    .row { display: flex; gap: 10px; margin-top: 20px; }

    .btn {
      cursor: pointer;
      padding: 13px 15px;
      border-radius: 6px;
      border: 0;
      background: var(--color-secondary);
      color: #fff;
      font-weight: 600;
      transition: background-color .2s ease;
    }
    .btn:hover { background: var(--color-primary); }
    .btn:disabled { opacity: 0.7; cursor: not-allowed; }

    .ghost {
      background: transparent;
      border: 1px solid var(--color-border);
      color: var(--color-text);
    }
    .ghost:hover { background: var(--color-background); }

    .code {
      font-family: monospace;
      background: #e0f2fe; /* Ø¢Ø¨ÛŒ Ø±ÙˆØ´Ù† Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ú©Ø³ Ú©Ø¯ */
      color: var(--color-primary);
      padding: 12px 15px;
      border-radius: 6px;
      border: 1px dashed var(--color-secondary);
      user-select: text;
      font-size: 16px;
      margin-top: 10px;
    }

    .panel {
      background: var(--color-background);
      padding: 15px;
      border-radius: var(--radius-default);
      border: 1px solid var(--color-border);
      margin-top: 25px;
    }
    .panel.info { border-left: 4px solid var(--color-secondary); }

    footer {
      margin-top: 25px;
      color: var(--color-muted);
      font-size: 13px;
      text-align: center;
    }

    .small { font-size: 13px; color: var(--color-muted); line-height: 1.6; }
    .muted { color: var(--color-muted); font-size: 14px; }

    .success {
      background: #ecfdf5;
      border: 1px solid #d1fae5;
      padding: 15px;
      border-radius: 6px;
      color: var(--color-success);
    }
    .danger {
      background: #fef2f2;
      border: 1px solid #fecaca;
      padding: 15px;
      border-radius: 6px;
      color: var(--color-danger);
      font-weight: 600;
      margin-top: 20px;
    }

    ul { padding-right: 20px; list-style-type: 'â€” '; margin-top: 10px; }
    ul li { margin-bottom: 5px; font-size: 14px; }
    
    .status-text { margin-top: 15px; padding: 10px; border-radius: 6px; font-weight: 500; }
    .status-text.ok { background: #e6ffed; color: var(--color-success); border: 1px solid #c8e6c9; }
    .status-text.err { background: #ffeded; color: var(--color-danger); border: 1px solid #e7c8c8; }
    
    #resultArea b { font-weight: 700; color: var(--color-primary); }
  </style>

Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body>
Â  <div class="wrap">
Â  Â  <header>
Â  Â  Â  <h1>ğŸ’³ Ø§Ù†ØªÙ‚Ø§Ù„ ÙˆØ¬Ù‡ (Ú©Ø§Ø±Øªâ€ŒØ¨Ù‡â€ŒÚ©Ø§Ø±Øª)</h1>
Â  Â  Â  <p class="muted">ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯ Ù¾ÙˆÛŒØ§ (OTP) Ø¨Ø±Ø§ÛŒ ØªØ£ÛŒÛŒØ¯ ÙØ±Ø³ØªÙ†Ø¯Ù‡ØŒ Ø³Ù¾Ø³ ØªØ£ÛŒÛŒØ¯ ØªØ±Ø§Ú©Ù†Ø´ Ù†Ù‡Ø§ÛŒÛŒ.</p>
Â  Â  </header>

Â  Â  <div class="card">
Â  Â  Â  <section>
Â  Â  Â  Â  <h2>Û±. Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø¯ Ù¾ÙˆÛŒØ§ Ùˆ Ø§Ø±Ø³Ø§Ù„</h2>
Â  Â  Â  Â  <div style="margin-top:12px">
Â  Â  Â  Â  Â  <label for="srcChat">Chat ID ÙØ±Ø³ØªÙ†Ø¯Ù‡ (Ø­Ø³Ø§Ø¨ Ú©Ø³Ø±Ú©Ù†Ù†Ø¯Ù‡)</label>
Â  Â  Â  Â  Â  <input id="srcChat" placeholder="Ù…Ø«Ø§Ù„: 123456789" />
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="margin-top:12px">
Â  Â  Â  Â  Â  <label for="amount">Ù…Ø¨Ù„Øº (â› ÙˆØ§Ø­Ø¯ Ø³Ú©Ù‡)</label>
Â  Â  Â  Â  Â  <input id="amount" type="number" min="1" step="1" placeholder="Ù…Ø«Ø§Ù„: 150000" />
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="margin-top:12px">
Â  Â  Â  Â  Â  <label for="targetChat">Chat ID Ú¯ÛŒØ±Ù†Ø¯Ù‡ (Ø­Ø³Ø§Ø¨ Ù…Ù‚ØµØ¯)</label>
Â  Â  Â  Â  Â  <input id="targetChat" placeholder="Chat ID Ú¯ÛŒØ±Ù†Ø¯Ù‡" />
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <button id="genCodeBtn" class="btn" style="flex:2;">Ø¯Ø±ÛŒØ§ÙØª Ùˆ Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ Ù¾ÙˆÛŒØ§ Ø¨Ù‡ ÙØ±Ø³ØªÙ†Ø¯Ù‡</button>
Â  Â  Â  Â  Â  <button id="clearBtn" class="ghost" style="flex:1;">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <h3 style="margin-top: 35px;">Û². ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ú©Ø¯ Ù¾ÙˆÛŒØ§ Ùˆ ØªØ§ÛŒÛŒØ¯</h3>
Â  Â  Â  Â  <div style="margin-top:8px">
Â  Â  Â  Â  Â  <label for="pasteCode">Ú©Ø¯ Ù¾ÙˆÛŒØ§ (OTP) Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø§Ø² ÙØ±Ø³ØªÙ†Ø¯Ù‡</label>
Â  Â  Â  Â  Â  <input id="pasteCode" placeholder="Ú©Ø¯ Û²Û¶ Ø±Ù‚Ù…ÛŒ" maxlength="26" />
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="margin-top:10px" class="row">
Â  Â  Â  Â  Â  <button id="verifyBtn" class="btn" style="flex:2;">ØªØ§ÛŒÛŒØ¯ Ùˆ Ø§Ù†Ø¬Ø§Ù… Ø§Ù†ØªÙ‚Ø§Ù„</button>
Â  Â  Â  Â  Â  <button id="checkBtn" class="ghost" style="flex:1;">Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø¯</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="resultArea" style="margin-top:20px"></div>
Â  Â  Â  </section>

Â  Â  Â  <div id="settingsPanel" class="panel info">
Â  Â  Â  Â  <div class="muted">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ùˆ Ù‡Ø´Ø¯Ø§Ø±</div>
Â  Â  Â  Â  <div style="margin-top:8px" class="small">
            <label style="display:inline;"><input id="autoSend" type="checkbox" checked style="width:auto;margin-left:5px;" /> Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ¯Ú©Ø§Ø± Ú©Ø¯ Ù¾ÙˆÛŒØ§ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù… ÙØ±Ø³ØªÙ†Ø¯Ù‡ (Chat ID)</label>
        </div>
        <div class="danger" style="margin-top:10px; padding: 10px;">
             âš ï¸ **ØªÙˆØ¬Ù‡:** Ø§ÛŒÙ† Ø¨Ø±Ù†Ø§Ù…Ù‡ ÙÙ‚Ø· Ù…Ø³Ø¦ÙˆÙ„ ØªÙˆÙ„ÛŒØ¯ Ùˆ ØªØ§ÛŒÛŒØ¯ Ú©Ø¯ Ù¾ÙˆÛŒØ§ Ø¬Ù‡Øª **Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ØªØ±Ø§Ú©Ù†Ø´** Ø§Ø³Øª. **Ø§Ù†ØªÙ‚Ø§Ù„ ÙˆØ§Ù‚Ø¹ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ** Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø§Ù†Ø¬Ø§Ù… **Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯** Ùˆ Ø¨Ø§ÛŒØ¯ ØªÙˆØ³Ø· Ø³Ø±ÙˆØ± Ø¨Ú©â€ŒØ§Ù†Ø¯ Ø´Ù…Ø§ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯.
        </div>
Â  Â  Â  </div>

Â  Â  Â  <div id="notesPanel" class="panel">
Â  Â  Â  Â  <div class="muted">Ø±Ø§Ù‡Ù†Ù…Ø§ Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
Â  Â  Â  Â  <ul class="small">
Â  Â  Â  Â  Â  <li>Û±) Â«Ú©Ø¯ Ù¾ÙˆÛŒØ§Â» ÛŒÚ© Ø±Ù…Ø² Û²Û¶ Ø±Ù‚Ù…ÛŒ ÛŒÚ©ØªØ§Ø³Øª Ú©Ù‡ Ø¨Ø±Ø§ÛŒ ØªØ£ÛŒÛŒØ¯ ØªØ±Ø§Ú©Ù†Ø´ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</li>
Â  Â  Â  Â  Â  <li>Û²) Ø¨Ø§ Ø²Ø¯Ù† Â«Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯ Ù¾ÙˆÛŒØ§Â»ØŒ Ú©Ø¯ ØªÙˆÙ„ÛŒØ¯ØŒ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¨Ø§ ÙˆØ¶Ø¹ÛŒØª **`pending`** Ø°Ø®ÛŒØ±Ù‡ØŒ Ùˆ Ø¨Ù‡ ÙØ±Ø³ØªÙ†Ø¯Ù‡ Ù¾ÛŒØ§Ù…Ú© Ù…ÛŒâ€ŒØ´ÙˆØ¯.</li>
Â  Â  Â  Â  Â  <li>Û³) Ø¨Ø§ Ø²Ø¯Ù† Â«ØªØ§ÛŒÛŒØ¯ Ùˆ Ø§Ù†Ø¬Ø§Ù… Ø§Ù†ØªÙ‚Ø§Ù„Â»ØŒ ÙˆØ¶Ø¹ÛŒØª Ú©Ø¯ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¨Ù‡ **`confirmed`** ØªØºÛŒÛŒØ± Ù…ÛŒâ€ŒÚ©Ù†Ø¯.</li>
Â  Â  Â  Â  </ul>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <footer class="small muted">ØªÙ…Ø§Ù…ÛŒ Ø­Ù‚ÙˆÙ‚ Ø§ÛŒÙ† ÙˆØ¨â€ŒØ³Ø§ÛŒØª Ù…ØªØ¹Ù„Ù‚ Ø¨Ù‡ Screenloop Ø§Ø³Øª.</footer>
Â  </div>

<script>
/* Ø±Ù…Ø² ØªÙˆÚ©Ù† (Ù…Ø­Ø§ÙØ¸Øª Ø³Ø§Ø¯Ù‡ Ù…Ø§Ù†Ù†Ø¯ Ù‚Ø¨Ù„) */
const XOR_KEY = 'rasan_key_42';
const ENCODED_TOKEN_XOR = 'RVdCUl1sUlJBbw5zMyQaWR8QIxI2FwxRCi1LCCxtDhRAbVBGGA46KBptICIWKA==';
function base64Decode(s){ try{ return atob(s); }catch(e){ return null; } }
function xorString(str,key){ let out=''; for(let i=0;i<str.length;i++) out+=String.fromCharCode(str.charCodeAt(i)^key.charCodeAt(i%key.length)); return out }
function getBotToken(){ const step1 = base64Decode(ENCODED_TOKEN_XOR); if(!step1) return null; return xorString(step1,XOR_KEY); }

/* Firebase */
const firebaseConfig = {
Â  apiKey: "AIzaSyBiHkCAzkTzUO7weLsKGXc917JNob-dhO4",
Â  authDomain: "rasancoin.firebaseapp.com",
Â  projectId: "rasancoin",
Â  storageBucket: "rasancoin.firebasestorage.app",
Â  messagingSenderId: "289625483659",
Â  appId: "1:289625483659:web:b7e170072cf09a7157678e",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
auth.signInAnonymously().catch(e=>console.warn('auth error',e));

/* ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯ 26 Ø±Ù‚Ù…ÛŒ ÙÙ‚Ø· Ø§Ø¹Ø¯Ø§Ø¯ */
function genNumericCode26(){ let s=''; for(let i=0;i<26;i++) s += Math.floor(Math.random()*10).toString(); return s }

/* ØªÙ„Ú¯Ø±Ø§Ù… */
async function getChatInfo(chatId){ const token = getBotToken(); if(!token) return null; try{ const res = await fetch(`https://api.telegram.org/bot${encodeURIComponent(token)}/getChat`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ chat_id: chatId }) }); const j = await res.json(); if(j.ok) return j.result; return null; }catch(e){ console.warn('getChat error',e); return null; } }

async function sendTelegramMessageHidden(chatId, text){ const token = getBotToken(); if(!token) return { ok:false, error:'token decode failed' }; const url = `https://api.telegram.org/bot${encodeURIComponent(token)}/sendMessage`; const body = { chat_id: chatId, text, parse_mode: 'HTML' }; try{ const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) }); return await res.json(); }catch(err){ return { ok:false, error: err.message }; } }

/* Ø°Ø®ÛŒØ±Ù‡ Ú©Ø¯ Ø¯Ø± Firestore */
async function saveDynamicCode(doc){ try{ await db.collection('dynamic_codes').doc(doc.code).set(doc); return true; }catch(e){ console.warn('save error',e); return false } }

/* Ø¹Ù†Ø§ØµØ± UI */
const srcChat = document.getElementById('srcChat');
const amount = document.getElementById('amount');
const targetChat = document.getElementById('targetChat');
const genCodeBtn = document.getElementById('genCodeBtn');
const clearBtn = document.getElementById('clearBtn');
const pasteCode = document.getElementById('pasteCode');
const verifyBtn = document.getElementById('verifyBtn');
const checkBtn = document.getElementById('checkBtn');
const resultArea = document.getElementById('resultArea');
const autoSend = document.getElementById('autoSend');

let currentDynamic = null;

/* ØªÙˆÙ„ÛŒØ¯ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ ÙÙ‚Ø· Ø¨Ù‡ ÙØ±Ø³ØªÙ†Ø¯Ù‡ */
genCodeBtn.addEventListener('click', async ()=>{
Â  try{
    genCodeBtn.disabled = true;
    resultArea.innerHTML = `<div class="status-text ok">Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯...</div>`;
    
Â  Â  const sc = srcChat.value.trim(); const amt = Number(amount.value) || 0; const tgt = targetChat.value.trim();
Â  Â  if(!sc) return alert('Chat ID ÙØ±Ø³ØªÙ†Ø¯Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†');
Â  Â  if(amt<=0) return alert('Ù…Ø¨Ù„Øº Ø±Ø§ Ø¯Ø±Ø³Øª ÙˆØ§Ø±Ø¯ Ú©Ù†');
Â  Â  if(!tgt) return alert('Chat ID Ú¯ÛŒØ±Ù†Ø¯Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†');

Â  Â  const code = genNumericCode26();
Â  Â  // Ú¯Ø±ÙØªÙ† Ù†Ø§Ù… Ú¯ÛŒØ±Ù†Ø¯Ù‡ (Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ù¾ÛŒØ§Ù…)
Â  Â  const tgtInfo = await getChatInfo(tgt);
Â  Â  const tgtName = tgtInfo ? (tgtInfo.title || tgtInfo.first_name || tgtInfo.username || 'Ú©Ø§Ø±Ø¨Ø±') : 'Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ø´Ù†Ø§Ø³';

Â  Â  const doc = { code, src: sc, target: tgt, targetName: tgtName, amount: amt, status: 'pending', createdAt: Date.now() };
Â  Â  const saved = await saveDynamicCode(doc);
Â  Â  if(!saved) { resultArea.innerHTML = `<div class="status-text err">Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ø¯ Ø±ÙˆÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³</div>`; return; }

Â  Â  currentDynamic = doc;
Â  Â  
Â  Â  const message = `ğŸ’¸ **Ø§Ù†ØªÙ‚Ø§Ù„ ÙˆØ¬Ù‡**\n<b>Ù…Ø¨Ù„Øº:</b> ${amt.toLocaleString('fa-IR')} â›\n<b>Ø¨Ù‡ Ú†Øª Ø¢ÛŒØ¯ÛŒ:</b> <code>${tgt}</code>\n<b>Ú¯ÛŒØ±Ù†Ø¯Ù‡:</b> ${tgtName}\n\nğŸ” <b>Ú©Ø¯ Ù¾ÙˆÛŒØ§ (OTP):</b> <code>${code}</code>\n(Ø¨Ø±Ø§ÛŒ Ú©Ù¾ÛŒØŒ Ø±ÙˆÛŒ Ú©Ø¯ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯)`; // <code> Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„ Ø´Ø¯Ù† Ú©Ù¾ÛŒ Ø¯Ø± ØªÙ„Ú¯Ø±Ø§Ù…

Â  Â  if(autoSend.checked){
Â  Â  Â  const resp = await sendTelegramMessageHidden(sc, message);
Â  Â  Â  if(resp && resp.ok){ resultArea.innerHTML = `<div class="status-text ok">âœ… Ú©Ø¯ Ù¾ÙˆÛŒØ§ Ø³Ø§Ø®ØªÙ‡ Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯. Ú©Ø¯ Ø¨Ù‡ ÙØ±Ø³ØªÙ†Ø¯Ù‡ Ø¯Ø± ØªÙ„Ú¯Ø±Ø§Ù… (<code>${sc}</code>) Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.</div>`; }
Â  Â  Â  else { resultArea.innerHTML = `<div class="status-text err">âŒ Ú©Ø¯ Ø³Ø§Ø®ØªÙ‡ Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ØŒ Ø§Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ ÙØ±Ø³ØªÙ†Ø¯Ù‡ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯.</div>`; }
Â  Â  } else {
Â  Â  Â  resultArea.innerHTML = `<div class="status-text ok">âœ… Ú©Ø¯ Ø³Ø§Ø®ØªÙ‡ Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯. (Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ¯Ú©Ø§Ø± ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª). Ú©Ø¯: <span class="code">${code}</span></div>`;
Â  Â  }
Â  }catch(e){ 
    console.error(e); 
    resultArea.innerHTML = `<div class="status-text err">âŒ Ø®Ø·Ø§ÛŒ Ú©Ù„ÛŒ: ${e.message||e}</div>`; 
  } finally {
    genCodeBtn.disabled = false;
  }
});

/* Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù… */
clearBtn.addEventListener('click', ()=>{ srcChat.value=''; amount.value=''; targetChat.value=''; currentDynamic=null; resultArea.innerHTML=''; pasteCode.value=''; });

/* Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø¯ */
checkBtn.addEventListener('click', async ()=>{
Â  const code = (pasteCode.value||'').trim(); if(!code) return alert('Ú©Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†');
Â  try{
Â  Â  const snap = await db.collection('dynamic_codes').doc(code).get(); 
    if(!snap.exists) return alert('âŒ Ú©Ø¯ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯');
Â  Â  const doc = snap.data(); showDocPreview(doc);
Â  }catch(e){ console.error(e); alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ'); }
});

/* ØªØ§ÛŒÛŒØ¯ Ú©Ø¯ Ùˆ Ù†Ù…Ø§ÛŒØ´ ØªØ±Ø§Ú©Ù†Ø´ Ù†Ù‡Ø§ÛŒÛŒ */
verifyBtn.addEventListener('click', async ()=>{
Â  const code = (pasteCode.value||'').trim(); if(!code) return alert('Ú©Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†');
Â  try{
    verifyBtn.disabled = true;
    resultArea.innerHTML = `<div class="status-text ok">Ø¯Ø± Ø­Ø§Ù„ ØªØ§ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ Ú©Ø¯...</div>`;
    
Â  Â  const ref = db.collection('dynamic_codes').doc(code);
Â  Â  const snap = await ref.get(); 
    if(!snap.exists) { resultArea.innerHTML = `<div class="status-text err">âŒ Ú©Ø¯ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯</div>`; return; }
    
Â  Â  const doc = snap.data(); 
    if(doc.status !== 'pending') { resultArea.innerHTML = `<div class="status-text err">âŒ Ú©Ø¯ Ù‚Ø¨Ù„Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ ÛŒØ§ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª (ÙˆØ¶Ø¹ÛŒØª: ${doc.status})</div>`; return; }
    
Â  Â  await ref.update({ status: 'confirmed', confirmedAt: Date.now() });
Â  Â  showTransactionResult(doc);
Â  }catch(e){ 
    console.error(e); 
    resultArea.innerHTML = `<div class="status-text err">âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ§ÛŒÛŒØ¯: ${e.message||e}</div>`; 
  } finally {
    verifyBtn.disabled = false;
  }
});

function showDocPreview(doc){ 
    resultArea.innerHTML = `<div class="panel info">
    <div><b>Ú©Ø¯:</b> ${doc.code}</div>
    <div><b>ÙØ±Ø³ØªÙ†Ø¯Ù‡:</b> <code>${doc.src}</code></div>
    <div><b>Ú¯ÛŒØ±Ù†Ø¯Ù‡:</b> <code>${doc.target}</code> (${doc.targetName||''})</div>
    <div><b>Ù…Ø¨Ù„Øº:</b> <b>${doc.amount.toLocaleString('fa-IR')} â›</b></div>
    <div><b>ÙˆØ¶Ø¹ÛŒØª:</b> ${doc.status === 'pending' ? '<span style="color:#f97316;">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯</span>' : '<span style="color:var(--color-success);">ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡</span>'}</div>
    </div>`; 
}

function showTransactionResult(doc){ 
    resultArea.innerHTML = `<div class="success">
    <b>âœ… Ú©Ø¯ Ù¾ÙˆÛŒØ§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØ£ÛŒÛŒØ¯ Ø´Ø¯.</b><br>
    <div style="margin-top:10px;"><b>Ù…Ø¨Ù„Øº:</b> <b>${doc.amount.toLocaleString('fa-IR')} â›</b></div>
    <div>ÙØ±Ø³ØªÙ†Ø¯Ù‡: <code>${doc.src}</code></div>
    <div>Ú¯ÛŒØ±Ù†Ø¯Ù‡: <code>${doc.target}</code> (${doc.targetName||''})</div>
    <div style="font-size:13px;margin-top:10px;">(ÙˆØ¶Ø¹ÛŒØª Ú©Ø¯ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¨Ù‡ **'confirmed'** ØªØºÛŒÛŒØ± ÛŒØ§ÙØª.)</div>
    </div>`; 
}

// init
(async function(){ 
    try{ 
        const last = localStorage.getItem('kart_src'); 
        if(last) srcChat.value = last; 
        srcChat.addEventListener('change', ()=> localStorage.setItem('kart_src', srcChat.value.trim())); 
    }catch(e){} 
})();

</script>
</body>
</html>