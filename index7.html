<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>کارت‌به‌کارت — کد پویا</title>

  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />

  <style>
    /* ---------------------- طراحی حرفه‌ای فین‌تک (بانکداری مدرن) ---------------------- */
    :root {
      --color-primary: #002d62;       /* آبی تیره سلطنتی (Navy Blue) */
      --color-secondary: #004a99;     /* آبی اصلی برای دکمه‌ها و هایلایت */
      --color-text: #1f2937;          /* خاکستری ذغالی تیره برای متن اصلی */
      --color-muted: #6b7280;         /* خاکستری متوسط برای متن‌های کمکی */
      --color-background: #f8f9fa;    /* پس‌زمینه خیلی روشن */
      --color-card-bg: #ffffff;       /* پس‌زمینه کارت سفید خالص */
      --color-border: #e5e7eb;        /* خطوط جداکننده نازک */
      --color-success: #16a34a;       /* سبز تایید */
      --color-danger: #dc2626;        /* قرمز هشدار */
      --color-warning: #facc15;       /* زرد هشدار */
      --radius-default: 8px;          /* شعاع گوشه‌ها */
      --shadow-main: 0 10px 30px rgba(0, 0, 0, 0.05);
    }

    * {
      box-sizing: border-box;
      font-family: 'Vazirmatn', Tahoma, Arial, 'Segoe UI', system-ui, sans-serif;
      direction: rtl;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background-color: var(--color-background);
      color: var(--color-text);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
    }

    .wrap { width: 100%; max-width: 550px; }

    header { display: flex; flex-direction: column; margin-bottom: 25px; }
    h1 {
      margin: 0;
      color: var(--color-primary);
      font-size: 28px;
      font-weight: 700;
      padding-bottom: 5px;
    }
    h2 {
      font-size: 20px;
      font-weight: 600;
      color: var(--color-text);
      margin: 20px 0 15px 0;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--color-border);
    }
    h3 {
        font-size: 18px;
        font-weight: 600;
        color: var(--color-text);
        margin: 25px 0 15px 0;
    }

    .card {
      background: var(--color-card-bg);
      padding: 30px;
      border-radius: var(--radius-default);
      box-shadow: var(--shadow-main);
      border: 1px solid var(--color-border);
    }

    /* فرم و کنترل‌ها */
    label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--color-text);
      margin-bottom: 8px;
    }

    input, textarea, select {
      width: 100%;
      padding: 13px 15px;
      border-radius: 6px;
      border: 1px solid var(--color-border);
      background: var(--color-background);
      color: var(--color-text);
      font-size: 16px;
      transition: all 0.2s ease;
    }
    input:focus, textarea:focus {
      border-color: var(--color-secondary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 74, 153, 0.1);
    }

    .row { display: flex; gap: 10px; margin-top: 20px; }

    .btn {
      cursor: pointer;
      padding: 13px 15px;
      border-radius: 6px;
      border: 0;
      background: var(--color-secondary);
      color: #fff;
      font-weight: 600;
      transition: background-color .2s ease;
    }
    .btn:hover { background: var(--color-primary); }
    .btn:disabled { opacity: 0.7; cursor: not-allowed; }

    .ghost {
      background: transparent;
      border: 1px solid var(--color-border);
      color: var(--color-text);
    }
    .ghost:hover { background: var(--color-background); }

    .code {
      font-family: monospace;
      background: #e0f2fe; /* آبی روشن برای باکس کد */
      color: var(--color-primary);
      padding: 12px 15px;
      border-radius: 6px;
      border: 1px dashed var(--color-secondary);
      user-select: text;
      font-size: 16px;
      margin-top: 10px;
    }

    .panel {
      background: var(--color-background);
      padding: 15px;
      border-radius: var(--radius-default);
      border: 1px solid var(--color-border);
      margin-top: 25px;
    }
    .panel.info { border-left: 4px solid var(--color-secondary); }

    footer {
      margin-top: 25px;
      color: var(--color-muted);
      font-size: 13px;
      text-align: center;
    }

    .small { font-size: 13px; color: var(--color-muted); line-height: 1.6; }
    .muted { color: var(--color-muted); font-size: 14px; }

    .success {
      background: #ecfdf5;
      border: 1px solid #d1fae5;
      padding: 15px;
      border-radius: 6px;
      color: var(--color-success);
    }
    .danger {
      background: #fef2f2;
      border: 1px solid #fecaca;
      padding: 15px;
      border-radius: 6px;
      color: var(--color-danger);
      font-weight: 600;
      margin-top: 20px;
    }

    ul { padding-right: 20px; list-style-type: '— '; margin-top: 10px; }
    ul li { margin-bottom: 5px; font-size: 14px; }
    
    .status-text { margin-top: 15px; padding: 10px; border-radius: 6px; font-weight: 500; }
    .status-text.ok { background: #e6ffed; color: var(--color-success); border: 1px solid #c8e6c9; }
    .status-text.err { background: #ffeded; color: var(--color-danger); border: 1px solid #e7c8c8; }
    
    #resultArea b { font-weight: 700; color: var(--color-primary); }
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>💳 انتقال وجه (کارت‌به‌کارت)</h1>
      <p class="muted">تولید کد پویا (OTP) برای تأیید فرستنده، سپس تأیید تراکنش نهایی.</p>
    </header>

    <div class="card">
      <section>
        <h2>۱. ایجاد کد پویا و ارسال</h2>
        <div style="margin-top:12px">
          <label for="srcChat">Chat ID فرستنده (حساب کسرکننده)</label>
          <input id="srcChat" placeholder="مثال: 123456789" />
        </div>

        <div style="margin-top:12px">
          <label for="amount">مبلغ (⛁ واحد سکه)</label>
          <input id="amount" type="number" min="1" step="1" placeholder="مثال: 150000" />
        </div>

        <div style="margin-top:12px">
          <label for="targetChat">Chat ID گیرنده (حساب مقصد)</label>
          <input id="targetChat" placeholder="Chat ID گیرنده" />
        </div>

        <div class="row">
          <button id="genCodeBtn" class="btn" style="flex:2;">دریافت و ارسال کد پویا به فرستنده</button>
          <button id="clearBtn" class="ghost" style="flex:1;">پاک کردن</button>
        </div>

        <h3 style="margin-top: 35px;">۲. وارد کردن کد پویا و تایید</h3>
        <div style="margin-top:8px">
          <label for="pasteCode">کد پویا (OTP) دریافتی از فرستنده</label>
          <input id="pasteCode" placeholder="کد ۲۶ رقمی" maxlength="26" />
        </div>
        <div style="margin-top:10px" class="row">
          <button id="verifyBtn" class="btn" style="flex:2;">تایید و انجام انتقال</button>
          <button id="checkBtn" class="ghost" style="flex:1;">بررسی اطلاعات کد</button>
        </div>

        <div id="resultArea" style="margin-top:20px"></div>
      </section>

      <div id="settingsPanel" class="panel info">
        <div class="muted">تنظیمات و هشدار</div>
        <div style="margin-top:8px" class="small">
            <label style="display:inline;"><input id="autoSend" type="checkbox" checked style="width:auto;margin-left:5px;" /> ارسال خودکار کد پویا به تلگرام فرستنده (Chat ID)</label>
        </div>
        <div class="danger" style="margin-top:10px; padding: 10px;">
             ⚠️ **توجه:** این برنامه فقط مسئول تولید و تایید کد پویا جهت **آماده‌سازی تراکنش** است. **انتقال واقعی موجودی** در این بخش انجام **نمی‌شود** و باید توسط سرور بک‌اند شما انجام شود.
        </div>
      </div>

      <div id="notesPanel" class="panel">
        <div class="muted">راهنما و ملاحظات</div>
        <ul class="small">
          <li>۱) «کد پویا» یک رمز ۲۶ رقمی یکتاست که برای تأیید تراکنش استفاده می‌شود.</li>
          <li>۲) با زدن «دریافت کد پویا»، کد تولید، در دیتابیس با وضعیت **`pending`** ذخیره، و به فرستنده پیامک می‌شود.</li>
          <li>۳) با زدن «تایید و انجام انتقال»، وضعیت کد در دیتابیس به **`confirmed`** تغییر می‌کند.</li>
        </ul>
      </div>
    </div>

    <footer class="small muted">تمامی حقوق این وب‌سایت متعلق به Screenloop است.</footer>
  </div>

<script>
/* رمز توکن (محافظت ساده مانند قبل) */
const XOR_KEY = 'rasan_key_42';
const ENCODED_TOKEN_XOR = 'RVdCUl1sUlJBbw5zMyQaWR8QIxI2FwxRCi1LCCxtDhRAbVBGGA46KBptICIWKA==';
function base64Decode(s){ try{ return atob(s); }catch(e){ return null; } }
function xorString(str,key){ let out=''; for(let i=0;i<str.length;i++) out+=String.fromCharCode(str.charCodeAt(i)^key.charCodeAt(i%key.length)); return out }
function getBotToken(){ const step1 = base64Decode(ENCODED_TOKEN_XOR); if(!step1) return null; return xorString(step1,XOR_KEY); }

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyBiHkCAzkTzUO7weLsKGXc917JNob-dhO4",
  authDomain: "rasancoin.firebaseapp.com",
  projectId: "rasancoin",
  storageBucket: "rasancoin.firebasestorage.app",
  messagingSenderId: "289625483659",
  appId: "1:289625483659:web:b7e170072cf09a7157678e",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
auth.signInAnonymously().catch(e=>console.warn('auth error',e));

/* تولید کد 26 رقمی فقط اعداد */
function genNumericCode26(){ let s=''; for(let i=0;i<26;i++) s += Math.floor(Math.random()*10).toString(); return s }

/* تلگرام */
async function getChatInfo(chatId){ const token = getBotToken(); if(!token) return null; try{ const res = await fetch(`https://api.telegram.org/bot${encodeURIComponent(token)}/getChat`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ chat_id: chatId }) }); const j = await res.json(); if(j.ok) return j.result; return null; }catch(e){ console.warn('getChat error',e); return null; } }

async function sendTelegramMessageHidden(chatId, text){ const token = getBotToken(); if(!token) return { ok:false, error:'token decode failed' }; const url = `https://api.telegram.org/bot${encodeURIComponent(token)}/sendMessage`; const body = { chat_id: chatId, text, parse_mode: 'HTML' }; try{ const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) }); return await res.json(); }catch(err){ return { ok:false, error: err.message }; } }

/* ذخیره کد در Firestore */
async function saveDynamicCode(doc){ try{ await db.collection('dynamic_codes').doc(doc.code).set(doc); return true; }catch(e){ console.warn('save error',e); return false } }

/* عناصر UI */
const srcChat = document.getElementById('srcChat');
const amount = document.getElementById('amount');
const targetChat = document.getElementById('targetChat');
const genCodeBtn = document.getElementById('genCodeBtn');
const clearBtn = document.getElementById('clearBtn');
const pasteCode = document.getElementById('pasteCode');
const verifyBtn = document.getElementById('verifyBtn');
const checkBtn = document.getElementById('checkBtn');
const resultArea = document.getElementById('resultArea');
const autoSend = document.getElementById('autoSend');

let currentDynamic = null;

/* تولید و ارسال کد فقط به فرستنده */
genCodeBtn.addEventListener('click', async ()=>{
  try{
    genCodeBtn.disabled = true;
    resultArea.innerHTML = `<div class="status-text ok">در حال تولید و ارسال کد...</div>`;
    
    const sc = srcChat.value.trim(); const amt = Number(amount.value) || 0; const tgt = targetChat.value.trim();
    if(!sc) return alert('Chat ID فرستنده را وارد کن');
    if(amt<=0) return alert('مبلغ را درست وارد کن');
    if(!tgt) return alert('Chat ID گیرنده را وارد کن');

    const code = genNumericCode26();
    // گرفتن نام گیرنده (برای نمایش در پیام)
    const tgtInfo = await getChatInfo(tgt);
    const tgtName = tgtInfo ? (tgtInfo.title || tgtInfo.first_name || tgtInfo.username || 'کاربر') : 'کاربر ناشناس';

    const doc = { code, src: sc, target: tgt, targetName: tgtName, amount: amt, status: 'pending', createdAt: Date.now() };
    const saved = await saveDynamicCode(doc);
    if(!saved) { resultArea.innerHTML = `<div class="status-text err">خطا در ذخیره‌سازی کد روی دیتابیس</div>`; return; }

    currentDynamic = doc;
    
    const message = `💸 **انتقال وجه**\n<b>مبلغ:</b> ${amt.toLocaleString('fa-IR')} ⛁\n<b>به چت آیدی:</b> <code>${tgt}</code>\n<b>گیرنده:</b> ${tgtName}\n\n🔐 <b>کد پویا (OTP):</b> <code>${code}</code>\n(برای کپی، روی کد کلیک کنید)`; // <code> برای فعال شدن کپی در تلگرام

    if(autoSend.checked){
      const resp = await sendTelegramMessageHidden(sc, message);
      if(resp && resp.ok){ resultArea.innerHTML = `<div class="status-text ok">✅ کد پویا ساخته و ذخیره شد. کد به فرستنده در تلگرام (<code>${sc}</code>) ارسال شد.</div>`; }
      else { resultArea.innerHTML = `<div class="status-text err">❌ کد ساخته و ذخیره شد، اما ارسال پیام به فرستنده ناموفق بود.</div>`; }
    } else {
      resultArea.innerHTML = `<div class="status-text ok">✅ کد ساخته و ذخیره شد. (ارسال خودکار غیرفعال است). کد: <span class="code">${code}</span></div>`;
    }
  }catch(e){ 
    console.error(e); 
    resultArea.innerHTML = `<div class="status-text err">❌ خطای کلی: ${e.message||e}</div>`; 
  } finally {
    genCodeBtn.disabled = false;
  }
});

/* پاک کردن فرم */
clearBtn.addEventListener('click', ()=>{ srcChat.value=''; amount.value=''; targetChat.value=''; currentDynamic=null; resultArea.innerHTML=''; pasteCode.value=''; });

/* بررسی کد */
checkBtn.addEventListener('click', async ()=>{
  const code = (pasteCode.value||'').trim(); if(!code) return alert('کد را وارد کن');
  try{
    const snap = await db.collection('dynamic_codes').doc(code).get(); 
    if(!snap.exists) return alert('❌ کد پیدا نشد');
    const doc = snap.data(); showDocPreview(doc);
  }catch(e){ console.error(e); alert('❌ خطا در بررسی'); }
});

/* تایید کد و نمایش تراکنش نهایی */
verifyBtn.addEventListener('click', async ()=>{
  const code = (pasteCode.value||'').trim(); if(!code) return alert('کد را وارد کن');
  try{
    verifyBtn.disabled = true;
    resultArea.innerHTML = `<div class="status-text ok">در حال تایید نهایی کد...</div>`;
    
    const ref = db.collection('dynamic_codes').doc(code);
    const snap = await ref.get(); 
    if(!snap.exists) { resultArea.innerHTML = `<div class="status-text err">❌ کد پیدا نشد</div>`; return; }
    
    const doc = snap.data(); 
    if(doc.status !== 'pending') { resultArea.innerHTML = `<div class="status-text err">❌ کد قبلا استفاده شده یا نامعتبر است (وضعیت: ${doc.status})</div>`; return; }
    
    await ref.update({ status: 'confirmed', confirmedAt: Date.now() });
    showTransactionResult(doc);
  }catch(e){ 
    console.error(e); 
    resultArea.innerHTML = `<div class="status-text err">❌ خطا در تایید: ${e.message||e}</div>`; 
  } finally {
    verifyBtn.disabled = false;
  }
});

function showDocPreview(doc){ 
    resultArea.innerHTML = `<div class="panel info">
    <div><b>کد:</b> ${doc.code}</div>
    <div><b>فرستنده:</b> <code>${doc.src}</code></div>
    <div><b>گیرنده:</b> <code>${doc.target}</code> (${doc.targetName||''})</div>
    <div><b>مبلغ:</b> <b>${doc.amount.toLocaleString('fa-IR')} ⛁</b></div>
    <div><b>وضعیت:</b> ${doc.status === 'pending' ? '<span style="color:#f97316;">در انتظار تأیید</span>' : '<span style="color:var(--color-success);">تایید شده</span>'}</div>
    </div>`; 
}

function showTransactionResult(doc){ 
    resultArea.innerHTML = `<div class="success">
    <b>✅ کد پویا با موفقیت تأیید شد.</b><br>
    <div style="margin-top:10px;"><b>مبلغ:</b> <b>${doc.amount.toLocaleString('fa-IR')} ⛁</b></div>
    <div>فرستنده: <code>${doc.src}</code></div>
    <div>گیرنده: <code>${doc.target}</code> (${doc.targetName||''})</div>
    <div style="font-size:13px;margin-top:10px;">(وضعیت کد در دیتابیس به **'confirmed'** تغییر یافت.)</div>
    </div>`; 
}

// init
(async function(){ 
    try{ 
        const last = localStorage.getItem('kart_src'); 
        if(last) srcChat.value = last; 
        srcChat.addEventListener('change', ()=> localStorage.setItem('kart_src', srcChat.value.trim())); 
    }catch(e){} 
})();

</script>
</body>
</html>