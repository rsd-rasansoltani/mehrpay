<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mahr COIN | Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ø±Ø§ÛŒÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„</title>
  
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />

  <style>
  /* ---------------------- Ø·Ø±Ø§Ø­ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ ÙÛŒÙ†â€ŒØªÚ© (Ø¨Ø§Ù†Ú©Ø¯Ø§Ø±ÛŒ Ù…Ø¯Ø±Ù†) ---------------------- */
  :root {
    --color-primary: #002d62;       /* Ø¢Ø¨ÛŒ ØªÛŒØ±Ù‡ Ø³Ù„Ø·Ù†ØªÛŒ (Navy Blue) */
    --color-secondary: #004a99;     /* Ø¢Ø¨ÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ùˆ Ù‡Ø§ÛŒÙ„Ø§ÛŒØª */
    --color-text: #1f2937;          /* Ø®Ø§Ú©Ø³ØªØ±ÛŒ Ø°ØºØ§Ù„ÛŒ ØªÛŒØ±Ù‡ Ø¨Ø±Ø§ÛŒ Ù…ØªÙ† Ø§ØµÙ„ÛŒ */
    --color-muted: #6b7280;         /* Ø®Ø§Ú©Ø³ØªØ±ÛŒ Ù…ØªÙˆØ³Ø· Ø¨Ø±Ø§ÛŒ Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ */
    --color-background: #f8f9fa;    /* Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø®ÛŒÙ„ÛŒ Ø±ÙˆØ´Ù† */
    --color-card-bg: #ffffff;       /* Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ú©Ø§Ø±Øª Ø³ÙÛŒØ¯ Ø®Ø§Ù„Øµ */
    --color-border: #e5e7eb;        /* Ø®Ø·ÙˆØ· Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ Ù†Ø§Ø²Ú© */
    --color-success: #16a34a;       /* Ø³Ø¨Ø² ØªØ§ÛŒÛŒØ¯ */
    --color-danger: #dc2626;        /* Ù‚Ø±Ù…Ø² Ù‡Ø´Ø¯Ø§Ø± */
    --radius-default: 8px;          /* Ø´Ø¹Ø§Ø¹ Ú¯ÙˆØ´Ù‡â€ŒÙ‡Ø§ */
    color-scheme: light;
  }

  * {
    box-sizing: border-box;
    font-family: 'Vazirmatn', Tahoma, Arial, 'Segoe UI', system-ui, sans-serif;
  }

  body {
    margin: 0;
    min-height: 100vh;
    background-color: var(--color-background);
    color: var(--color-text);
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding: 50px 24px;
    line-height: 1.6;
    direction: rtl; /* Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø±Ø§Ø³Øª Ø¨Ù‡ Ú†Ù¾ */
  }

  .wrap {
    width: 100%;
    max-width: 1150px;
  }

  header {
    margin-bottom: 30px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--color-border);
  }

  h1 {
    font-size: 28px;
    margin: 0;
    color: var(--color-primary);
    font-weight: 700;
  }
  
  header .sub-header {
      color: var(--color-muted);
      font-size: 15px;
      margin-top: 5px;
  }

  h2 {
    font-size: 20px;
    font-weight: 600;
    color: var(--color-text);
    margin: 0 0 20px 0;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--color-border);
  }

  .card {
    background: var(--color-card-bg);
    padding: 25px;
    border-radius: var(--radius-default);
    border: 1px solid var(--color-border);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05); /* Ø³Ø§ÛŒÙ‡ Ø¹Ù…ÛŒÙ‚â€ŒØªØ± Ùˆ Ù„ÙˆÚ©Ø³ */
  }

  .grid {
    display: grid;
    grid-template-columns: 2fr 400px; 
    gap: 30px;
  }

  label {
    display: block;
    font-size: 14px;
    color: var(--color-text);
    font-weight: 500;
    margin-bottom: 8px;
  }

  input,
  button,
  textarea,
  select {
    width: 100%;
    padding: 13px 15px; /* Ø§Ø±ØªÙØ§Ø¹ Ùˆ Ù¾Ø¯ÛŒÙ†Ú¯ Ø¨ÛŒØ´ØªØ± */
    border-radius: 6px;
    border: 1px solid var(--color-border);
    background: var(--color-card-bg);
    color: inherit;
    font-size: 16px;
    transition: all 0.2s ease;
  }

  input:focus, textarea:focus {
    border-color: var(--color-secondary);
    outline: none;
    box-shadow: 0 0 0 3px rgba(0, 74, 153, 0.1); /* Ø­Ù„Ù‚Ù‡ ØªÙ…Ø±Ú©Ø² Ø¸Ø±ÛŒÙ Ø¢Ø¨ÛŒ */
  }

  .muted {
    color: var(--color-muted);
    font-size: 14px;
  }

  .right {
    display: flex;
    flex-direction: column;
    gap: 30px;
  }
  
  /* Ø¨Ø®Ø´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ - Ø¨Ø±Ø¬Ø³ØªÙ‡â€ŒØªØ± */
  .balance-section {
      text-align: center;
      padding: 30px 20px;
      background: var(--color-primary);
      color: white;
      border-radius: var(--radius-default);
      box-shadow: 0 4px 15px rgba(0, 45, 98, 0.3);
  }

  .balance-section .muted {
      color: rgba(255, 255, 255, 0.8);
      font-weight: 300;
      font-size: 15px;
      margin-bottom: 10px;
  }

  .balance {
    font-size: 44px;
    font-weight: 700;
    color: #ffffff;
    letter-spacing: 0;
    margin-top: 5px;
    font-family: Arial, sans-serif; /* Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ù‡ØªØ± Ø§Ø¹Ø¯Ø§Ø¯ Ù„Ø§ØªÛŒÙ† */
  }

  .small {
    font-size: 13px;
    color: var(--color-muted);
  }

  .row {
    display: flex;
    gap: 15px;
  }

  /* Ø¯Ú©Ù…Ù‡ Ø§ØµÙ„ÛŒ */
  .btn-primary {
    cursor: pointer;
    padding: 13px 20px;
    border-radius: 6px;
    border: 0;
    background: var(--color-secondary);
    color: #ffffff;
    font-weight: 600;
    transition: background-color 0.2s;
  }

  .btn-primary:hover {
    background: var(--color-primary);
  }
  
  /* Ø¯Ú©Ù…Ù‡ Ø«Ø§Ù†ÙˆÛŒÙ‡ (Ghost) */
  .btn-secondary {
    cursor: pointer;
    padding: 13px 20px;
    border-radius: 6px;
    border: 1px solid var(--color-border);
    background: transparent;
    color: var(--color-text);
    font-weight: 500;
    transition: background-color 0.2s;
  }
  
  .btn-secondary:hover {
      background: var(--color-background);
  }

  footer {
    margin-top: 40px;
    color: var(--color-muted);
    font-size: 13px;
    text-align: center;
    padding-top: 20px;
    border-top: 1px solid var(--color-border);
  }

  .alert-success {
    background: #ecfdf5;
    padding: 15px;
    border-radius: 6px;
    color: var(--color-success);
    border: 1px solid #d1fae5;
  }

  .alert-danger {
    background: #fef2f2;
    color: var(--color-danger);
    padding: 15px;
    border-radius: 6px;
    border: 1px solid #fecaca;
    font-weight: 500;
  }
  
  .controls-row {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 10px;
      margin-top: 15px;
  }

  @media (max-width: 992px) {
    .grid {
      grid-template-columns: 1fr;
    }
    .right {
      order: -1;
    }
  }
</style>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ğŸ’° Mahr COIN | Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ø±Ø§ÛŒÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„</h1>
      <div class="sub-header">Ø³ÛŒØ³ØªÙ… Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª SRLP64 | Ø®Ø±ÙˆØ¬ÛŒâ€ŒÙ‡Ø§ÛŒ ÛŒÚ©â€ŒØ¨Ø§Ø± Ù…ØµØ±Ù Ø¨Ø±Ø§ÛŒ Ø§Ù…Ù†ÛŒØª Ø­Ø¯Ø§Ú©Ø«Ø±ÛŒ</div>
    </header>

    <div class="grid">
      <section class="card">
        <h2>ğŸ”‘ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ùˆ ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨</h2>
        
        <div style="margin-top:20px">
          <label for="chatIdInput">Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ ØªÙ„Ú¯Ø±Ø§Ù… (Chat ID)</label>
          <input id="chatIdInput" placeholder="Ø´Ù†Ø§Ø³Ù‡ Ø¹Ø¯Ø¯ÛŒ Ù…Ù†Ø­ØµØ±Ø¨Ù‡â€ŒÙØ±Ø¯ Ú©Ù‡ Ø§Ø² Ø±Ø¨Ø§Øª Ø¯Ø±ÛŒØ§ÙØª Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯" />
        </div>

        <div class="row" style="margin-top:15px">
          <button id="startBtn" class="btn-primary">Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯ Ø§Ù…Ù†ÛŒØªÛŒ</button>
          <button id="loginBtn" class="btn-secondary">ØªØ£ÛŒÛŒØ¯ Ú©Ø¯ Ùˆ ÙˆØ±ÙˆØ¯</button>
        </div>

        <div style="margin-top:20px">
          <label for="codeInput">Ú©Ø¯ ØªØ£ÛŒÛŒØ¯ Ûµ Ø±Ù‚Ù…ÛŒ</label>
          <input id="codeInput" placeholder="Ú©Ø¯ Ø§Ø±Ø³Ø§Ù„ÛŒ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù… Ø´Ù…Ø§" />
        </div>
        
        <hr style="margin:30px 0; border:0; border-top:1px dashed var(--color-border);" />

        <h2>ğŸš€ Ø§Ù†ØªÙ‚Ø§Ù„ Ùˆ ØµØ¯ÙˆØ± Ø¯Ø§Ø±Ø§ÛŒÛŒ (ØªÙˆÚ©Ù† ÛŒÚ©â€ŒØ¨Ø§Ø±Ù…ØµØ±Ù)</h2>
        <p class="muted small">Ø§ÛŒÙ† Ø±ÙˆØ´ Ø§Ù…Ù†â€ŒØªØ±ÛŒÙ† Ø±Ø§Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ø³Øª. ØªÙˆÚ©Ù† ØªÙˆÙ„ÛŒØ¯ÛŒ Ø±Ø§ Ø¨Ù‡ Ú¯ÛŒØ±Ù†Ø¯Ù‡ Ø¨Ø¯Ù‡ÛŒØ¯ ØªØ§ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ø§Ùˆ ÙˆØ§Ø±ÛŒØ² Ø´ÙˆØ¯.</p>
        
        <div style="margin-top:15px">
          <label for="transferAmount">Ù…Ù‚Ø¯Ø§Ø± Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªÙ‚Ø§Ù„ (Ø³Ú©Ù‡ â›)</label>
          <input id="transferAmount" type="number" min="0" step="1" placeholder="Ù…Ø«Ø§Ù„: ÛµÛ°Û° Ø³Ú©Ù‡" />
        </div>

        <div style="margin-top:15px">
          <label for="exportArea">ØªÙˆÚ©Ù† Ø®Ø±ÙˆØ¬ÛŒ</label>
          <textarea id="exportArea" style="height:90px;" placeholder="ØªÙˆÚ©Ù† SRLP64:E:... Ø§ÛŒÙ†Ø¬Ø§ ØªÙˆÙ„ÛŒØ¯ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯"></textarea>
          <div class="controls-row">
            <button id="exportTokenBtn" class="btn-secondary">Ø³Ø§Ø®Øª ØªÙˆÚ©Ù† ÛŒÚ©â€ŒØ¨Ø§Ø±Ù…ØµØ±Ù</button>
          </div>
        </div>

        <hr style="margin:30px 0; border:0; border-top:1px dashed var(--color-border);" />

        <h2>â¬‡ï¸ Ø¯Ø±ÙˆÙ†â€ŒØ±ÛŒØ²ÛŒ Ùˆ ÙˆØ§Ø±ÛŒØ² (Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªÙˆÚ©Ù†)</h2>
        <p class="muted small">ØªÙˆÚ©Ù†ÛŒ Ú©Ù‡ Ø§Ø² ÙØ±Ø³ØªÙ†Ø¯Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯ Ø±Ø§ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯ ØªØ§ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆØ¯.</p>
        
        <div style="margin-top:15px">
          <label for="importArea">ØªÙˆÚ©Ù† SRLP64 Ø¯Ø±ÛŒØ§ÙØªÛŒ</label>
          <textarea id="importArea" style="height:90px;" placeholder="ØªÙˆÚ©Ù† (Ù…Ø«Ù„Ø§Ù‹ SRLP64:E:...) ÛŒØ§ Base64 Ù‚Ø¯ÛŒÙ…ÛŒ Ø±Ø§ Ø¨Ú†Ø³Ø¨Ø§Ù†ÛŒØ¯"></textarea>
          <div class="controls-row">
            <button id="importBase64" class="btn-primary">ØªØ£ÛŒÛŒØ¯ Ùˆ Ø¯Ø±ÙˆÙ†â€ŒØ±ÛŒØ²ÛŒ</button>
          </div>
        </div>
        
        <div style="margin-top:30px" class="alert-danger">
         âš ï¸ **Ù‡Ø´Ø¯Ø§Ø± Ø§Ù…Ù†ÛŒØªÛŒ:** Ù‡Ø± Ú¯ÙˆÙ†Ù‡ Ø§Ù‚Ø¯Ø§Ù… Ù…Ø®Ø±Ø¨ ÛŒØ§ Ø³Ùˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¯Ø§Ø±Ø§ÛŒÛŒâ€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ Ù¾ÛŒÚ¯Ø±Ø¯ Ù‚Ø§Ù†ÙˆÙ†ÛŒ Ø¬Ø¯ÛŒ Ø®ÙˆØ§Ù‡Ø¯ Ø¯Ø§Ø´Øª.
        </div>

      </section>

      <aside class="right">
        
        <div class="card balance-section">
          <div class="muted">Ù…ÙˆØ¬ÙˆØ¯ÛŒ ÙØ¹Ù„ÛŒ Ø´Ù…Ø§ (â›)</div>
          <div class="balance" id="currentBalance">â€”</div>
          <div class="muted small" style="margin-top:15px;">
              Ø´Ù†Ø§Ø³Ù‡ Ø­Ø³Ø§Ø¨: <strong id="currentChatIdDisplay">â€”</strong>
          </div>
          <div class="muted small">
              Ø¢Ø®Ø±ÛŒÙ† Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: <strong id="lastUpdateDisplay">â€”</strong>
          </div>
          
          <div class="row" style="margin-top:20px">
              <button id="collectBtn" class="btn-secondary" style="background: rgba(255,255,255,0.1); color: white; border-color: rgba(255,255,255,0.2);">Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ</button>
              <button id="logoutBtn" class="btn-secondary" style="background: rgba(255,255,255,0.1); color: white; border-color: rgba(255,255,255,0.2);">Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨</button>
          </div>
        </div>
        
        <div class="card">
            <h2>âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø³Ø§Ø¨</h2>
            <div class="muted small" style="margin-bottom: 10px;">
                Ù†Ø±Ø® ØªÙˆÙ„ÛŒØ¯ Ø³Ú©Ù‡: **<strong style="color:var(--color-primary); font-size:14px;">10 Ø³Ú©Ù‡ / Ø³Ø§Ø¹Øª</strong>**
            </div>
            <div class="muted small">
                Ø³Ø±ÙˆÛŒØ³â€ŒØ¯Ù‡Ù†Ø¯Ù‡: **<strong style="color:var(--color-primary); font-size:14px;">screenloop.ir</strong>**
            </div>
            <div style="margin-top:15px"><label class="muted small" style="display:flex; align-items:center;"><input id="autoSend" type="checkbox" checked style="width: auto; margin-left: 10px;" /> Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ ØªØ£ÛŒÛŒØ¯ Ø¨Ø§ Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù…</label></div>
        </div>

        <div class="card">
            <h2>ğŸ“˜ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø³Ø±ÛŒØ¹</h2>
            <ul style="padding-right: 20px; list-style-type: disc; margin-top: 10px;" class="muted small">
                <li>Chat ID Ø±Ø§ ÙˆØ§Ø±Ø¯ Ùˆ Â«Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯ Ø§Ù…Ù†ÛŒØªÛŒÂ» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.</li>
                <li>Ú©Ø¯ Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ùˆ Â«ØªØ£ÛŒÛŒØ¯ Ú©Ø¯ Ùˆ ÙˆØ±ÙˆØ¯Â» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.</li>
                <li>Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªÙ‚Ø§Ù„ØŒ Ù…Ù‚Ø¯Ø§Ø± Ø±Ø§ Ù…Ø´Ø®Øµ Ùˆ ØªÙˆÚ©Ù† Ø±Ø§ ØªÙˆÙ„ÛŒØ¯ Ú©Ù†ÛŒØ¯.</li>
                <li>ØªÙˆÚ©Ù† Ø±Ø§ Ø¨Ù‡ Ú¯ÛŒØ±Ù†Ø¯Ù‡ Ø¨Ø¯Ù‡ÛŒØ¯ ØªØ§ Ø¯Ø± Ù‚Ø³Ù…Øª Ø¯Ø±ÙˆÙ†â€ŒØ±ÛŒØ²ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†Ø¯.</li>
                <li>Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¯Ù‚ÛŒÙ‚ØŒ Â«Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒÂ» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.</li>
            </ul>
        </div>

      </aside>
    </div>

    <footer>
        ØªÙ…Ø§Ù…ÛŒ Ø­Ù‚ÙˆÙ‚ Ø§ÛŒÙ† Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…ØªØ¹Ù„Ù‚ Ø¨Ù‡ Ø´Ø±Ú©Øª Ø§Ø³Ú©Ø±ÛŒÙ† Ù„ÙˆÙ¾ Ø§Ø³Øª (Screenloop Corporation). Â© Û±Û´Û°Û²
    </footer>
  </div>

<script>
/* ------------------ (Ú©Ø¯Ù‡Ø§ÛŒ Firebase Ùˆ Ù…Ù†Ø·Ù‚ JS Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ù†Ø¯) ------------------ */

const XOR_KEY = 'rasan_key_42';
const ENCODED_TOKEN_XOR = 'RVdCUl1sUlJBbw5zMyQaWR8QIxI2FwxRCi1LCCxtDhRAbVBGGA46KBptICIWKA==';

function base64Decode(s){ try{ return atob(s); }catch(e){ return null; } }
function xorString(str, key){
  let out = '';
  for(let i=0;i<str.length;i++){ out += String.fromCharCode(str.charCodeAt(i) ^ key.charCodeAt(i % key.length)); }
  return out;
}

function getBotToken(){
  const step1 = base64Decode(ENCODED_TOKEN_XOR);
  if(!step1) return null;
  const token = xorString(step1, XOR_KEY);
  return token;
}

/* ------------------ ØªÙ†Ø¸ÛŒÙ… Firebase ------------------ */
const firebaseConfig = {
  apiKey: "AIzaSyBiHkCAzkTzUO7weLsKGXc917JNob-dhO4",
  authDomain: "rasancoin.firebaseapp.com",
  projectId: "rasancoin",
  storageBucket: "rasancoin.firebasestorage.app",
  messagingSenderId: "289625483659",
  appId: "1:289625483659:web:b7e170072cf09a7157678e",
  measurementId: "G-KNNM4FF9MS"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

auth.signInAnonymously().catch(e => console.warn('auth error', e));

/* ------------------ Ù…Ù†Ø·Ù‚ NatCoin Ø¨Ø§ Firestore ------------------ */
const RATE_PER_HOUR = 10;

async function getUser(chatId){
  const doc = await db.collection('users').doc(chatId).get();
  return doc.exists ? doc.data() : null;
}
async function setUser(chatId, userObj){
  await db.collection('users').doc(chatId).set(userObj, { merge: true });
}

function genCode(){ return Math.floor(10000 + Math.random()*90000).toString() }
function formatDate(ts){ if(!ts) return 'â€”'; const d = new Date(ts); return d.toLocaleString('fa-IR', { hour: '2-digit', minute: '2-digit', year: 'numeric', month: 'numeric', day: 'numeric' }); }
function accrueFor(user){
  const now = Date.now();
  if(!user.lastUpdated){ user.lastUpdated = now; return; }
  const elapsed = now - user.lastUpdated;
  const coins = elapsed / 3600000 * RATE_PER_HOUR;
  user.balance = (user.balance||0) + coins;
  user.lastUpdated = now;
}

/* ------------------ Export as one-time token ------------------ */
async function createExport(payload){
  const docRef = db.collection('exports').doc();
  const docData = { payload, used: false, created: Date.now() };
  await docRef.set(docData);
  return docRef.id;
}

async function claimExportOnce(exportId){
  const docRef = db.collection('exports').doc(exportId);
  return await db.runTransaction(async (tx) => {
    const snap = await tx.get(docRef);
    if(!snap.exists) throw 'export not found';
    const data = snap.data();
    if(data.used) throw 'export already used';
    tx.update(docRef, { used: true, claimedAt: Date.now() });
    return data.payload;
  });
}

/* ------------------ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… ØªÙ„Ú¯Ø±Ø§Ù… ------------------ */
async function sendTelegramMessageHidden(chatId, text){
  const token = getBotToken();
  if(!token) return { ok:false, error:'token decode failed' };
  const url = `https://api.telegram.org/bot${encodeURIComponent(token)}/sendMessage`;
  try{
    const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ chat_id: chatId, text }) });
    const data = await res.json();
    return data;
  }catch(err){ return { ok:false, error:err.message } }
}

/* ------------------ Export logic ------------------ */
async function exportAccountOneTime(chatId, transferAmount = 0){
  const u = await getUser(chatId);
  if(!u) throw 'Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.';
  const amount = Number(transferAmount) || 0;
  if(amount < 0) throw 'Ù…Ù‚Ø¯Ø§Ø± Ø§Ù†ØªÙ‚Ø§Ù„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.';
  if(amount > 0){
    if((u.balance||0) < amount) throw 'Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª.';
    u.balance = (u.balance||0) - amount;
    u.lastUpdated = Date.now();
    await setUser(chatId, u);
  }
  const transfer = amount>0 ? { amount: amount, from: chatId, ts: Date.now(), id: (Date.now().toString(36) + Math.random().toString(36).slice(2,8)) } : null;
  const payload = { chatId, account: u, transfer };
  const eid = await createExport(payload);
  return `SRLP64:E:${eid}`;
}

/* ------------------ Import logic ------------------ */
async function importAccountFromInput(input){
  input = (input||'').trim();
  if(!input) throw 'ÙˆØ±ÙˆØ¯ÛŒ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.';
  
  // 1. New Token Form
  if(input.startsWith('SRLP64:E:')){
    const eid = input.slice('SRLP64:E:'.length);
    const payload = await claimExportOnce(eid);
    
    // Update source account
    await setUser(payload.chatId, payload.account);
    
    // Handle transfer to target
    if(payload.transfer && payload.transfer.amount){
      let target = currentChatId;
      if(!target || target === payload.chatId){
        target = prompt('Ù„Ø·ÙØ§Ù‹ Chat ID Ù…Ù‚ØµØ¯ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø¨Ù„Øº ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Chat ID):', '');
        if(!target) throw 'Chat ID Ù…Ù‚ØµØ¯ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯.';
      }
      let tuser = await getUser(target);
      if(!tuser) tuser = { balance:0, lastUpdated: Date.now() };
      tuser.balance = (tuser.balance||0) + Number(payload.transfer.amount);
      tuser.lastUpdated = Date.now();
      await setUser(target, tuser);
      return target;
    }
    return payload.chatId;
    
  } else {
    // 2. Legacy Base64 JSON
    const raw = base64Decode(input);
    if(!raw) throw 'ÙØ±Ù…Øª Base64 Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.';
    
    const obj = JSON.parse(raw);
    await setUser(obj.chatId, obj.account);
    
    if(obj.transfer && obj.transfer.amount){
      let target = currentChatId;
      if(!target || target === obj.chatId){
        target = prompt('Ù„Ø·ÙØ§Ù‹ Chat ID Ù…Ù‚ØµØ¯ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø¨Ù„Øº ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Chat ID):', '');
        if(!target) throw 'Chat ID Ù…Ù‚ØµØ¯ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯.';
      }
      let tuser = await getUser(target);
      if(!tuser) tuser = { balance:0, lastUpdated: Date.now() };
      tuser.balance = (tuser.balance||0) + Number(obj.transfer.amount);
      tuser.lastUpdated = Date.now();
      await setUser(target, tuser);
      return target;
    }
    return obj.chatId;
  }
}

/* ------------------ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ Ùˆ ØªÙˆØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ ------------------ */
const chatIdInput = document.getElementById('chatIdInput');
const codeInput = document.getElementById('codeInput');
const startBtn = document.getElementById('startBtn');
const loginBtn = document.getElementById('loginBtn');
const collectBtn = document.getElementById('collectBtn');
const logoutBtn = document.getElementById('logoutBtn');
const exportTokenBtn = document.getElementById('exportTokenBtn');
const exportArea = document.getElementById('exportArea');
const importArea = document.getElementById('importArea');
const importBase64Btn = document.getElementById('importBase64');
const transferAmountInput = document.getElementById('transferAmount');

let currentChatId = null;

async function renderAccount(chatId){
  const balanceDisplay = document.getElementById('currentBalance');
  const updateDisplay = document.getElementById('lastUpdateDisplay');
  const idDisplay = document.getElementById('currentChatIdDisplay');
  
  if(!chatId){ 
    balanceDisplay.textContent = 'â€”'; 
    updateDisplay.textContent = 'â€”'; 
    idDisplay.textContent = 'â€”'; 
    return; 
  }
  
  const u = await getUser(chatId);
  if(!u){ 
    balanceDisplay.textContent = 'Û°'; 
    updateDisplay.textContent = 'â€”'; 
    idDisplay.textContent = chatId;
    return; 
  }
  
  accrueFor(u);
  await setUser(chatId, u);
  
  balanceDisplay.textContent = Math.floor(u.balance).toLocaleString('fa-IR') + ' â›';
  updateDisplay.textContent = formatDate(u.lastUpdated);
  idDisplay.textContent = chatId;
}

/* UI handlers */
startBtn.addEventListener('click', async ()=>{
  const chatId = chatIdInput.value.trim(); 
  if(!chatId) return alert('Ø®Ø·Ø§: Ù„Ø·ÙØ§Ù‹ Chat ID Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
  
  const code = genCode();
  await db.collection('codes').doc(chatId).set({ code, created: Date.now() });
  
  if(document.getElementById('autoSend').checked){
    const text = `Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ ${code} Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ù†Ù„ Mahr COIN\n(Ú©Ø¯ ÙÙ‚Ø· ÛŒÚ©â€ŒØ¨Ø§Ø± Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª)`;
    const resp = await sendTelegramMessageHidden(chatId, text);
    if(resp && resp.ok) alert('âœ… Ú©Ø¯ Ø§Ù…Ù†ÛŒØªÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù… Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.'); 
    else { console.error(resp); alert('âŒ Ø®Ø·Ø§: Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ Ù…ÙˆÙÙ‚ Ù†Ø¨ÙˆØ¯. Ù„Ø·ÙØ§Ù‹ Chat ID Ø±Ø§ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ú†Ú© Ú©Ù†ÛŒØ¯.'); }
  } else alert(`âœ… Ú©Ø¯ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯: ${code} (Ø§Ø±Ø³Ø§Ù„ Ø±Ø¨Ø§Øª ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª)`);
});

loginBtn.addEventListener('click', async ()=>{
  const chatId = chatIdInput.value.trim(); 
  const code = codeInput.value.trim(); 
  if(!chatId||!code) return alert('Ø®Ø·Ø§: Ù‡Ø± Ø¯Ùˆ ÙÛŒÙ„Ø¯ Chat ID Ùˆ Ú©Ø¯ ØªØ£ÛŒÛŒØ¯ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.');
  
  try {
    const snap = await db.collection('codes').doc(chatId).get();
    if(!snap.exists) return alert('Ø®Ø·Ø§: Ø§Ø¨ØªØ¯Ø§ Â«Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯ Ø§Ù…Ù†ÛŒØªÛŒÂ» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.');
    const e = snap.data();
    if(e.code !== code) return alert('Ø®Ø·Ø§: Ú©Ø¯ ØªØ£ÛŒÛŒØ¯ Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª.');
    
    let u = await getUser(chatId);
    if(!u) u = { balance:0, lastUpdated: Date.now() };
    u.lastUpdated = u.lastUpdated || Date.now();
    await setUser(chatId, u);
    await db.collection('codes').doc(chatId).delete();
    
    currentChatId = chatId; 
    localStorage.setItem('natcoin_last_chat', chatId); 
    alert('âœ… ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ². Ø¨Ù‡ Ù¾Ù†Ù„ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯.'); 
    await renderAccount(currentChatId);
    
  } catch(e) {
    alert('âŒ Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯: '+ (e.message || e));
    console.error(e);
  }
});

collectBtn.addEventListener('click', async ()=>{ 
  if(!currentChatId) return alert('Ø®Ø·Ø§: Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø´ÙˆÛŒØ¯.'); 
  try {
    let u = await getUser(currentChatId); 
    if(!u) return alert('Ø®Ø·Ø§: Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.'); 
    accrueFor(u); 
    await setUser(currentChatId, u); 
    alert('âœ… Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.');
    await renderAccount(currentChatId); 
  } catch(e) {
    alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: '+ (e.message || e));
  }
});

logoutBtn.addEventListener('click', ()=>{ 
  currentChatId = null; 
  localStorage.removeItem('natcoin_last_chat');
  renderAccount(null); 
  alert('âœ… Ø®Ø±ÙˆØ¬ Ø§Ù…Ù† Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.'); 
});

exportTokenBtn.addEventListener('click', async ()=>{
  try{
    const chatId = chatIdInput.value.trim(); 
    if(!chatId || chatId !== currentChatId) return alert('Ø®Ø·Ø§: Ø¨Ø±Ø§ÛŒ ØµØ¯ÙˆØ± ØªÙˆÚ©Ù†ØŒ Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®ÙˆØ¯ Ø´ÙˆÛŒØ¯.');
    const amt = Number(transferAmountInput.value) || 0;
    
    const token = await exportAccountOneTime(chatId, amt);
    exportArea.value = token;
    alert('âœ… ØªÙˆÚ©Ù† ÛŒÚ©â€ŒØ¨Ø§Ø±Ù…ØµØ±Ù Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯. Ø¢Ù† Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ú¯ÛŒØ±Ù†Ø¯Ù‡ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.');
    await renderAccount(chatId);
  }catch(e){ 
    alert('âŒ Ø®Ø·Ø§ Ø¯Ø± ØµØ¯ÙˆØ± ØªÙˆÚ©Ù†: '+ (e.message || e)); 
    console.error(e); 
  }
});

importBase64Btn.addEventListener('click', async ()=>{
  try{
    const txt = importArea.value.trim(); 
    if(!txt) return alert('Ø®Ø·Ø§: Ù„Ø·ÙØ§Ù‹ ØªÙˆÚ©Ù† Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø±Ø§ Ø¯Ø± Ú©Ø§Ø¯Ø± Ø¯Ø±ÙˆÙ†â€ŒØ±ÛŒØ²ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
    const target = await importAccountFromInput(txt);
    alert('âœ… Ø¹Ù…Ù„ÛŒØ§Øª Ø¯Ø±ÙˆÙ†â€ŒØ±ÛŒØ²ÛŒ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯. Ù…Ø¨Ù„Øº Ø¨Ù‡ Ø­Ø³Ø§Ø¨ '+(target||'Ø´Ù…Ø§')+' ÙˆØ§Ø±ÛŒØ² Ø´Ø¯ Ùˆ ØªÙˆÚ©Ù† Ù…ØµØ±Ù Ø´Ø¯.');
    await renderAccount(target);
    if(currentChatId) await renderAccount(currentChatId); // Ø§Ú¯Ø± Ù„Ø§Ú¯ÛŒÙ† Ø¨ÙˆØ¯ Ù‡Ù… Ø±Ù†Ø¯Ø± Ø´ÙˆØ¯
  }catch(e){ 
    alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÙˆÙ†â€ŒØ±ÛŒØ²ÛŒ: '+ (e.message || e)); 
    console.error(e); 
  }
});

(async function init(){
  const last = localStorage.getItem('natcoin_last_chat'); 
  if(last) chatIdInput.value = last;
  
  if(localStorage.getItem('natcoin_last_chat')) {
    currentChatId = localStorage.getItem('natcoin_last_chat');
    try{ await renderAccount(currentChatId); }catch(e){ console.warn('render init failed', e); }
  } else {
    renderAccount(null);
  }
  
  chatIdInput.addEventListener('change', ()=> localStorage.setItem('natcoin_last_chat', chatIdInput.value.trim()));
  
  // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù‡Ø± 30 Ø«Ø§Ù†ÛŒÙ‡
  setInterval(async ()=>{ 
    if(currentChatId) await renderAccount(currentChatId); 
  },30000); 
})();
</script>
</body>
</html>