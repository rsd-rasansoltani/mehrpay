<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mahr — پنل مدیریت کارت</title>
  
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />

<style>
  /* ---------------------- طراحی حرفه‌ای فین‌تک (بانکداری مدرن) ---------------------- */
  :root {
    --color-primary: #002d62;       /* آبی تیره سلطنتی (Navy Blue) */
    --color-secondary: #004a99;     /* آبی اصلی برای دکمه‌ها و هایلایت */
    --color-text: #1f2937;          /* خاکستری ذغالی تیره برای متن اصلی */
    --color-muted: #6b7280;         /* خاکستری متوسط برای متن‌های کمکی */
    --color-background: #f8f9fa;    /* پس‌زمینه خیلی روشن */
    --color-card-bg: #ffffff;       /* پس‌زمینه کارت سفید خالص */
    --color-border: #e5e7eb;        /* خطوط جداکننده نازک */
    --color-success: #16a34a;       /* سبز تایید */
    --color-danger: #dc2626;        /* قرمز هشدار */
    --radius-default: 8px;          /* شعاع گوشه‌ها */
    --shadow-main: 0 10px 30px rgba(0, 0, 0, 0.05);
  }

  * {
    box-sizing: border-box;
    font-family: 'Vazirmatn', Tahoma, Arial, 'Segoe UI', system-ui, sans-serif;
    direction: rtl;
  }

  body {
    margin: 0;
    min-height: 100vh;
    background-color: var(--color-background);
    color: var(--color-text);
    padding: 40px 20px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .wrap { max-width: 500px; width: 100%; }

  .card {
    background: var(--color-card-bg);
    padding: 30px;
    border-radius: var(--radius-default);
    box-shadow: var(--shadow-main);
    border: 1px solid var(--color-border);
  }
  
  h2 {
    margin: 0 0 15px 0;
    font-size: 24px;
    color: var(--color-primary);
    font-weight: 700;
  }

  /* بازنویسی برای ورودی‌ها و دکمه‌ها */
  label { 
      display: block; 
      color: var(--color-text); 
      font-size: 14px; 
      font-weight: 500;
      margin-top: 20px;
      margin-bottom: 8px; 
  }

  input, button {
    width: 100%;
    padding: 13px 15px; 
    border-radius: 6px;
    font-size: 16px;
    transition: all 0.2s ease;
  }
  
  input {
    border: 1px solid var(--color-border);
    background: var(--color-background);
    color: var(--color-text);
  }
  input:focus {
    border-color: var(--color-secondary);
    outline: none;
    box-shadow: 0 0 0 3px rgba(0, 74, 153, 0.1); 
  }

  .btn {
    background: var(--color-secondary);
    color: #fff;
    border: 0;
    margin-top: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color .2s ease;
  }
  .btn:hover { background: var(--color-primary); }

  .muted { color: var(--color-muted); font-size: 14px; line-height: 1.6; }
  
  /* باکس‌های وضعیت کارت */
  #cardBox p {
    font-size: 16px;
    margin-top: 12px;
    padding: 8px 0;
    border-bottom: 1px dashed var(--color-border);
  }
  #cardBox p:last-of-type { border-bottom: none; }
  #cardBox b { color: var(--color-primary); font-weight: 600; }
  #balance { font-size: 20px; font-weight: 700; color: var(--color-success); font-family: Arial, sans-serif; }
  #pinShow { font-weight: 700; color: var(--color-text); font-family: monospace; }
  
  /* QR Code */
  .qr {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 15px;
    border-radius: var(--radius-default);
    background: var(--color-background); /* پس‌زمینه روشن برای کنتراست */
    margin-top: 30px;
    border: 1px solid var(--color-border);
  }
  .qr canvas { max-width: 100%; height: auto; display: block; }
  
  /* لینک */
  a.link-like{
    word-break: break-all;
    color: var(--color-secondary);
    font-size: 14px;
    display: block;
    margin-top: 5px;
    text-decoration: none;
    font-family: monospace;
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>🔒 پنل مدیریت کارت</h2>
      <p class="muted">با تأیید هویت از طریق تلگرام، موجودی و PIN کارت خود را مدیریت کنید.</p>

      <label for="chatIdInput">شناسه کاربری تلگرام (Chat ID)</label>
      <input id="chatIdInput" placeholder="شناسه عددی ربات" />

      <button id="loadBtn" class="btn">دریافت کد تایید تلگرام</button>

      <div id="verifyBox" style="display:none;margin-top:20px">
        <label for="codeInput">کد تایید دریافتی از تلگرام</label>
        <input id="codeInput" placeholder="کد ۵ رقمی" />
        <button id="verifyBtn" class="btn">تایید کد و مشاهده کارت</button>
      </div>

      <div id="cardBox" style="display:none;margin-top:20px">
        <p><b>موجودی فعلی:</b> <span id="balance">0</span> ⛁</p>
        <p><b>رمز (PIN) فعلی:</b> <span id="pinShow">7444</span></p>

        <hr style="margin:20px 0; border:none; border-top: 1px dashed var(--color-border);">
        
        <label for="newPinInput">تغییر رمز (PIN جدید ۴ رقمی)</label>
        <input id="newPinInput" placeholder="مثال: 8888" maxlength="4" type="tel" />
        <button id="updatePinBtn" class="btn">ثبت رمز جدید</button>

        <div class="qr" id="qrBox"></div>
        <p class="muted" style="margin-top: 15px;">
          لینک رمزگذاری شده کارت شما (برای استفاده در دستگاه‌های پذیرنده): 
          <br><a id="cardLink" class="link-like" href="#" target="_blank"></a>
        </p>
        <div class="muted" style="color: var(--color-danger); font-weight: 500; margin-top: 10px;">
            ⚠️ **هشدار امنیتی:** این لینک حاوی کلید دسترسی به موجودی شما است. آن را با کسی به اشتراک نگذارید.
        </div>
      </div>
    </div>
  </div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<script>
/* ------------------ توکن تلگرام مخفی ------------------ */
const XOR_KEY = 'rasan_key_42';
const ENCODED_TOKEN_XOR = 'RVdCUl1sUlJBbw5zMyQaWR8QIxI2FwxRCi1LCCxtDhRAbVBGGA46KBptICIWKA==';
function base64Decode(s){ try{ return atob(s); }catch(e){ return null; } }
function xorString(str, key){
  let out = '';
  for(let i=0;i<str.length;i++){ out += String.fromCharCode(str.charCodeAt(i) ^ key.charCodeAt(i % key.length)); }
  return out;
}
function getBotToken(){
  const step1 = base64Decode(ENCODED_TOKEN_XOR);
  if(!step1) return null;
  return xorString(step1, XOR_KEY);
}

/* ------------------ Firebase ------------------ */
const firebaseConfig = {
  apiKey: "AIzaSyBiHkCAzkTzUO7weLsKGXc917JNob-dhO4",
  authDomain: "rasancoin.firebaseapp.com",
  projectId: "rasancoin",
  storageBucket: "rasancoin.firebasestorage.app",
  messagingSenderId: "289625483659",
  appId: "1:289625483659:web:b7e170072cf09a7157678e",
  measurementId: "G-KNNM4FF9MS"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
auth.signInAnonymously().catch(()=>{});

/* ------------------ کمک‌ها ------------------ */
function accrueFor(user){
  const now = Date.now();
  if(!user.lastUpdated){ user.lastUpdated=now; return; }
  const elapsed=now-user.lastUpdated;
  const coins = elapsed/3600000*10;
  user.balance=(user.balance||0)+coins;
  user.lastUpdated=now;
}

function b64EncodeUnicode(str){
  return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
    function(match, p1){ return String.fromCharCode('0x' + p1); }));
}

/* ------------------ عملیات کارت ------------------ */
async function loadCard(chatId){
  const ref = db.collection('users').doc(String(chatId));
  const doc = await ref.get();
  let user;
  if(doc.exists){ user = doc.data(); }
  else { user = {balance:0,lastUpdated:Date.now(),pin:'7444'}; await ref.set(user); }
  accrueFor(user);
  await ref.set(user,{merge:true});
  return user;
}

async function updatePin(chatId,newPin){
  await db.collection('users').doc(String(chatId)).set({pin:String(newPin)},{merge:true});
}

/* ------------------ ارسال پیام تلگرام ------------------ */
async function sendTelegramMessageHidden(chatId,text){
  const token = getBotToken();
  if(!token) return { ok:false, error:'token decode failed' };
  const url = `https://api.telegram.org/bot${encodeURIComponent(token)}/sendMessage`;
  try{
    const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ chat_id: chatId, text }) });
    const data = await res.json();
    return data;
  }catch(err){ return { ok:false, error:err.message } }
}

/* ------------------ UI ------------------ */
const chatIdInput = document.getElementById('chatIdInput');
const loadBtn = document.getElementById('loadBtn');
const verifyBox = document.getElementById('verifyBox');
const codeInput = document.getElementById('codeInput');
const verifyBtn = document.getElementById('verifyBtn');
const cardBox = document.getElementById('cardBox');
const balanceSpan = document.getElementById('balance');
const pinShow = document.getElementById('pinShow');
const newPinInput = document.getElementById('newPinInput');
const updatePinBtn = document.getElementById('updatePinBtn');
const qrBox = document.getElementById('qrBox');
const cardLink = document.getElementById('cardLink');

let currentChatId = null;

loadBtn.addEventListener('click', async ()=>{
  const chatId = chatIdInput.value.trim();
  if(!chatId) return alert('خطا: Chat ID وارد نشده است.');

  const code = Math.floor(10000 + Math.random()*90000).toString();
  await db.collection('codes').doc(chatId).set({ code, created: Date.now() });

  const resp = await sendTelegramMessageHidden(chatId, `کد تایید شما: ${code}`);
  if(resp && resp.ok){
    alert('✅ کد تایید به تلگرام شما ارسال شد. لطفاً آن را وارد کنید.');
    verifyBox.style.display = 'block';
  } else {
    alert('❌ ارسال کد موفقیت‌آمیز نبود. لطفاً Chat ID را بررسی کنید.');
  }
});

verifyBtn.addEventListener('click', async ()=>{
  const chatId = chatIdInput.value.trim();
  const inputCode = codeInput.value.trim();
  if(!chatId || !inputCode) return alert('خطا: Chat ID و کد لازم است.');

  const snap = await db.collection('codes').doc(chatId).get();
  if(!snap.exists) return alert('خطا: ابتدا دکمه «دریافت کد تایید» را بزنید.');
  const data = snap.data();
  if(data.code !== inputCode) return alert('خطا: کد تایید نادرست است.');

  await db.collection('codes').doc(chatId).delete();

  const user = await loadCard(chatId);
  balanceSpan.textContent = Math.floor(user.balance||0).toLocaleString('fa-IR');
  pinShow.textContent = user.pin || '7444';
  cardBox.style.display = 'block';
  verifyBox.style.display = 'none'; // مخفی کردن جعبه تایید پس از ورود موفق

  const b64 = b64EncodeUnicode(chatId);
  // توجه: فرض بر این است که reader.html در همان سطح قرار دارد.
  const url = location.origin + location.pathname.replace(/[^/]*$/,'') + 'reader.html#cardb64/' + encodeURIComponent(b64);
  cardLink.href = url;
  cardLink.textContent = url;
  
  qrBox.innerHTML = '';
  QRCode.toCanvas(url, {width:200}, (err, canvas) => { 
    if(err){ 
      qrBox.textContent='خطا در تولید QR'; 
      return; 
    } 
    qrBox.appendChild(canvas); 
  });
  alert('✅ ورود موفقیت آمیز! جزئیات کارت بارگذاری شد.');
});

updatePinBtn.addEventListener('click', async ()=>{
  const chatId = chatIdInput.value.trim();
  const newPin = newPinInput.value.trim();
  if(!chatId) return alert('خطا: ابتدا هویت خود را تایید کنید.');
  if(!newPin || newPin.length !== 4 || isNaN(newPin)) return alert('خطا: PIN جدید باید یک عدد ۴ رقمی باشد.');
  
  try {
      await updatePin(chatId,newPin);
      alert('✅ PIN با موفقیت تغییر کرد.');
      pinShow.textContent = newPin;
      newPinInput.value = '';
  } catch(e) {
      alert('❌ خطا در ثبت PIN جدید.');
  }
});
</script>
</body>
</html>