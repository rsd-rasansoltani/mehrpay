<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mahr â€” Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Øª</title>
  
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />

<style>
  /* ---------------------- Ø·Ø±Ø§Ø­ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ ÙÛŒÙ†â€ŒØªÚ© (Ø¨Ø§Ù†Ú©Ø¯Ø§Ø±ÛŒ Ù…Ø¯Ø±Ù†) ---------------------- */
  :root {
    --color-primary: #002d62;       /* Ø¢Ø¨ÛŒ ØªÛŒØ±Ù‡ Ø³Ù„Ø·Ù†ØªÛŒ (Navy Blue) */
    --color-secondary: #004a99;     /* Ø¢Ø¨ÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ùˆ Ù‡Ø§ÛŒÙ„Ø§ÛŒØª */
    --color-text: #1f2937;          /* Ø®Ø§Ú©Ø³ØªØ±ÛŒ Ø°ØºØ§Ù„ÛŒ ØªÛŒØ±Ù‡ Ø¨Ø±Ø§ÛŒ Ù…ØªÙ† Ø§ØµÙ„ÛŒ */
    --color-muted: #6b7280;         /* Ø®Ø§Ú©Ø³ØªØ±ÛŒ Ù…ØªÙˆØ³Ø· Ø¨Ø±Ø§ÛŒ Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ */
    --color-background: #f8f9fa;    /* Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø®ÛŒÙ„ÛŒ Ø±ÙˆØ´Ù† */
    --color-card-bg: #ffffff;       /* Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ú©Ø§Ø±Øª Ø³ÙÛŒØ¯ Ø®Ø§Ù„Øµ */
    --color-border: #e5e7eb;        /* Ø®Ø·ÙˆØ· Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ Ù†Ø§Ø²Ú© */
    --color-success: #16a34a;       /* Ø³Ø¨Ø² ØªØ§ÛŒÛŒØ¯ */
    --color-danger: #dc2626;        /* Ù‚Ø±Ù…Ø² Ù‡Ø´Ø¯Ø§Ø± */
    --radius-default: 8px;          /* Ø´Ø¹Ø§Ø¹ Ú¯ÙˆØ´Ù‡â€ŒÙ‡Ø§ */
    --shadow-main: 0 10px 30px rgba(0, 0, 0, 0.05);
  }

  * {
    box-sizing: border-box;
    font-family: 'Vazirmatn', Tahoma, Arial, 'Segoe UI', system-ui, sans-serif;
    direction: rtl;
  }

  body {
    margin: 0;
    min-height: 100vh;
    background-color: var(--color-background);
    color: var(--color-text);
    padding: 40px 20px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .wrap { max-width: 500px; width: 100%; }

  .card {
    background: var(--color-card-bg);
    padding: 30px;
    border-radius: var(--radius-default);
    box-shadow: var(--shadow-main);
    border: 1px solid var(--color-border);
  }
  
  h2 {
    margin: 0 0 15px 0;
    font-size: 24px;
    color: var(--color-primary);
    font-weight: 700;
  }

  /* Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ Ùˆ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
  label { 
      display: block; 
      color: var(--color-text); 
      font-size: 14px; 
      font-weight: 500;
      margin-top: 20px;
      margin-bottom: 8px; 
  }

  input, button {
    width: 100%;
    padding: 13px 15px; 
    border-radius: 6px;
    font-size: 16px;
    transition: all 0.2s ease;
  }
  
  input {
    border: 1px solid var(--color-border);
    background: var(--color-background);
    color: var(--color-text);
  }
  input:focus {
    border-color: var(--color-secondary);
    outline: none;
    box-shadow: 0 0 0 3px rgba(0, 74, 153, 0.1); 
  }

  .btn {
    background: var(--color-secondary);
    color: #fff;
    border: 0;
    margin-top: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color .2s ease;
  }
  .btn:hover { background: var(--color-primary); }

  .muted { color: var(--color-muted); font-size: 14px; line-height: 1.6; }
  
  /* Ø¨Ø§Ú©Ø³â€ŒÙ‡Ø§ÛŒ ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Øª */
  #cardBox p {
    font-size: 16px;
    margin-top: 12px;
    padding: 8px 0;
    border-bottom: 1px dashed var(--color-border);
  }
  #cardBox p:last-of-type { border-bottom: none; }
  #cardBox b { color: var(--color-primary); font-weight: 600; }
  #balance { font-size: 20px; font-weight: 700; color: var(--color-success); font-family: Arial, sans-serif; }
  #pinShow { font-weight: 700; color: var(--color-text); font-family: monospace; }
  
  /* QR Code */
  .qr {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 15px;
    border-radius: var(--radius-default);
    background: var(--color-background); /* Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø±ÙˆØ´Ù† Ø¨Ø±Ø§ÛŒ Ú©Ù†ØªØ±Ø§Ø³Øª */
    margin-top: 30px;
    border: 1px solid var(--color-border);
  }
  .qr canvas { max-width: 100%; height: auto; display: block; }
  
  /* Ù„ÛŒÙ†Ú© */
  a.link-like{
    word-break: break-all;
    color: var(--color-secondary);
    font-size: 14px;
    display: block;
    margin-top: 5px;
    text-decoration: none;
    font-family: monospace;
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>ğŸ”’ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Øª</h2>
      <p class="muted">Ø¨Ø§ ØªØ£ÛŒÛŒØ¯ Ù‡ÙˆÛŒØª Ø§Ø² Ø·Ø±ÛŒÙ‚ ØªÙ„Ú¯Ø±Ø§Ù…ØŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ùˆ PIN Ú©Ø§Ø±Øª Ø®ÙˆØ¯ Ø±Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù†ÛŒØ¯.</p>

      <label for="chatIdInput">Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ ØªÙ„Ú¯Ø±Ø§Ù… (Chat ID)</label>
      <input id="chatIdInput" placeholder="Ø´Ù†Ø§Ø³Ù‡ Ø¹Ø¯Ø¯ÛŒ Ø±Ø¨Ø§Øª" />

      <button id="loadBtn" class="btn">Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ ØªÙ„Ú¯Ø±Ø§Ù…</button>

      <div id="verifyBox" style="display:none;margin-top:20px">
        <label for="codeInput">Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø§Ø² ØªÙ„Ú¯Ø±Ø§Ù…</label>
        <input id="codeInput" placeholder="Ú©Ø¯ Ûµ Ø±Ù‚Ù…ÛŒ" />
        <button id="verifyBtn" class="btn">ØªØ§ÛŒÛŒØ¯ Ú©Ø¯ Ùˆ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ø§Ø±Øª</button>
      </div>

      <div id="cardBox" style="display:none;margin-top:20px">
        <p><b>Ù…ÙˆØ¬ÙˆØ¯ÛŒ ÙØ¹Ù„ÛŒ:</b> <span id="balance">0</span> â›</p>
        <p><b>Ø±Ù…Ø² (PIN) ÙØ¹Ù„ÛŒ:</b> <span id="pinShow">7444</span></p>

        <hr style="margin:20px 0; border:none; border-top: 1px dashed var(--color-border);">
        
        <label for="newPinInput">ØªØºÛŒÛŒØ± Ø±Ù…Ø² (PIN Ø¬Ø¯ÛŒØ¯ Û´ Ø±Ù‚Ù…ÛŒ)</label>
        <input id="newPinInput" placeholder="Ù…Ø«Ø§Ù„: 8888" maxlength="4" type="tel" />
        <button id="updatePinBtn" class="btn">Ø«Ø¨Øª Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯</button>

        <div class="qr" id="qrBox"></div>
        <p class="muted" style="margin-top: 15px;">
          Ù„ÛŒÙ†Ú© Ø±Ù…Ø²Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù‡ Ú©Ø§Ø±Øª Ø´Ù…Ø§ (Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø°ÛŒØ±Ù†Ø¯Ù‡): 
          <br><a id="cardLink" class="link-like" href="#" target="_blank"></a>
        </p>
        <div class="muted" style="color: var(--color-danger); font-weight: 500; margin-top: 10px;">
            âš ï¸ **Ù‡Ø´Ø¯Ø§Ø± Ø§Ù…Ù†ÛŒØªÛŒ:** Ø§ÛŒÙ† Ù„ÛŒÙ†Ú© Ø­Ø§ÙˆÛŒ Ú©Ù„ÛŒØ¯ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø´Ù…Ø§ Ø§Ø³Øª. Ø¢Ù† Ø±Ø§ Ø¨Ø§ Ú©Ø³ÛŒ Ø¨Ù‡ Ø§Ø´ØªØ±Ø§Ú© Ù†Ú¯Ø°Ø§Ø±ÛŒØ¯.
        </div>
      </div>
    </div>
  </div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<script>
/* ------------------ ØªÙˆÚ©Ù† ØªÙ„Ú¯Ø±Ø§Ù… Ù…Ø®ÙÛŒ ------------------ */
const XOR_KEY = 'rasan_key_42';
const ENCODED_TOKEN_XOR = 'RVdCUl1sUlJBbw5zMyQaWR8QIxI2FwxRCi1LCCxtDhRAbVBGGA46KBptICIWKA==';
function base64Decode(s){ try{ return atob(s); }catch(e){ return null; } }
function xorString(str, key){
  let out = '';
  for(let i=0;i<str.length;i++){ out += String.fromCharCode(str.charCodeAt(i) ^ key.charCodeAt(i % key.length)); }
  return out;
}
function getBotToken(){
  const step1 = base64Decode(ENCODED_TOKEN_XOR);
  if(!step1) return null;
  return xorString(step1, XOR_KEY);
}

/* ------------------ Firebase ------------------ */
const firebaseConfig = {
  apiKey: "AIzaSyBiHkCAzkTzUO7weLsKGXc917JNob-dhO4",
  authDomain: "rasancoin.firebaseapp.com",
  projectId: "rasancoin",
  storageBucket: "rasancoin.firebasestorage.app",
  messagingSenderId: "289625483659",
  appId: "1:289625483659:web:b7e170072cf09a7157678e",
  measurementId: "G-KNNM4FF9MS"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
auth.signInAnonymously().catch(()=>{});

/* ------------------ Ú©Ù…Ú©â€ŒÙ‡Ø§ ------------------ */
function accrueFor(user){
  const now = Date.now();
  if(!user.lastUpdated){ user.lastUpdated=now; return; }
  const elapsed=now-user.lastUpdated;
  const coins = elapsed/3600000*10;
  user.balance=(user.balance||0)+coins;
  user.lastUpdated=now;
}

function b64EncodeUnicode(str){
  return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
    function(match, p1){ return String.fromCharCode('0x' + p1); }));
}

/* ------------------ Ø¹Ù…Ù„ÛŒØ§Øª Ú©Ø§Ø±Øª ------------------ */
async function loadCard(chatId){
  const ref = db.collection('users').doc(String(chatId));
  const doc = await ref.get();
  let user;
  if(doc.exists){ user = doc.data(); }
  else { user = {balance:0,lastUpdated:Date.now(),pin:'7444'}; await ref.set(user); }
  accrueFor(user);
  await ref.set(user,{merge:true});
  return user;
}

async function updatePin(chatId,newPin){
  await db.collection('users').doc(String(chatId)).set({pin:String(newPin)},{merge:true});
}

/* ------------------ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… ØªÙ„Ú¯Ø±Ø§Ù… ------------------ */
async function sendTelegramMessageHidden(chatId,text){
  const token = getBotToken();
  if(!token) return { ok:false, error:'token decode failed' };
  const url = `https://api.telegram.org/bot${encodeURIComponent(token)}/sendMessage`;
  try{
    const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ chat_id: chatId, text }) });
    const data = await res.json();
    return data;
  }catch(err){ return { ok:false, error:err.message } }
}

/* ------------------ UI ------------------ */
const chatIdInput = document.getElementById('chatIdInput');
const loadBtn = document.getElementById('loadBtn');
const verifyBox = document.getElementById('verifyBox');
const codeInput = document.getElementById('codeInput');
const verifyBtn = document.getElementById('verifyBtn');
const cardBox = document.getElementById('cardBox');
const balanceSpan = document.getElementById('balance');
const pinShow = document.getElementById('pinShow');
const newPinInput = document.getElementById('newPinInput');
const updatePinBtn = document.getElementById('updatePinBtn');
const qrBox = document.getElementById('qrBox');
const cardLink = document.getElementById('cardLink');

let currentChatId = null;

loadBtn.addEventListener('click', async ()=>{
  const chatId = chatIdInput.value.trim();
  if(!chatId) return alert('Ø®Ø·Ø§: Chat ID ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.');

  const code = Math.floor(10000 + Math.random()*90000).toString();
  await db.collection('codes').doc(chatId).set({ code, created: Date.now() });

  const resp = await sendTelegramMessageHidden(chatId, `Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ø´Ù…Ø§: ${code}`);
  if(resp && resp.ok){
    alert('âœ… Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù… Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¢Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
    verifyBox.style.display = 'block';
  } else {
    alert('âŒ Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ù†Ø¨ÙˆØ¯. Ù„Ø·ÙØ§Ù‹ Chat ID Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.');
  }
});

verifyBtn.addEventListener('click', async ()=>{
  const chatId = chatIdInput.value.trim();
  const inputCode = codeInput.value.trim();
  if(!chatId || !inputCode) return alert('Ø®Ø·Ø§: Chat ID Ùˆ Ú©Ø¯ Ù„Ø§Ø²Ù… Ø§Ø³Øª.');

  const snap = await db.collection('codes').doc(chatId).get();
  if(!snap.exists) return alert('Ø®Ø·Ø§: Ø§Ø¨ØªØ¯Ø§ Ø¯Ú©Ù…Ù‡ Â«Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯ ØªØ§ÛŒÛŒØ¯Â» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.');
  const data = snap.data();
  if(data.code !== inputCode) return alert('Ø®Ø·Ø§: Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª.');

  await db.collection('codes').doc(chatId).delete();

  const user = await loadCard(chatId);
  balanceSpan.textContent = Math.floor(user.balance||0).toLocaleString('fa-IR');
  pinShow.textContent = user.pin || '7444';
  cardBox.style.display = 'block';
  verifyBox.style.display = 'none'; // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø¬Ø¹Ø¨Ù‡ ØªØ§ÛŒÛŒØ¯ Ù¾Ø³ Ø§Ø² ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚

  const b64 = b64EncodeUnicode(chatId);
  // ØªÙˆØ¬Ù‡: ÙØ±Ø¶ Ø¨Ø± Ø§ÛŒÙ† Ø§Ø³Øª Ú©Ù‡ reader.html Ø¯Ø± Ù‡Ù…Ø§Ù† Ø³Ø·Ø­ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯.
  const url = location.origin + location.pathname.replace(/[^/]*$/,'') + 'reader.html#cardb64/' + encodeURIComponent(b64);
  cardLink.href = url;
  cardLink.textContent = url;
  
  qrBox.innerHTML = '';
  QRCode.toCanvas(url, {width:200}, (err, canvas) => { 
    if(err){ 
      qrBox.textContent='Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ QR'; 
      return; 
    } 
    qrBox.appendChild(canvas); 
  });
  alert('âœ… ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ÛŒØª Ø¢Ù…ÛŒØ²! Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ø±Øª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯.');
});

updatePinBtn.addEventListener('click', async ()=>{
  const chatId = chatIdInput.value.trim();
  const newPin = newPinInput.value.trim();
  if(!chatId) return alert('Ø®Ø·Ø§: Ø§Ø¨ØªØ¯Ø§ Ù‡ÙˆÛŒØª Ø®ÙˆØ¯ Ø±Ø§ ØªØ§ÛŒÛŒØ¯ Ú©Ù†ÛŒØ¯.');
  if(!newPin || newPin.length !== 4 || isNaN(newPin)) return alert('Ø®Ø·Ø§: PIN Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ÛŒØ¯ ÛŒÚ© Ø¹Ø¯Ø¯ Û´ Ø±Ù‚Ù…ÛŒ Ø¨Ø§Ø´Ø¯.');
  
  try {
      await updatePin(chatId,newPin);
      alert('âœ… PIN Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØºÛŒÛŒØ± Ú©Ø±Ø¯.');
      pinShow.textContent = newPin;
      newPinInput.value = '';
  } catch(e) {
      alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª PIN Ø¬Ø¯ÛŒØ¯.');
  }
});
</script>
</body>
</html>