<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Triple Dice Roller â€” Ù¾Ù†Ù„ Ø´Ø±Ø·â€ŒØ¨Ù†Ø¯ÛŒ</title>
  
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />

<style>
  /* ---------------------- Ø·Ø±Ø§Ø­ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ ÙÛŒÙ†â€ŒØªÚ© (Ø¨Ø§Ù†Ú©Ø¯Ø§Ø±ÛŒ Ù…Ø¯Ø±Ù†) ---------------------- */
  :root {
    --color-primary: #002d62;       /* Ø¢Ø¨ÛŒ ØªÛŒØ±Ù‡ Ø³Ù„Ø·Ù†ØªÛŒ (Navy Blue) */
    --color-secondary: #004a99;     /* Ø¢Ø¨ÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ùˆ Ù‡Ø§ÛŒÙ„Ø§ÛŒØª */
    --color-text: #1f2937;          /* Ø®Ø§Ú©Ø³ØªØ±ÛŒ Ø°ØºØ§Ù„ÛŒ ØªÛŒØ±Ù‡ Ø¨Ø±Ø§ÛŒ Ù…ØªÙ† Ø§ØµÙ„ÛŒ */
    --color-muted: #6b7280;         /* Ø®Ø§Ú©Ø³ØªØ±ÛŒ Ù…ØªÙˆØ³Ø· Ø¨Ø±Ø§ÛŒ Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ */
    --color-background: #f8f9fa;    /* Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø®ÛŒÙ„ÛŒ Ø±ÙˆØ´Ù† */
    --color-card-bg: #ffffff;       /* Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ú©Ø§Ø±Øª Ø³ÙÛŒØ¯ Ø®Ø§Ù„Øµ */
    --color-border: #e5e7eb;        /* Ø®Ø·ÙˆØ· Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ Ù†Ø§Ø²Ú© */
    --color-success: #16a34a;       /* Ø³Ø¨Ø² ØªØ§ÛŒÛŒØ¯ */
    --color-danger: #dc2626;        /* Ù‚Ø±Ù…Ø² Ù‡Ø´Ø¯Ø§Ø± */
    --radius-default: 8px;          /* Ø´Ø¹Ø§Ø¹ Ú¯ÙˆØ´Ù‡â€ŒÙ‡Ø§ */
    --shadow-main: 0 10px 30px rgba(0, 0, 0, 0.05);
  }

  * {
    box-sizing: border-box;
    font-family: 'Vazirmatn', Tahoma, Arial, 'Segoe UI', system-ui, sans-serif;
  }

  body {
    margin: 0;
    font-family: 'Vazirmatn', system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
    background-color: var(--color-background);
    min-height: 100vh;
    color: var(--color-text);
    display: grid;
    place-items: center;
    padding: 40px 20px;
    direction: rtl;
  }

  .container { width: min(100%, 1150px); }

  .card {
    background: var(--color-card-bg);
    border-radius: var(--radius-default);
    padding: 25px;
    border: 1px solid var(--color-border);
    box-shadow: var(--shadow-main);
  }
  
  h1 { 
      margin: 0 0 10px 0; 
      font-size: 24px; 
      color: var(--color-primary); 
      font-weight: 700; 
      padding-bottom: 5px;
  }
  h2 {
      font-size: 18px;
      font-weight: 600;
      color: var(--color-text);
      margin: 0 0 15px 0;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--color-border);
  }

  .flex { display: flex; gap: 30px; }
  .col { flex: 1; }

  .panel {
    padding: 25px;
    border-radius: var(--radius-default);
    background: var(--color-card-bg);
    border: 1px solid var(--color-border);
  }
  
  /* Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ */
  label { 
      display: block; 
      color: var(--color-text); 
      font-size: 14px; 
      font-weight: 500;
      margin-bottom: 8px; 
  }

  input, button, textarea {
    width: 100%;
    padding: 13px 15px; 
    border-radius: 6px;
    border: 1px solid var(--color-border);
    background: var(--color-background);
    color: var(--color-text);
    font-size: 16px;
    transition: all 0.2s ease;
  }
  input:focus, textarea:focus {
    border-color: var(--color-secondary);
    outline: none;
    box-shadow: 0 0 0 3px rgba(0, 74, 153, 0.1); 
  }

  .muted { color: var(--color-muted); font-size: 14px; line-height: 1.6; }

  .dice-row { 
      display: grid; 
      grid-template-columns: repeat(3,1fr); 
      gap: 20px; 
      margin: 25px 0;
  }

  /* ØªØ§Ø³â€ŒÙ‡Ø§ - Ø¸Ø§Ù‡Ø± Ø´ÛŒØ´Ù‡â€ŒØ§ÛŒ/Ù…Ø¯Ø±Ù† Ø¨Ø§ Ø±Ù†Ú¯ Ø±Ø³Ù…ÛŒ */
  .die {
    aspect-ratio: 1;
    border-radius: var(--radius-default);
    background: var(--color-background);
    border: 1px solid var(--color-border);
    display: grid;
    place-items: center;
    font-weight: 700;
    font-size: 48px;
    color: var(--color-primary);
    box-shadow: 0 5px 15px rgba(0,0,0,.08);
  }
  
  /* Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ù„Ø±Ø²Ø´ ØªØ§Ø³ */
  @keyframes shake {
      0% { transform: translate(1px, 1px) rotate(0deg); }
      10% { transform: translate(-1px, -2px) rotate(-1deg); }
      20% { transform: translate(-3px, 0px) rotate(1deg); }
      30% { transform: translate(3px, 2px) rotate(0deg); }
      40% { transform: translate(1px, -1px) rotate(1deg); }
      50% { transform: translate(-1px, 2px) rotate(-1deg); }
      60% { transform: translate(-3px, 1px) rotate(0deg); }
      70% { transform: translate(3px, 1px) rotate(-1deg); }
      80% { transform: translate(-1px, -1px) rotate(1deg); }
      90% { transform: translate(1px, 2px) rotate(0deg); }
      100% { transform: translate(1px, -2px) rotate(-1deg); }
  }
  .shaking .value {
    animation: shake 0.1s infinite;
  }

  .controls { display: flex; gap: 15px; margin-top: 15px; }

  /* Ø¯Ú©Ù…Ù‡ Ø§ØµÙ„ÛŒ (Ø¢Ø¨ÛŒ) */
  button.primary {
    background: var(--color-secondary);
    color: #fff;
    border: 0;
    padding: 13px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color .2s ease;
  }
  button.primary:hover { background: var(--color-primary); }
  button.primary:disabled { opacity: 0.7; cursor: not-allowed; }

  /* Ø¯Ú©Ù…Ù‡ Ø«Ø§Ù†ÙˆÛŒÙ‡ (Ghost) */
  button.ghost {
    background: transparent;
    border: 1px solid var(--color-border);
    color: var(--color-text);
    cursor: pointer;
    padding: 13px;
    border-radius: 6px;
    transition: background .2s;
  }
  button.ghost:hover { background: var(--color-background); }

  .right { width: 380px; }
  
  /* Ø§Ø³ØªØ§ØªÙˆØ³ / Ù†ØªÛŒØ¬Ù‡ Ø´Ø±Ø·â€ŒØ¨Ù†Ø¯ÛŒ */
  .status {
    margin-top: 20px;
    padding: 15px;
    border-radius: 6px;
    font-size: 15px;
    font-weight: 500;
    border: 1px solid var(--color-border);
    background: var(--color-background);
  }
  .status.win {
      background: #ecfdf5; /* Ø³Ø¨Ø² Ø®ÛŒÙ„ÛŒ Ø±ÙˆØ´Ù† */
      color: var(--color-success);
      border-color: #d1fae5;
  }
  .status.lose {
      background: #fef2f2; /* Ù‚Ø±Ù…Ø² Ø®ÛŒÙ„ÛŒ Ø±ÙˆØ´Ù† */
      color: var(--color-danger);
      border-color: #fecaca;
  }
  .status strong { font-weight: 700; }
  
  /* Ø¨Ø§Ú©Ø³ Ù…ÙˆØ¬ÙˆØ¯ÛŒ */
  .balance-box {
      padding: 20px;
      margin-bottom: 25px;
      background: var(--color-primary);
      color: white;
      border-radius: var(--radius-default);
  }
  .balance-box .muted {
      color: rgba(255, 255, 255, 0.7);
      font-size: 13px;
  }
  .balance-box #balance {
      font-size: 36px;
      font-weight: 700;
      margin-top: 8px;
      display: block;
      font-family: Arial, sans-serif;
  }
  
  ul {
      padding-right: 20px;
      list-style-type: 'â€” ';
      margin-top: 10px;
  }
  ul li {
      margin-bottom: 8px;
      font-size: 14px;
      line-height: 1.5;
  }
  
  .alert-box {
      margin-top: 20px;
      padding: 15px;
      border-radius: 6px;
      background: #fef2f2;
      color: var(--color-danger);
      border: 1px solid #fecaca;
      font-weight: 500;
  }

  @media (max-width:992px){
    .flex{flex-direction:column}
    .right{width:100%}
    .dice-row{grid-template-columns:repeat(3,1fr)}
  }
  
  /* Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Confetti */
  .confetti { position: fixed; inset: 0; pointer-events: none; }
  @keyframes fall{ 
      to{ transform: translateY(100vh) rotate(540deg); opacity:.4 } 
  }
</style>

</head>
<body>
  <div class="container">
    <div class="card">
      <div class="flex">
        
        <div class="col panel" id="uiArea" style="border: none; box-shadow: none;">
          
          <div id="loginScreen">
            <h1>ÙˆØ±ÙˆØ¯ Ø§Ù…Ù† Ø¨Ù‡ Ù¾Ù†Ù„ Triple Dice</h1>
            <p class="muted">Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¨Ø§Ø²ÛŒØŒ Chat ID ØªÙ„Ú¯Ø±Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ ØªØ§ Ú©Ø¯ ØªØ£ÛŒÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ùˆ Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´ÙˆØ¯.</p>
            
            <div style="margin-top:20px">
              <label for="chatIdInput">Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ ØªÙ„Ú¯Ø±Ø§Ù… (Chat ID)</label>
              <input id="chatIdInput" placeholder="Ù…Ø«Ù„Ø§Ù‹: 123456789" />
            </div>
            
            <div class="controls">
              <button id="sendCodeBtn" class="primary" style="flex: 1;">Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ (ØªÙ„Ú¯Ø±Ø§Ù…)</button>
              <button id="checkCodeBtn" class="ghost" style="flex: 1;">Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ú©Ø¯</button>
            </div>
            
            <div style="margin-top:15px">
              <label for="codeInput">Ú©Ø¯ ØªØ£ÛŒÛŒØ¯ Ø¯Ø±ÛŒØ§ÙØªÛŒ</label>
              <input id="codeInput" placeholder="Ú©Ø¯ 5 Ø±Ù‚Ù…ÛŒ Ø§Ø±Ø³Ø§Ù„ÛŒ" />
            </div>
            
            <div class="muted small" style="margin-top:15px">Ø­Ø¯Ø§Ù‚Ù„ Ø´Ø±Ø· Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ <strong>10,000 â›</strong> Ø§Ø³Øª.</div>
          </div>

          <div id="gameScreen" style="display:none">
            <h2>ğŸ² Ø¨Ø§Ø²ÛŒ Ø´Ø±Ø·â€ŒØ¨Ù†Ø¯ÛŒ Ø³Ù‡â€ŒØªØ§Ø³</h2>
            <p class="muted">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ùˆ Ø´Ø±Ø· Ø®ÙˆØ¯ Ø±Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø±Ø¯Ù‡ Ùˆ Ø¨Ø§ Ø´Ø§Ù†Ø³ Ø®ÙˆØ¯ ØªØ§Ø³ Ø¨ÛŒÙ†Ø¯Ø§Ø²ÛŒØ¯.</p>

            <div class="dice-row">
              <div class="die" id="die1"><span class="value">1</span></div>
              <div class="die" id="die2"><span class="value">1</span></div>
              <div class="die" id="die3"><span class="value">1</span></div>
            </div>

            <div style="margin-top:15px">
              <label for="betAmount">Ù…Ù‚Ø¯Ø§Ø± Ø´Ø±Ø· (Ø­Ø¯Ø§Ù‚Ù„ 10)</label>
              <input id="betAmount" type="number" min="10000" value="10000" />
            </div>
            <div class="controls">
              <button id="placeBetBtn" class="primary" style="flex: 2;">Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù† Ø´Ø±Ø· Ùˆ Ú©Ø³Ø± Ù…ÙˆØ¬ÙˆØ¯ÛŒ</button>
              <button id="rollBtn" class="ghost" disabled style="flex: 1;">ğŸ² Ø§Ù†Ø¯Ø§Ø®ØªÙ† ØªØ§Ø³</button>
            </div>

            <div id="result" class="status">Ù†ØªÛŒØ¬Ù‡: Ù‡Ù†ÙˆØ² Ø´Ø±Ø·ÛŒ Ø¨Ø³ØªÙ‡ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>
            
            <div style="margin-top:20px" class="controls">
                 <button id="logoutBtn" class="ghost" style="width: 150px;">Ø®Ø±ÙˆØ¬ Ø§Ù…Ù† Ø§Ø² Ø­Ø³Ø§Ø¨</button>
            </div>
          </div>
        </div>

        <aside class="right panel" style="background: var(--color-background); border-left: 4px solid var(--color-secondary);">
          
          <div class="balance-box">
            <div class="muted">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø­Ø³Ø§Ø¨</div>
            <span id="balance">â€” â›</span>
            <div class="muted" style="margin-top:10px;">Ø´Ù†Ø§Ø³Ù‡ Ø´Ù…Ø§: <strong id="currentChat">â€”</strong></div>
            <div class="muted" id="lastUpdate">Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: â€”</div>
            
            <div style="margin-top:15px" class="controls">
              <button id="refreshBtn" class="primary" style="flex:1;">Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ</button>
            </div>
          </div>
          
          <hr style="margin:25px 0;border:none;border-top:1px dashed var(--color-border);" />

          <div>
            <h2>ğŸ“ Ù‚ÙˆØ§Ù†ÛŒÙ† Ùˆ Ø±Ø§Ù‡Ù†Ù…Ø§</h2>
            <ul class="muted">
              <li>Û±) Ø§Ø¨ØªØ¯Ø§ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø±Ø§ Ø§Ø² Ø·Ø±ÛŒÙ‚ ØªÙ„Ú¯Ø±Ø§Ù… Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯.</li>
              <li>Û²) Ø­Ø¯Ø§Ù‚Ù„ Ø´Ø±Ø· Û±Û°Û°Û°Û° Ø§Ø³Øª. Ù…Ø¨Ù„Øº Ø´Ø±Ø· Ù‡Ù†Ú¯Ø§Ù… Â«Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù† Ø´Ø±Ø·Â» Ø§Ø² Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø´Ù…Ø§ Ú©Ø³Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯.</li>
              <li>Û³) Ø§Ú¯Ø± Ù…Ø¬Ù…ÙˆØ¹ ØªØ§Ø³â€ŒÙ‡Ø§ **Ø¨Ø²Ø±Ú¯ØªØ± Ø§Ø² Û±Û²** Ø¨Ø§Ø´Ø¯ (Û±Û³ ØªØ§ Û±Û¸)ØŒ Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ø¯Ù‡ Ùˆ Ø¯Ùˆ Ø¨Ø±Ø§Ø¨Ø± Ù…Ø¨Ù„Øº Ø´Ø±Ø· Ø¨Ù‡ Ø´Ù…Ø§ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</li>
              <li>Û´) Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±Øª (Û³ ØªØ§ Û±Û²)ØŒ Ù…Ø¨Ù„Øº Ø´Ø±Ø· Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯.</li>
            </ul>
          </div>
          
          <div class="alert-box">
             âš ï¸ **Ù‡Ø´Ø¯Ø§Ø±:** Ø¨Ø¹Ø¯ Ø§Ø² Â«Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù† Ø´Ø±Ø·Â»ØŒ Ù…Ø¨Ù„Øº ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø±Ú¯Ø´Øª Ø§Ø³Øª. Ø¨Ø§ Ù…Ø³Ø¦ÙˆÙ„ÛŒØª Ø®ÙˆØ¯ Ø§Ù‚Ø¯Ø§Ù… Ú©Ù†ÛŒØ¯.
          </div>
        </aside>
      </div>
    </div>
  </div>

  <div id="confetti" class="confetti" aria-hidden="true"></div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
    /* ---------- ØªÙ†Ø¸ÛŒÙ…Ø§Øª (Ú©Ø¯Ù‡Ø§ÛŒ JS Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ù†Ø¯) ---------- */
    // Ù…Ø§ Ø§Ø² Firebase SDK Ø¯Ø± Ú©Ù„Ø§ÛŒÙ†Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…ØŒ Ø§Ù…Ø§ Ø§ÛŒÙ† Ø®Ø·ÙˆØ· Ø±Ø§ Ø¨Ø±Ø§ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…ÛŒâ€ŒÚ¯Ø°Ø§Ø±ÛŒÙ….
    // const firebaseConfig = { ... }; 
    // firebase.initializeApp(firebaseConfig);
    // const db = firebase.firestore();
    // const auth = firebase.auth();
    // auth.signInAnonymously().catch(e=>console.warn(e)); // Ø­Ø°Ù Ø´Ø¯ Ú†ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ù†Ø§Ø´Ù†Ø§Ø³ Firebase Ù†ÛŒØ³Øª.
    
    /* ---------- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Worker (Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Firebase SDK) ---------- */
    const WORKER_URL = "https://mehrpaynoad.r8sansoltani.workers.dev/"; // Ø¢Ø¯Ø±Ø³ ÙˆØ§Ù‚Ø¹ÛŒ Worker Ø´Ù…Ø§
    const MIN_BET = 10;
    
    /**
     * ØªØ§Ø¨Ø¹ Ø¹Ù…ÙˆÙ…ÛŒ Ø¨Ø±Ø§ÛŒ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ API Worker
     */
    async function cfWorkerFetch(endpoint, data) {
      try {
        const response = await fetch(WORKER_URL + endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await response.json();
        if (response.status !== 200) {
          throw new Error(result.error || 'Unknown error');
        }
        return result;
      } catch (e) {
        console.error("Worker Fetch Error:", e);
        throw e;
      }
    }

    /* ---------- Ú©Ù…Ú©â€ŒÚ©Ù†Ù†Ø¯Ù‡â€ŒÙ‡Ø§ Ùˆ Ù…Ù†Ø·Ù‚ Ø­Ø³Ø§Ø¨ÛŒ ---------- */
    function formatDate(ts){ if(!ts) return 'â€”'; return new Date(ts).toLocaleString('fa-IR', { hour: '2-digit', minute: '2-digit', year: 'numeric', month: 'numeric', day: 'numeric' }); }
    
    /* ---------- UI Ø¹Ù†Ø§ØµØ± (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ---------- */
    const chatIdInput = document.getElementById('chatIdInput');
    const codeInput = document.getElementById('codeInput');
    const sendCodeBtn = document.getElementById('sendCodeBtn');
    const checkCodeBtn = document.getElementById('checkCodeBtn');
    const loginScreen = document.getElementById('loginScreen');
    const gameScreen = document.getElementById('gameScreen');
    const balanceEl = document.getElementById('balance');
    const lastUpdateEl = document.getElementById('lastUpdate');
    const currentChatEl = document.getElementById('currentChat');
    const placeBetBtn = document.getElementById('placeBetBtn');
    const rollBtn = document.getElementById('rollBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const betAmountInput = document.getElementById('betAmount');
    const resultEl = document.getElementById('result');
    const refreshBtn = document.getElementById('refreshBtn');

    const diceEls = [document.getElementById('die1'), document.getElementById('die2'), document.getElementById('die3')];

    let currentChatId = null;
    let pendingBet = null; // { amount }

    /* ---------- Ø§Ø±Ø³Ø§Ù„/Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯ (ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Worker) ---------- */
    sendCodeBtn.addEventListener('click', async ()=>{
      const chatId = chatIdInput.value.trim(); if(!chatId) return alert('Ø®Ø·Ø§: Chat ID Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
      try {
        sendCodeBtn.disabled = true;
        const resp = await cfWorkerFetch('api/send-code', { chatId });
        if(resp && resp.ok) alert('âœ… Ú©Ø¯ Ø§Ù…Ù†ÛŒØªÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù… Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.'); 
        else alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯. Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Chat ID ØµØ­ÛŒØ­ Ø§Ø³Øª Ùˆ Worker Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯.');
      } catch(e) {
        alert('âŒ Ø®Ø·Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø·ÛŒ Ù‡Ù†Ú¯Ø§Ù… Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯.');
      } finally {
        sendCodeBtn.disabled = false;
      }
    });

    checkCodeBtn.addEventListener('click', async ()=>{
      const chatId = chatIdInput.value.trim(); const code = codeInput.value.trim(); if(!chatId||!code) return alert('Ø®Ø·Ø§: Chat ID Ùˆ Ú©Ø¯ Ø±Ø§ Ú©Ø§Ù…Ù„ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
      try {
        checkCodeBtn.disabled = true;
        const resp = await cfWorkerFetch('api/check-code', { chatId, code });
        
        currentChatId = chatId; localStorage.setItem('natcoin_last_chat', chatId);
        showGame();
        await renderAccount(resp.balance, resp.lastUpdated); // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¨Ø±Ú¯Ø´ØªÛŒ
        alert('âœ… ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ².');
      } catch(e) {
        const msg = e.message || '';
        if(msg.includes('ERR_INVALID_CODE')) alert('Ø®Ø·Ø§: Ú©Ø¯ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.');
        else if(msg.includes('ERR_CODE_NOT_FOUND')) alert('Ø®Ø·Ø§: Ø§Ø¨ØªØ¯Ø§ Â«Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯Â» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.');
        else alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ú©Ø¯.');
      } finally {
        checkCodeBtn.disabled = false;
      }
    });

    /* ---------- Ø±Ù†Ø¯Ø± Ø­Ø³Ø§Ø¨ (ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Worker) ---------- */
    async function renderAccount(balanceFromResp, lastUpdateFromResp){ 
      if(!currentChatId){ 
        balanceEl.textContent = 'â€” â›'; 
        lastUpdateEl.textContent = 'Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: â€”'; 
        currentChatEl.textContent='â€”'; 
        return; 
      }
      
      let balance = balanceFromResp;
      let lastUpdated = lastUpdateFromResp;

      // Ø§Ú¯Ø± Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§Ø² Ù‚Ø¨Ù„ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ø¢Ù† Ø±Ø§ Ø§Ø² Worker Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ….
      if (balance === undefined) {
        try {
            const resp = await cfWorkerFetch('api/get-account', { chatId: currentChatId });
            balance = resp.balance;
            lastUpdated = resp.lastUpdated;
        } catch(e) {
            console.error('Failed to fetch account:', e);
            balanceEl.textContent = 'Ø®Ø·Ø§'; 
            lastUpdateEl.textContent = 'Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚'; 
            currentChatEl.textContent = currentChatId;
            return;
        }
      }
      
      balanceEl.textContent = Math.floor(balance).toLocaleString('fa-IR') + ' â›'; 
      lastUpdateEl.textContent = 'Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ' + formatDate(lastUpdated); 
      currentChatEl.textContent = currentChatId;
    }

    refreshBtn.addEventListener('click', async ()=>{ 
      if(!currentChatId) return alert('ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯.'); 
      await renderAccount(); 
      alert('âœ… Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.'); 
    });

    logoutBtn.addEventListener('click', ()=>{ 
      currentChatId=null; 
      localStorage.removeItem('natcoin_last_chat'); 
      showLogin(); 
      renderAccount(); 
      alert('âœ… Ø®Ø±ÙˆØ¬ Ø§Ù…Ù† Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.'); 
    });

    /* ---------- Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù† Ø´Ø±Ø· (ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Worker) ---------- */
    placeBetBtn.addEventListener('click', async ()=>{
      if(!currentChatId) return alert('Ø®Ø·Ø§: Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø´ÙˆÛŒØ¯.');
      const amt = Math.floor(Number(betAmountInput.value) || 0);
      if(amt < MIN_BET) return alert('Ø®Ø·Ø§: Ø­Ø¯Ø§Ù‚Ù„ Ø´Ø±Ø· '+MIN_BET.toLocaleString()+' â› Ø§Ø³Øª.');
      try{
        placeBetBtn.disabled = true;
        const resp = await cfWorkerFetch('api/place-bet', { chatId: currentChatId, amount: amt });
        
        pendingBet = { amount: amt };
        resultEl.textContent = `Ø´Ø±Ø· Ú¯Ø°Ø§Ø´ØªÙ‡ Ø´Ø¯: ${amt.toLocaleString('fa-IR')} â› â€” Ø­Ø§Ù„Ø§ ØªØ§Ø³ Ø±Ø§ Ø¨ÛŒÙ†Ø¯Ø§Ø²ÛŒØ¯.`;
        resultEl.classList.remove('win', 'lose');
        rollBtn.disabled = false; await renderAccount(resp.newBalance, Date.now()); // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø³Ø±ÛŒØ¹ Ù…ÙˆØ¬ÙˆØ¯ÛŒ
      }catch(err){ 
        const msg = err.message || '';
        if(msg.includes('ERR_INSUFFICIENT_FUNDS')) alert('Ø®Ø·Ø§: Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª.'); 
        else { console.error(err); alert('âŒ Ø®Ø·Ø§ Ù‡Ù†Ú¯Ø§Ù… Ø«Ø¨Øª Ø´Ø±Ø·.'); } 
      } finally {
        placeBetBtn.disabled = false;
      }
    });

    /* ---------- Ø§Ù†Ø¯Ø§Ø®ØªÙ† ØªØ§Ø³ (Ù…Ù†Ø·Ù‚ Ø¨Ø§Ø²ÛŒ) ---------- */
    function rand(){ return Math.floor(Math.random()*6)+1 }
    function animateDice(){ 
        diceEls.forEach(d=>{ 
            d.classList.add('shaking'); 
            setTimeout(() => d.classList.remove('shaking'), 800);
        }); 
    }
    // ... ØªØ§Ø¨Ø¹ makeConfetti Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± ...
    function makeConfetti(){ 
      const conf = document.getElementById('confetti'); 
      for(let i=0;i<40;i++){ 
          const piece = document.createElement('i'); 
          piece.style.left = Math.random()*100 + 'vw'; 
          piece.style.top = '-10px'; 
          piece.style.width = (6+Math.random()*10)+'px'; 
          piece.style.height = (8+Math.random()*10)+'px'; 
          piece.style.background = `hsl(${Math.floor(Math.random()*360)} 90% 60%)`; 
          piece.style.position='absolute'; 
          piece.style.opacity='0.95'; 
          piece.style.transform=`rotate(${Math.random()*360}deg)`; 
          piece.style.animation='fall 1200ms linear forwards'; 
          conf.appendChild(piece); 
          setTimeout(()=>piece.remove(),1600); 
      } 
    }


    rollBtn.addEventListener('click', async ()=>{
      if(!pendingBet) return alert('Ø®Ø·Ø§: Ø§Ø¨ØªØ¯Ø§ Ø´Ø±Ø· Ø±Ø§ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯.');
      rollBtn.disabled = true;
      animateDice();
      
      setTimeout(async ()=>{
        const vals = [rand(),rand(),rand()];
        vals.forEach((v,i)=>{ diceEls[i].querySelector('.value').textContent = v; });
        const total = vals.reduce((a,b)=>a+b,0);
        const win = total > 12;
        const stake = pendingBet.amount; pendingBet = null;
        placeBetBtn.disabled = false;
        
        if(win){
          const winAmount = stake*2; // Ø¯Ùˆ Ø¨Ø±Ø§Ø¨Ø± Ù…Ø¨Ù„Øº Ø´Ø±Ø·
          try{
            // ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Worker Ø¨Ø±Ø§ÛŒ Ø§ÙØ²Ø§ÛŒØ´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ
            const resp = await cfWorkerFetch('api/roll-win', { chatId: currentChatId, winAmount });
            resultEl.textContent = `ğŸ‰ **Ø¨Ø±Ø¯!** ØªØ§Ø³â€ŒÙ‡Ø§: ${vals.join(' â€¢ ')} (Ø¬Ù…Ø¹: ${total}) â€” Ø¬Ø§ÛŒØ²Ù‡: ${ winAmount.toLocaleString('fa-IR') } â› Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.`;
            resultEl.classList.remove('lose');
            resultEl.classList.add('win');
            makeConfetti();
            await renderAccount(resp.newBalance, Date.now());
          }catch(e){
            console.error(e); 
            resultEl.textContent = `âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø­Ø³Ø§Ø¨: Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.`;
            resultEl.classList.remove('win', 'lose');
          }
        } else {
          // Ø¯Ø± ØµÙˆØ±Øª Ø¨Ø§Ø®ØªØŒ Ù…Ø¨Ù„Øº Ø´Ø±Ø· Ù‚Ø¨Ù„Ø§Ù‹ ØªÙˆØ³Ø· placeBet Ú©Ø³Ø± Ø´Ø¯Ù‡ Ø§Ø³Øª.
          resultEl.textContent = `ğŸ˜” **Ø¨Ø§Ø®Øª.** ØªØ§Ø³â€ŒÙ‡Ø§: ${vals.join(' â€¢ ')} (Ø¬Ù…Ø¹: ${total}) â€” Ù…Ø¨Ù„Øº ${stake.toLocaleString('fa-IR')} â› Ø§Ø² Ø¯Ø³Øª Ø±ÙØª.`;
          resultEl.classList.remove('win');
          resultEl.classList.add('lose');
          await renderAccount(); // ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø±ÙØ±Ø´ Ù…Ø¹Ù…ÙˆÙ„ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ
        }
      }, 800);
    });

    /* ---------- ÛŒÚ©â€ŒØ¨Ø§Ø± Ø§Ø¬Ø±Ø§: Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ localStorage Ùˆ init ---------- */
    (async function init(){
      const last = localStorage.getItem('natcoin_last_chat'); if(last) chatIdInput.value = last;
      if(localStorage.getItem('natcoin_last_chat')){
        currentChatId = localStorage.getItem('natcoin_last_chat');
        try{ await renderAccount(); showGame(); }catch(e){ showLogin(); }
      } else {
        showLogin();
      }
    })();

    function showGame(){ 
        loginScreen.style.display='none'; 
        gameScreen.style.display='block'; 
        placeBetBtn.disabled=false; 
        rollBtn.disabled=true;
    }
    function showLogin(){ 
        loginScreen.style.display='block'; 
        gameScreen.style.display='none'; 
        pendingBet = null;
    }
    
  </script>
</body>
</html>
</body>
</html>

