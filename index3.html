<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Triple Dice Roller — پنل شرط‌بندی</title>
  
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />

<style>
  /* ---------------------- طراحی حرفه‌ای فین‌تک (بانکداری مدرن) ---------------------- */
  :root {
    --color-primary: #002d62;       /* آبی تیره سلطنتی (Navy Blue) */
    --color-secondary: #004a99;     /* آبی اصلی برای دکمه‌ها و هایلایت */
    --color-text: #1f2937;          /* خاکستری ذغالی تیره برای متن اصلی */
    --color-muted: #6b7280;         /* خاکستری متوسط برای متن‌های کمکی */
    --color-background: #f8f9fa;    /* پس‌زمینه خیلی روشن */
    --color-card-bg: #ffffff;       /* پس‌زمینه کارت سفید خالص */
    --color-border: #e5e7eb;        /* خطوط جداکننده نازک */
    --color-success: #16a34a;       /* سبز تایید */
    --color-danger: #dc2626;        /* قرمز هشدار */
    --radius-default: 8px;          /* شعاع گوشه‌ها */
    --shadow-main: 0 10px 30px rgba(0, 0, 0, 0.05);
  }

  * {
    box-sizing: border-box;
    font-family: 'Vazirmatn', Tahoma, Arial, 'Segoe UI', system-ui, sans-serif;
  }

  body {
    margin: 0;
    font-family: 'Vazirmatn', system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
    background-color: var(--color-background);
    min-height: 100vh;
    color: var(--color-text);
    display: grid;
    place-items: center;
    padding: 40px 20px;
    direction: rtl;
  }

  .container { width: min(100%, 1150px); }

  .card {
    background: var(--color-card-bg);
    border-radius: var(--radius-default);
    padding: 25px;
    border: 1px solid var(--color-border);
    box-shadow: var(--shadow-main);
  }
  
  h1 { 
      margin: 0 0 10px 0; 
      font-size: 24px; 
      color: var(--color-primary); 
      font-weight: 700; 
      padding-bottom: 5px;
  }
  h2 {
      font-size: 18px;
      font-weight: 600;
      color: var(--color-text);
      margin: 0 0 15px 0;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--color-border);
  }

  .flex { display: flex; gap: 30px; }
  .col { flex: 1; }

  .panel {
    padding: 25px;
    border-radius: var(--radius-default);
    background: var(--color-card-bg);
    border: 1px solid var(--color-border);
  }
  
  /* بازنویسی برای ورودی‌ها */
  label { 
      display: block; 
      color: var(--color-text); 
      font-size: 14px; 
      font-weight: 500;
      margin-bottom: 8px; 
  }

  input, button, textarea {
    width: 100%;
    padding: 13px 15px; 
    border-radius: 6px;
    border: 1px solid var(--color-border);
    background: var(--color-background);
    color: var(--color-text);
    font-size: 16px;
    transition: all 0.2s ease;
  }
  input:focus, textarea:focus {
    border-color: var(--color-secondary);
    outline: none;
    box-shadow: 0 0 0 3px rgba(0, 74, 153, 0.1); 
  }

  .muted { color: var(--color-muted); font-size: 14px; line-height: 1.6; }

  .dice-row { 
      display: grid; 
      grid-template-columns: repeat(3,1fr); 
      gap: 20px; 
      margin: 25px 0;
  }

  /* تاس‌ها - ظاهر شیشه‌ای/مدرن با رنگ رسمی */
  .die {
    aspect-ratio: 1;
    border-radius: var(--radius-default);
    background: var(--color-background);
    border: 1px solid var(--color-border);
    display: grid;
    place-items: center;
    font-weight: 700;
    font-size: 48px;
    color: var(--color-primary);
    box-shadow: 0 5px 15px rgba(0,0,0,.08);
  }
  
  /* انیمیشن لرزش تاس */
  @keyframes shake {
      0% { transform: translate(1px, 1px) rotate(0deg); }
      10% { transform: translate(-1px, -2px) rotate(-1deg); }
      20% { transform: translate(-3px, 0px) rotate(1deg); }
      30% { transform: translate(3px, 2px) rotate(0deg); }
      40% { transform: translate(1px, -1px) rotate(1deg); }
      50% { transform: translate(-1px, 2px) rotate(-1deg); }
      60% { transform: translate(-3px, 1px) rotate(0deg); }
      70% { transform: translate(3px, 1px) rotate(-1deg); }
      80% { transform: translate(-1px, -1px) rotate(1deg); }
      90% { transform: translate(1px, 2px) rotate(0deg); }
      100% { transform: translate(1px, -2px) rotate(-1deg); }
  }
  .shaking .value {
    animation: shake 0.1s infinite;
  }

  .controls { display: flex; gap: 15px; margin-top: 15px; }

  /* دکمه اصلی (آبی) */
  button.primary {
    background: var(--color-secondary);
    color: #fff;
    border: 0;
    padding: 13px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color .2s ease;
  }
  button.primary:hover { background: var(--color-primary); }
  button.primary:disabled { opacity: 0.7; cursor: not-allowed; }

  /* دکمه ثانویه (Ghost) */
  button.ghost {
    background: transparent;
    border: 1px solid var(--color-border);
    color: var(--color-text);
    cursor: pointer;
    padding: 13px;
    border-radius: 6px;
    transition: background .2s;
  }
  button.ghost:hover { background: var(--color-background); }

  .right { width: 380px; }
  
  /* استاتوس / نتیجه شرط‌بندی */
  .status {
    margin-top: 20px;
    padding: 15px;
    border-radius: 6px;
    font-size: 15px;
    font-weight: 500;
    border: 1px solid var(--color-border);
    background: var(--color-background);
  }
  .status.win {
      background: #ecfdf5; /* سبز خیلی روشن */
      color: var(--color-success);
      border-color: #d1fae5;
  }
  .status.lose {
      background: #fef2f2; /* قرمز خیلی روشن */
      color: var(--color-danger);
      border-color: #fecaca;
  }
  .status strong { font-weight: 700; }
  
  /* باکس موجودی */
  .balance-box {
      padding: 20px;
      margin-bottom: 25px;
      background: var(--color-primary);
      color: white;
      border-radius: var(--radius-default);
  }
  .balance-box .muted {
      color: rgba(255, 255, 255, 0.7);
      font-size: 13px;
  }
  .balance-box #balance {
      font-size: 36px;
      font-weight: 700;
      margin-top: 8px;
      display: block;
      font-family: Arial, sans-serif;
  }
  
  ul {
      padding-right: 20px;
      list-style-type: '— ';
      margin-top: 10px;
  }
  ul li {
      margin-bottom: 8px;
      font-size: 14px;
      line-height: 1.5;
  }
  
  .alert-box {
      margin-top: 20px;
      padding: 15px;
      border-radius: 6px;
      background: #fef2f2;
      color: var(--color-danger);
      border: 1px solid #fecaca;
      font-weight: 500;
  }

  @media (max-width:992px){
    .flex{flex-direction:column}
    .right{width:100%}
    .dice-row{grid-template-columns:repeat(3,1fr)}
  }
  
  /* انیمیشن Confetti */
  .confetti { position: fixed; inset: 0; pointer-events: none; }
  @keyframes fall{ 
      to{ transform: translateY(100vh) rotate(540deg); opacity:.4 } 
  }
</style>

</head>
<body>
  <div class="container">
    <div class="card">
      <div class="flex">
        
        <div class="col panel" id="uiArea" style="border: none; box-shadow: none;">
          
          <div id="loginScreen">
            <h1>ورود امن به پنل Triple Dice</h1>
            <p class="muted">برای دسترسی به بازی، Chat ID تلگرام خود را وارد کنید تا کد تأیید برای شما ارسال و حساب شما بارگذاری شود.</p>
            
            <div style="margin-top:20px">
              <label for="chatIdInput">شناسه کاربری تلگرام (Chat ID)</label>
              <input id="chatIdInput" placeholder="مثلاً: 123456789" />
            </div>
            
            <div class="controls">
              <button id="sendCodeBtn" class="primary" style="flex: 1;">ارسال کد (تلگرام)</button>
              <button id="checkCodeBtn" class="ghost" style="flex: 1;">اعتبارسنجی کد</button>
            </div>
            
            <div style="margin-top:15px">
              <label for="codeInput">کد تأیید دریافتی</label>
              <input id="codeInput" placeholder="کد 5 رقمی ارسالی" />
            </div>
            
            <div class="muted small" style="margin-top:15px">حداقل شرط برای شروع بازی <strong>10,000 ⛁</strong> است.</div>
          </div>

          <div id="gameScreen" style="display:none">
            <h2>🎲 بازی شرط‌بندی سه‌تاس</h2>
            <p class="muted">موجودی و شرط خود را مدیریت کرده و با شانس خود تاس بیندازید.</p>

            <div class="dice-row">
              <div class="die" id="die1"><span class="value">1</span></div>
              <div class="die" id="die2"><span class="value">1</span></div>
              <div class="die" id="die3"><span class="value">1</span></div>
            </div>

            <div style="margin-top:15px">
              <label for="betAmount">مقدار شرط (حداقل 10,000)</label>
              <input id="betAmount" type="number" min="10000" value="10000" />
            </div>
            <div class="controls">
              <button id="placeBetBtn" class="primary" style="flex: 2;">قرار دادن شرط و کسر موجودی</button>
              <button id="rollBtn" class="ghost" disabled style="flex: 1;">🎲 انداختن تاس</button>
            </div>

            <div id="result" class="status">نتیجه: هنوز شرطی بسته نشده است.</div>
            
            <div style="margin-top:20px" class="controls">
                 <button id="logoutBtn" class="ghost" style="width: 150px;">خروج امن از حساب</button>
            </div>
          </div>
        </div>

        <aside class="right panel" style="background: var(--color-background); border-left: 4px solid var(--color-secondary);">
          
          <div class="balance-box">
            <div class="muted">موجودی لحظه‌ای حساب</div>
            <span id="balance">— ⛁</span>
            <div class="muted" style="margin-top:10px;">شناسه شما: <strong id="currentChat">—</strong></div>
            <div class="muted" id="lastUpdate">آخرین بروزرسانی: —</div>
            
            <div style="margin-top:15px" class="controls">
              <button id="refreshBtn" class="primary" style="flex:1;">بروزرسانی موجودی</button>
            </div>
          </div>
          
          <hr style="margin:25px 0;border:none;border-top:1px dashed var(--color-border);" />

          <div>
            <h2>📝 قوانین و راهنما</h2>
            <ul class="muted">
              <li>۱) ابتدا احراز هویت را از طریق تلگرام انجام دهید.</li>
              <li>۲) حداقل شرط ۱۰۰۰۰ است. مبلغ شرط هنگام «قرار دادن شرط» از موجودی شما کسر می‌شود.</li>
              <li>۳) اگر مجموع تاس‌ها **بزرگتر از ۱۲** باشد (۱۳ تا ۱۸)، برنده شده و دو برابر مبلغ شرط به شما بازگردانده می‌شود.</li>
              <li>۴) در غیر این صورت (۳ تا ۱۲)، مبلغ شرط حذف می‌شود.</li>
            </ul>
          </div>
          
          <div class="alert-box">
             ⚠️ **هشدار:** بعد از «قرار دادن شرط»، مبلغ غیرقابل برگشت است. با مسئولیت خود اقدام کنید.
          </div>
        </aside>
      </div>
    </div>
  </div>

  <div id="confetti" class="confetti" aria-hidden="true"></div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script>
    /* ---------- تنظیمات (کدهای JS بدون تغییر باقی می‌مانند) ---------- */
    const XOR_KEY = 'rasan_key_42';
    const ENCODED_TOKEN_XOR = 'RVhEWVZnU1NNaA5zMyQ9CA0uBAM0JWFnGy5KU11uXDIjG25iNBtGNiI8WjQBKA==';

    function base64Decode(s){ try{ return atob(s); }catch(e){ return null; } }
    function xorString(str, key){ let out=''; for(let i=0;i<str.length;i++){ out += String.fromCharCode(str.charCodeAt(i) ^ key.charCodeAt(i % key.length)); } return out; }
    function getBotToken(){ const step1 = base64Decode(ENCODED_TOKEN_XOR); if(!step1) return null; return xorString(step1, XOR_KEY); }

    async function sendTelegramMessage(chatId, text){
      const token = getBotToken();
      if(!token) { console.error('token decode failed'); return { ok:false, error:'token decode failed' } }
      const url = `https://api.telegram.org/bot${encodeURIComponent(token)}/sendMessage`;
      try{
        const res = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ chat_id: chatId, text }) });
        const data = await res.json(); return data;
      }catch(err){ return { ok:false, error: err.message } }
    }

    /* ---------- Firebase config ---------- */
    const firebaseConfig = {
      apiKey: "AIzaSyBiHkCAzkTzUO7weLsKGXc917JNob-dhO4",
      authDomain: "rasancoin.firebaseapp.com",
      projectId: "rasancoin",
      storageBucket: "rasancoin.firebasestorage.app",
      messagingSenderId: "289625483659",
      appId: "1:289625483659:web:b7e170072cf09a7157678e",
      measurementId: "G-KNNM4FF9MS"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    auth.signInAnonymously().catch(e=>console.warn(e));

    /* ---------- کمک‌کننده‌ها و منطق حسابی ---------- */
    const MIN_BET = 10000;
    function genCode(){ return Math.floor(10000 + Math.random()*90000).toString() }
    function formatDate(ts){ if(!ts) return '—'; return new Date(ts).toLocaleString('fa-IR', { hour: '2-digit', minute: '2-digit', year: 'numeric', month: 'numeric', day: 'numeric' }); }

    async function getUser(chatId){ const doc = await db.collection('users').doc(chatId).get(); return doc.exists ? doc.data() : null }
    async function setUser(chatId, userObj){ await db.collection('users').doc(chatId).set(userObj, { merge:true }) }

    async function accrueFor(user){ const now = Date.now(); if(!user.lastUpdated){ user.lastUpdated = now; return; } const elapsed = now - user.lastUpdated; const coins = elapsed / 3600000 * 10;
      user.balance = (user.balance||0) + coins; user.lastUpdated = now; }

    /* ---------- UI عناصر ---------- */
    const chatIdInput = document.getElementById('chatIdInput');
    const codeInput = document.getElementById('codeInput');
    const sendCodeBtn = document.getElementById('sendCodeBtn');
    const checkCodeBtn = document.getElementById('checkCodeBtn');
    const loginScreen = document.getElementById('loginScreen');
    const gameScreen = document.getElementById('gameScreen');
    const balanceEl = document.getElementById('balance');
    const lastUpdateEl = document.getElementById('lastUpdate');
    const currentChatEl = document.getElementById('currentChat');
    const placeBetBtn = document.getElementById('placeBetBtn');
    const rollBtn = document.getElementById('rollBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const betAmountInput = document.getElementById('betAmount');
    const resultEl = document.getElementById('result');
    const refreshBtn = document.getElementById('refreshBtn');
    // const exportBtn = document.getElementById('exportBtn'); // حذف شد

    const diceEls = [document.getElementById('die1'), document.getElementById('die2'), document.getElementById('die3')];

    let currentChatId = null;
    let pendingBet = null; // { amount }

    /* ---------- ارسال/دریافت کد ---------- */
    sendCodeBtn.addEventListener('click', async ()=>{
      const chatId = chatIdInput.value.trim(); if(!chatId) return alert('خطا: Chat ID را وارد کنید.');
      const code = genCode();
      await db.collection('codes').doc(chatId).set({ code, created: Date.now() });
      const text = `کد ورود شما: ${code}\n(Mahr coin)`;
      const resp = await sendTelegramMessage(chatId, text);
      if(resp && resp.ok) alert('✅ کد امنیتی با موفقیت به تلگرام شما ارسال شد.'); 
      else alert('❌ خطا در ارسال کد. مطمئن شوید Chat ID صحیح است.');
    });

    checkCodeBtn.addEventListener('click', async ()=>{
      const chatId = chatIdInput.value.trim(); const code = codeInput.value.trim(); if(!chatId||!code) return alert('خطا: Chat ID و کد را کامل وارد کنید.');
      const snap = await db.collection('codes').doc(chatId).get(); if(!snap.exists) return alert('خطا: ابتدا «ارسال کد» را بزنید.');
      const e = snap.data(); if(e.code !== code) return alert('خطا: کد اشتباه است.');

      let u = await getUser(chatId);
      if(!u) u = { balance:0, lastUpdated: Date.now() };
      await setUser(chatId, u);
      await db.collection('codes').doc(chatId).delete();
      currentChatId = chatId; localStorage.setItem('natcoin_last_chat', chatId);
      showGame(); await renderAccount();
      alert('✅ ورود موفقیت‌آمیز.');
    });

    /* ---------- رندر حساب ---------- */
    async function renderAccount(){ 
        if(!currentChatId){ 
            balanceEl.textContent = '— ⛁'; 
            lastUpdateEl.textContent = 'آخرین بروزرسانی: —'; 
            currentChatEl.textContent='—'; 
            return; 
        }
        let u = await getUser(currentChatId); 
        if(!u) u = { balance:0, lastUpdated: Date.now() };
        await accrueFor(u); await setUser(currentChatId, u);
        
        balanceEl.textContent = Math.floor(u.balance).toLocaleString('fa-IR') + ' ⛁'; 
        lastUpdateEl.textContent = 'آخرین بروزرسانی: ' + formatDate(u.lastUpdated); 
        currentChatEl.textContent = currentChatId;
    }

    refreshBtn.addEventListener('click', async ()=>{ if(!currentChatId) return alert('وارد نشده‌اید.'); await renderAccount(); alert('✅ موجودی به‌روزرسانی شد.'); });

    logoutBtn.addEventListener('click', ()=>{ 
        currentChatId=null; 
        localStorage.removeItem('natcoin_last_chat'); 
        showLogin(); 
        renderAccount(); 
        alert('✅ خروج امن انجام شد.'); 
    });

    /* ---------- قرار دادن شرط (Transaction) ---------- */
    placeBetBtn.addEventListener('click', async ()=>{
      if(!currentChatId) return alert('خطا: ابتدا وارد حساب کاربری شوید.');
      const amt = Math.floor(Number(betAmountInput.value) || 0);
      if(amt < MIN_BET) return alert('خطا: حداقل شرط '+MIN_BET.toLocaleString()+' ⛁ است.');
      try{
        const userRef = db.collection('users').doc(currentChatId);
        await db.runTransaction(async (tx)=>{
          const doc = await tx.get(userRef);
          if(!doc.exists) throw 'حساب یافت نشد';
          const data = doc.data(); await accrueFor(data);
          if((data.balance||0) < amt) throw 'moneynot';
          data.balance = (data.balance||0) - amt; data.lastUpdated = Date.now();
          tx.update(userRef, { balance: data.balance, lastUpdated: data.lastUpdated });
        });
        pendingBet = { amount: amt };
        resultEl.textContent = `شرط گذاشته شد: ${amt.toLocaleString('fa-IR')} ⛁ — حالا تاس را بیندازید.`;
        resultEl.classList.remove('win', 'lose');
        rollBtn.disabled = false; placeBetBtn.disabled = true; await renderAccount();
      }catch(err){ 
          if(err==='moneynot') alert('خطا: موجودی کافی نیست.'); 
          else { console.error(err); alert('❌ خطا هنگام ثبت شرط.'); } 
      }
    });

    /* ---------- انداختن تاس ---------- */
    function rand(){ return Math.floor(Math.random()*6)+1 }
    function animateDice(){ 
        diceEls.forEach(d=>{ 
            d.classList.add('shaking'); 
            setTimeout(() => d.classList.remove('shaking'), 800); // حذف کلاس پس از انیمیشن
        }); 
    }
    function makeConfetti(){ 
        const conf = document.getElementById('confetti'); 
        for(let i=0;i<40;i++){ 
            const piece = document.createElement('i'); 
            piece.style.left = Math.random()*100 + 'vw'; 
            piece.style.top = '-10px'; 
            piece.style.width = (6+Math.random()*10)+'px'; 
            piece.style.height = (8+Math.random()*10)+'px'; 
            piece.style.background = `hsl(${Math.floor(Math.random()*360)} 90% 60%)`; 
            piece.style.position='absolute'; 
            piece.style.opacity='0.95'; 
            piece.style.transform=`rotate(${Math.random()*360}deg)`; 
            piece.style.animation='fall 1200ms linear forwards'; 
            conf.appendChild(piece); 
            setTimeout(()=>piece.remove(),1600); 
        } 
    }

    rollBtn.addEventListener('click', async ()=>{
      if(!pendingBet) return alert('خطا: ابتدا شرط را قرار دهید.');
      rollBtn.disabled = true;
      animateDice();
      
      setTimeout(async ()=>{
        const vals = [rand(),rand(),rand()];
        vals.forEach((v,i)=>{ diceEls[i].querySelector('.value').textContent = v; });
        const total = vals.reduce((a,b)=>a+b,0);
        const win = total > 12;
        const stake = pendingBet.amount; pendingBet = null;
        placeBetBtn.disabled = false;
        
        try{
          const userRef = db.collection('users').doc(currentChatId);
          if(win){
            const winAmount = stake*2;
            await db.runTransaction(async (tx)=>{
              const doc = await tx.get(userRef);
              const data = doc.exists ? doc.data() : { balance:0, lastUpdated: Date.now() };
              await accrueFor(data);
              data.balance = (data.balance||0) + winAmount;
              data.lastUpdated = Date.now();
              tx.set(userRef, data, { merge:true });
            });
            resultEl.textContent = `🎉 **برد!** تاس‌ها: ${vals.join(' • ')} (جمع: ${total}) — جایزه: ${ winAmount.toLocaleString('fa-IR') } ⛁ اضافه شد.`;
            resultEl.classList.remove('lose');
            resultEl.classList.add('win');
            makeConfetti();
          } else {
            resultEl.textContent = `😔 **باخت.** تاس‌ها: ${vals.join(' • ')} (جمع: ${total}) — مبلغ ${stake.toLocaleString('fa-IR')} ⛁ از دست رفت.`;
            resultEl.classList.remove('win');
            resultEl.classList.add('lose');
          }
        }catch(e){ 
            console.error(e); 
            resultEl.textContent = `❌ خطا در به‌روزرسانی حساب: لطفاً دوباره تلاش کنید.`;
            resultEl.classList.remove('win', 'lose');
        }
        await renderAccount();
      }, 800);
    });

    /* ---------- یک‌بار اجرا: بازیابی localStorage و init ---------- */
    (async function init(){
      const last = localStorage.getItem('natcoin_last_chat'); if(last) chatIdInput.value = last;
      if(localStorage.getItem('natcoin_last_chat')){
        currentChatId = localStorage.getItem('natcoin_last_chat');
        try{ await renderAccount(); showGame(); }catch(e){ showLogin(); }
      } else {
        showLogin();
      }
    })();

    function showGame(){ 
        loginScreen.style.display='none'; 
        gameScreen.style.display='block'; 
        placeBetBtn.disabled=false; 
        rollBtn.disabled=true;
    }
    function showLogin(){ 
        loginScreen.style.display='block'; 
        gameScreen.style.display='none'; 
        pendingBet = null;
    }
    
    // کدهای مربوط به exportBtn حذف شدند.
  </script>
</body>
</html>