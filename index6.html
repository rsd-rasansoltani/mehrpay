<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mahr â€” Ú©Ø§Ø±Øªâ€ŒØ®ÙˆØ§Ù† (ØªÚ©â€ŒØµÙØ­Ù‡â€ŒØ§ÛŒ)</title>

  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />

  <style>
    /* ---------------------- Ø·Ø±Ø§Ø­ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ ÙÛŒÙ†â€ŒØªÚ© (Ø¨Ø§Ù†Ú©Ø¯Ø§Ø±ÛŒ Ù…Ø¯Ø±Ù†) ---------------------- */
    :root {
      --color-primary: #002d62;       /* Ø¢Ø¨ÛŒ ØªÛŒØ±Ù‡ Ø³Ù„Ø·Ù†ØªÛŒ (Navy Blue) */
      --color-secondary: #004a99;     /* Ø¢Ø¨ÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ùˆ Ù‡Ø§ÛŒÙ„Ø§ÛŒØª */
      --color-text: #1f2937;          /* Ø®Ø§Ú©Ø³ØªØ±ÛŒ Ø°ØºØ§Ù„ÛŒ ØªÛŒØ±Ù‡ Ø¨Ø±Ø§ÛŒ Ù…ØªÙ† Ø§ØµÙ„ÛŒ */
      --color-muted: #6b7280;         /* Ø®Ø§Ú©Ø³ØªØ±ÛŒ Ù…ØªÙˆØ³Ø· Ø¨Ø±Ø§ÛŒ Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ */
      --color-background: #f8f9fa;    /* Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø®ÛŒÙ„ÛŒ Ø±ÙˆØ´Ù† */
      --color-card-bg: #ffffff;       /* Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ú©Ø§Ø±Øª Ø³ÙÛŒØ¯ Ø®Ø§Ù„Øµ */
      --color-border: #e5e7eb;        /* Ø®Ø·ÙˆØ· Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ Ù†Ø§Ø²Ú© */
      --color-success: #16a34a;       /* Ø³Ø¨Ø² ØªØ§ÛŒÛŒØ¯ */
      --color-danger: #dc2626;        /* Ù‚Ø±Ù…Ø² Ù‡Ø´Ø¯Ø§Ø± */
      --color-cancel: #e74c3c;        /* Ù‚Ø±Ù…Ø² Ù„ØºÙˆ */
      --radius-default: 8px;          /* Ø´Ø¹Ø§Ø¹ Ú¯ÙˆØ´Ù‡â€ŒÙ‡Ø§ */
      --shadow-main: 0 10px 30px rgba(0, 0, 0, 0.05);
      --color-finish: #667eea;
    }

    * {
      box-sizing: border-box;
      font-family: 'Vazirmatn', Tahoma, Arial, 'Segoe UI', system-ui, sans-serif;
      direction: rtl;
    }

    html, body { height: 100%; }

    body {
      margin: 0;
      background-color: var(--color-background);
      color: var(--color-text);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container { width: 100%; max-width: 550px; }

    .card {
      background: var(--color-card-bg);
      padding: 25px;
      border-radius: var(--radius-default);
      box-shadow: var(--shadow-main);
      border: 1px solid var(--color-border);
    }

    h1 {
      margin: 0 0 10px;
      font-size: 24px;
      color: var(--color-primary);
      font-weight: 700;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--color-border);
    }
    
    h2 {
        font-size: 20px;
        font-weight: 600;
        color: var(--color-text);
        margin: 0 0 15px 0;
    }

    /* ÙØ±Ù… Ùˆ Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ */
    label {
      display: block;
      color: var(--color-text);
      font-size: 14px;
      font-weight: 500;
      margin-top: 15px;
      margin-bottom: 8px;
    }

    input, button, select {
      width: 100%;
      padding: 13px 15px;
      border-radius: 6px;
      font-size: 16px;
      transition: all 0.2s ease;
      margin-top: 0;
    }
    
    input, select {
      border: 1px solid var(--color-border);
      background: var(--color-background);
      color: var(--color-text);
    }
    input:focus, select:focus {
      border-color: var(--color-secondary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 74, 153, 0.1);
    }

    .btn {
      background: var(--color-secondary);
      color: #fff;
      border: 0;
      cursor: pointer;
      font-weight: 600;
      margin-top: 10px;
      transition: background-color .2s ease;
    }
    .btn:hover:not(:disabled) { background: var(--color-primary); }
    .btn:disabled { opacity: 0.7; cursor: not-allowed; }
    
    /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø®Ø§Øµ */
    #cancelTx { background: var(--color-cancel); }
    #cancelTx:hover { background: #a33227; }
    #finishBtn { background: var(--color-finish); }
    #finishBtn:hover { background: #556ee6; }
    
    .muted { color: var(--color-muted); font-size: 14px; line-height: 1.6; }
    .small { font-size: 13px; color: var(--color-muted); line-height: 1.5; }

    /* Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø¯ÙˆØ±Ø¨ÛŒÙ† */
    #preview {
      width: 100%;
      height: 250px;
      border-radius: var(--radius-default);
      overflow: hidden;
      background: #eee;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 15px;
      border: 1px solid var(--color-border);
    }

    .row { display: flex; gap: 10px; margin-top: 15px; }
    .col { flex: 1; }
    
    /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¨Ø®Ø´ ØªØ±Ø§Ú©Ù†Ø´ */
    .hidden { display: none; }
    .mask {
      background: #e0e7ff; /* Ø¢Ø¨ÛŒ Ø±ÙˆØ´Ù† Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ú©Ø³ Ú©Ø§Ø±Øª */
      color: var(--color-primary);
      padding: 12px;
      border-radius: 6px;
      font-weight: 600;
      font-family: monospace;
      font-size: 18px;
      border: 1px solid #c7d2fe;
    }

    /* Ø®Ù„Ø§ØµÙ‡ */
    .summary {
      padding: 20px;
      border-radius: var(--radius-default);
      background: #f0fdf4; /* Ø³Ø¨Ø² Ø®ÛŒÙ„ÛŒ Ø±ÙˆØ´Ù† Ø¨Ø±Ø§ÛŒ Ù…ÙˆÙÙ‚ÛŒØª */
      border: 1px solid #dcfce7;
      line-height: 2.0;
    }
    .summary strong { color: var(--color-primary); font-weight: 700; }
    
    .summary div {
        border-bottom: 1px dashed #e5e7eb;
        padding-bottom: 4px;
        margin-bottom: 4px;
    }
    .summary div:last-of-type { border-bottom: none; }

    /* Ø§Ø³ØªØ§ØªÙˆØ³ */
    .ok { color: var(--color-success); font-weight: 600; }
    .err { color: var(--color-danger); font-weight: 600; }

    @media (max-width:520px){ 
        #preview{height:200px} 
        h1{font-size:22px} 
        .row{flex-direction: column;}
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <div class="container">
    <div class="card" id="mainCard">
      <h1>ğŸ’³ Ú©Ø§Ø±Øªâ€ŒØ®ÙˆØ§Ù† (POS)</h1>

      <section id="scanSection">
        <p class="muted">Ø§Ø¨ØªØ¯Ø§ Chat ID Ù¾Ø°ÛŒØ±Ù†Ø¯Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ØŒ Ø³Ù¾Ø³ Ú©Ø§Ø±Øª/QR Ø®Ø±ÛŒØ¯Ø§Ø± Ø±Ø§ Ø§Ø³Ú©Ù† Ù†Ù…Ø§ÛŒÛŒØ¯.</p>
        
        <label for="merchantInput_scan">Chat ID Ù¾Ø°ÛŒØ±Ù†Ø¯Ù‡ (Ø­Ø³Ø§Ø¨ ÙˆØ§Ø±ÛŒØ²)</label>
        <input id="merchantInput_scan" placeholder="123456789 ÛŒØ§ @username" />

        <label for="preview">Ø§Ø³Ú©Ù† Ú©Ø§Ø±Øª (QR/Ø¨Ø§Ø±Ú©Ø¯)</label>
        <button id="scanBtn" class="btn" style="margin-top:0;">Ø´Ø±ÙˆØ¹ Ø§Ø³Ú©Ù†</button>
        <div id="preview">Ù†Ù…Ø§ÛŒØ´ Ø¯ÙˆØ±Ø¨ÛŒÙ†</div>

        <div id="scanStatus" class="small" style="margin-top:10px">Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø³Ú©Ù†...</div>
      </section>

      <section id="txSection" class="hidden">
        <p class="muted">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ø¨Ø±Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù… ØªØ±Ø§Ú©Ù†Ø´ Ø±Ø§ ØªÚ©Ù…ÛŒÙ„ Ùˆ Ù¾ÛŒÙ† Ùˆ Ú©Ø¯ ÛŒÚ©â€ŒØ¨Ø§Ø±Ù…ØµØ±Ù Ø±Ø§ ÙˆØ§Ø±Ø¯ Ù†Ù…Ø§ÛŒÛŒØ¯.</p>

        <label>Ú©Ø§Ø±Øª (Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡)</label>
        <div id="maskedCard" class="mask">â€”</div>

        <label for="merchantInput">Chat ID Ù¾Ø°ÛŒØ±Ù†Ø¯Ù‡</label>
        <input id="merchantInput" placeholder="Chat ID Ù¾Ø°ÛŒØ±Ù†Ø¯Ù‡" readonly />

        <label for="amountInput">Ù…Ø¨Ù„Øº (Ø³Ú©Ù‡ â›)</label>
        <input id="amountInput" type="number" min="1" placeholder="Ù…Ø«Ø§Ù„: 1000" />

        <label for="pinInput">PIN Ú©Ø§Ø±Øª (Ù¾Ù†Ù‡Ø§Ù†)</label>
        <input id="pinInput" type="password" placeholder="Ù¾ÛŒÙ† Û´ Ø±Ù‚Ù…ÛŒ" maxlength="4" type="tel" />

        <div class="row">
          <div class="col"><button id="sendOtpBtn" class="btn" style="margin-top:0;">Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ ÛŒÚ©â€ŒØ¨Ø§Ø±Ù…ØµØ±Ù</button></div>
          <div class="col"><button id="cancelTx" class="btn" style="margin-top:0;">Ù„ØºÙˆ ØªØ±Ø§Ú©Ù†Ø´</button></div>
        </div>

        <label for="otpInput">Ú©Ø¯ ÛŒÚ©â€ŒØ¨Ø§Ø±Ù…ØµØ±Ù</label>
        <input id="otpInput" placeholder="Ú©Ø¯ Ûµ Ø±Ù‚Ù…ÛŒ Ø§Ø±Ø³Ø§Ù„ÛŒ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…" maxlength="5" type="tel" />

        <button id="confirmBtn" class="btn">ØªØ§ÛŒÛŒØ¯ Ùˆ Ø§Ù†Ø¬Ø§Ù… ØªØ±Ø§Ú©Ù†Ø´</button>

        <div id="txStatus" class="small" style="margin-top:10px"></div>
      </section>

      <section id="summarySection" class="hidden">
        <h2>âœ… ØªØ±Ø§Ú©Ù†Ø´ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ²</h2>
        <div id="summaryBox" class="summary">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
        <div style="margin-top:20px" class="row">
          <div class="col"><button id="newPayBtn" class="btn" style="margin-top:0;">Ù¾Ø±Ø¯Ø§Ø®Øª Ø¬Ø¯ÛŒØ¯</button></div>
          <div class="col"><button id="finishBtn" class="btn" style="margin-top:0;">Ù¾Ø§ÛŒØ§Ù†</button></div>
        </div>
      </section>
    </div>
  </div>

<script>
/* --------------------------- config --------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBiHkCAzkTzUO7weLsKGXc917JNob-dhO4",
  authDomain: "rasancoin.firebaseapp.com",
  projectId: "rasancoin",
  storageBucket: "rasancoin.firebasestorage.app",
  messagingSenderId: "289625483659",
  appId: "1:289625483659:web:b7e170072cf09a7157678e",
  measurementId: "G-KNNM4FF9MS"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
auth.signInAnonymously().catch(()=>{});

/* --------------------------- helpers --------------------------- */
function maskId(id){ if(!id) return 'â€”'; const s=String(id); if(s.length>6) return s.slice(0,2)+'â€¢â€¢â€¢â€¢â€¢'+s.slice(-2); return s.replace(/.(?=.$)/g,'*'); }
function qs(name){ return new URLSearchParams(location.search).get(name); }
function genOtp(){ return Math.floor(10000+Math.random()*90000).toString(); }

/* --------------------------- hidden bot token logic --------------------------- */
const XOR_KEY = 'rasan_key_42';
const ENCODED_TOKEN_XOR = 'RVdCUl1sUlJBbw5zMyQaWR8QIxI2FwxRCi1LCCxtDhRAbVBGGA46KBptICIWKA==';
function base64Decode(s){ try{ return atob(s); }catch(e){ return null; } }
function xorString(str,key){ let out=''; for(let i=0;i<str.length;i++) out+=String.fromCharCode(str.charCodeAt(i)^key.charCodeAt(i%key.length)); return out; }
function getBotToken(){ const step1=base64Decode(ENCODED_TOKEN_XOR); if(!step1) return null; return xorString(step1,XOR_KEY); }
async function sendTelegramMessageHidden(chatId,text){ const token=getBotToken(); if(!token) return {ok:false,error:'token decode failed'}; const url=`https://api.telegram.org/bot${encodeURIComponent(token)}/sendMessage`; try{ const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({chat_id:chatId,text})}); return await res.json(); }catch(e){ return {ok:false,error:e.message}; } }

/* --------------------------- transfer logic --------------------------- */
async function transferAtomic(cardChatId, merchantChatId, amount, suppliedPin){
  const cardRef = db.collection('users').doc(String(cardChatId));
  const merchantRef = db.collection('users').doc(String(merchantChatId));
  return await db.runTransaction(async tx=>{
    const cs = await tx.get(cardRef);
    if(!cs.exists) throw 'Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Øª Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯';
    const card = cs.data();
    const ms = await tx.get(merchantRef);
    const merchant = ms.exists?ms.data():{balance:0,lastUpdated:Date.now()};
    const now = Date.now();
    
    // Accrue logic needs to be run before checking balance, but we skip it here for simplicity
    // in this transaction and rely on external updates for mining. For safety, we only check PIN and Balance.
    
    card.lastUpdated = card.lastUpdated || now; merchant.lastUpdated = merchant.lastUpdated || now;
    const pin = (card.pin?String(card.pin):'7444');
    if(String(suppliedPin) !== String(pin)) throw 'PIN Ù†Ø§Ø¯Ø±Ø³Øª';
    const bal = Number(card.balance||0);
    if(bal < amount) throw 'Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù†Ø§Ú©Ø§ÙÛŒ';
    
    // Perform transfer
    card.balance = bal - Number(amount);
    merchant.balance = (merchant.balance||0) + Number(amount);
    
    card.lastUpdated = now; merchant.lastUpdated = now;
    tx.set(cardRef, card, {merge:true});
    tx.set(merchantRef, merchant, {merge:true});
    
    const txId = (Date.now().toString(36)+Math.random().toString(36).slice(2,8));
    tx.set(db.collection('transactions').doc(txId), {from:cardChatId,to:merchantChatId,amount:Number(amount),ts:Date.now(),id:txId});
    return {txId, newCardBalance: card.balance, newMerchantBalance: merchant.balance};
  });
}

/* --------------------------- UI wiring --------------------------- */
const scanSection = document.getElementById('scanSection');
const txSection = document.getElementById('txSection');
const summarySection = document.getElementById('summarySection');
const preview = document.getElementById('preview');
const scanStatus = document.getElementById('scanStatus');
const scanBtn = document.getElementById('scanBtn');
const maskedCardEl = document.getElementById('maskedCard');
const merchantInput_scan = document.getElementById('merchantInput_scan');
const merchantInput = document.getElementById('merchantInput');
const amountInput = document.getElementById('amountInput');
const pinInput = document.getElementById('pinInput');
const sendOtpBtn = document.getElementById('sendOtpBtn');
const otpInput = document.getElementById('otpInput');
const confirmBtn = document.getElementById('confirmBtn');
const txStatus = document.getElementById('txStatus');
const cancelTx = document.getElementById('cancelTx');
const newPayBtn = document.getElementById('newPayBtn');
const finishBtn = document.getElementById('finishBtn');
const summaryBox = document.getElementById('summaryBox');

let html5QrcodeScanner = null;
let scannedCardId = null;

function showSection(s){ scanSection.classList.add('hidden'); txSection.classList.add('hidden'); summarySection.classList.add('hidden'); s.classList.remove('hidden'); }

/* --------------------------- scanning --------------------------- */
scanBtn.addEventListener('click', ()=>{
  if(html5QrcodeScanner){
      html5QrcodeScanner.stop().catch(()=>{});
      html5QrcodeScanner = null;
      scanBtn.textContent = 'Ø´Ø±ÙˆØ¹ Ø§Ø³Ú©Ù†';
      scanStatus.textContent = 'Ø§Ø³Ú©Ù† Ù…ØªÙˆÙ‚Ù Ø´Ø¯.';
      return;
  }
  
  if(!merchantInput_scan.value.trim()){
      alert('Ù„Ø·ÙØ§Ù‹ Chat ID Ù¾Ø°ÛŒØ±Ù†Ø¯Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
      return;
  }
  
  scanBtn.textContent = 'ØªÙˆÙ‚Ù Ø§Ø³Ú©Ù†';
  scanStatus.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø³Ú©Ù† â€” Ø¨Ø§Ø±Ú©Ø¯/QR Ø±Ø§ Ù†Ø²Ø¯ÛŒÚ© Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù†Ú¯Ù‡ Ø¯Ø§Ø±ÛŒØ¯...';
  
  html5QrcodeScanner = new Html5Qrcode('preview');
  html5QrcodeScanner.start({facingMode:'environment'},{fps:10,qrbox:250}, qrCodeMessage => {
    // extract chat (simple heuristics)
    let card = extractChat(qrCodeMessage)||qrCodeMessage;
    scannedCardId = card;
    maskAndOpen(card);
    html5QrcodeScanner.stop().catch(()=>{}).then(()=>{ html5QrcodeScanner = null; scanBtn.textContent = 'Ø´Ø±ÙˆØ¹ Ø§Ø³Ú©Ù†'; });
  }, err=>{ /* ignore scan errors */ }).catch(e=>{ alert('âŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¯ÙˆØ±Ø¨ÛŒÙ† ÛŒØ§ Ø§Ø³Ú©Ù† Ù…Ø´Ú©Ù„ Ø¯Ø§Ø±Ø¯: '+e); });
});

function extractChat(txt){ if(!txt) return null; try{ const u=new URL(txt); if(u.hash){ if(u.hash.startsWith('#card/')) return decodeURIComponent(u.hash.slice('#card/'.length)); if(u.hash.startsWith('#cardb64/')){ try{ const b = decodeURIComponent(u.hash.slice('#cardb64/'.length)); return b64DecodeUnicode(b); }catch(e){} } } }catch(e){} const m = txt.match(/#cardb64\/([^\s?#]+)/); if(m){ try{ return b64DecodeUnicode(decodeURIComponent(m[1])); }catch(e){} } const m2 = txt.match(/#card\/([^\s?#]+)/); if(m2) return decodeURIComponent(m2[1]); if(/^@/.test(txt) || /^\d+$/.test(txt)) return txt; return txt; }
function b64DecodeUnicode(str){ return decodeURIComponent(atob(str).split('').map(c=>('%'+('00'+c.charCodeAt(0).toString(16)).slice(-2))).join('')); }

function maskAndOpen(card){ 
  maskedCardEl.textContent = maskId(card); 
  merchantInput.value = merchantInput_scan.value.trim(); 
  scanStatus.textContent = 'âœ… Ú©Ø§Ø±Øª Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯: '+maskId(card);
  
  // clear sensitive fields
  pinInput.value = '';
  otpInput.value = '';
  txStatus.textContent = '';
  amountInput.value = '';
  
  // show tx section
  showSection(txSection);
}

/* --------------------------- OTP flow --------------------------- */
async function createAndSendOtp(cardChatId){
  const code = genOtp();
  const doc = { code, card: cardChatId, created: Date.now(), used:false, expires: Date.now()+2*60*1000 };
  const docRef = await db.collection('otps').add(doc);
  const text = `Ú©Ø¯ ÛŒÚ©â€ŒØ¨Ø§Ø±Ù…ØµØ±Ù ØªØ±Ø§Ú©Ù†Ø´ Ø´Ù…Ø§: ${code}\nØ§ÛŒÙ† Ú©Ø¯ ØªØ§ Û² Ø¯Ù‚ÛŒÙ‚Ù‡ Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. (Mahr Coin POS)`;
  // attempt to send; ignore failures but log
  sendTelegramMessageHidden(cardChatId, text).catch(console.warn);
  return { id: docRef.id, code };
}

sendOtpBtn.addEventListener('click', async ()=>{
  if(!scannedCardId) return alert('Ø®Ø·Ø§: Ø§Ø¨ØªØ¯Ø§ Ú©Ø§Ø±Øª Ø±Ø§ Ø§Ø³Ú©Ù† Ú©Ù†ÛŒØ¯.');
  
  sendOtpBtn.disabled = true; 
  txStatus.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§ÛŒØ¬Ø§Ø¯ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯...';
  
  try{ 
    await createAndSendOtp(scannedCardId); 
    txStatus.textContent = 'âœ… Ú©Ø¯ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù… ØµØ§Ø­Ø¨ Ú©Ø§Ø±Øª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯. Ø¢Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ùˆ ØªØ±Ø§Ú©Ù†Ø´ Ø±Ø§ ØªØ§ÛŒÛŒØ¯ Ú©Ù†ÛŒØ¯.'; 
  }catch(e){ 
    txStatus.textContent = 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯: '+e; 
  }
  sendOtpBtn.disabled = false;
});

/* --------------------------- confirm transaction --------------------------- */
confirmBtn.addEventListener('click', async ()=>{
  const merchant = (document.getElementById('merchantInput').value||'').trim();
  const amount = Number(amountInput.value)||0;
  const pin = (pinInput.value||'').trim() || '7444';
  const otp = (otpInput.value||'').trim();
  
  if(!scannedCardId) return alert('Ø®Ø·Ø§: Ú©Ø§Ø±Øª Ù…Ø´Ø®Øµ Ù†ÛŒØ³Øª.');
  if(!merchant) return alert('Ø®Ø·Ø§: Chat ID Ù¾Ø°ÛŒØ±Ù†Ø¯Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
  if(!amount || amount<=0) return alert('Ø®Ø·Ø§: Ù…Ø¨Ù„Øº Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.');
  if(pin.length !== 4) return alert('Ø®Ø·Ø§: PIN Ø¨Ø§ÛŒØ¯ Û´ Ø±Ù‚Ù…ÛŒ Ø¨Ø§Ø´Ø¯.');
  if(otp.length !== 5) return alert('Ø®Ø·Ø§: Ú©Ø¯ ÛŒÚ©Ø¨Ø§Ø±Ù…ØµØ±Ù Ûµ Ø±Ù‚Ù…ÛŒ Ø§Ø³Øª.');

  confirmBtn.disabled = true; 
  txStatus.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ú©Ø¯ Ùˆ Ø§Ù†Ø¬Ø§Ù… ØªØ±Ø§Ú©Ù†Ø´...';
  
  try{
    // 1. validate OTP (search recent otps for this card)
    const snap = await db.collection('otps').where('card','==',scannedCardId).orderBy('created','desc').limit(10).get();
    let found = null;
    snap.forEach(s=>{ const d=s.data(); if(!found && !d.used && d.code===otp && d.expires > Date.now()) found = { id:s.id, data:d }; });
    if(!found) throw 'Ú©Ø¯ ÛŒÚ©Ø¨Ø§Ø±Ù…ØµØ±Ù Ù†Ø§Ø¯Ø±Ø³Øª ÛŒØ§ Ù…Ù†Ù‚Ø¶ÛŒâ€ŒØ´Ø¯Ù‡ Ø§Ø³Øª.';

    // 2. mark OTP used
    await db.collection('otps').doc(found.id).update({ used:true, usedAt:Date.now() });

    // 3. pending record (prevents replay) â€“ not strictly necessary for security since tx is atomic, but good practice
    const pendingId = 'p_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,6);
    const pendingRef = db.collection('pendingTransactions').doc(pendingId);
    await pendingRef.set({ card:scannedCardId, merchant, amount, status:'pending', created:Date.now() });

    // 4. Perform atomic transfer
    const res = await transferAtomic(scannedCardId, merchant, amount, pin);

    // 5. mark pending done
    await pendingRef.update({ status:'done', txId: res.txId, doneAt: Date.now() });

    // clean sensitive inputs
    pinInput.value = ''; otpInput.value = ''; amountInput.value = '';

    // show summary
    await showSummary(res.txId);
  }catch(e){ 
    txStatus.textContent = 'âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ±Ø§Ú©Ù†Ø´: '+String(e); 
    confirmBtn.disabled = false; 
    // Re-enable OTP send for re-try
    sendOtpBtn.disabled = false;
  }
});

async function showSummary(txId){ // fetch transaction doc and display
  try{
    const snap = await db.collection('transactions').doc(txId).get();
    if(!snap.exists) { summaryBox.textContent = 'ØªØ±Ø§Ú©Ù†Ø´ Ø«Ø¨Øª Ø´Ø¯Ù‡ ÙˆÙ„ÛŒ Ø¬Ø²Ø¦ÛŒØ§Øª ÛŒØ§ÙØª Ù†Ø´Ø¯'; }
    else{
      const d = snap.data();
      const amount = Number(d.amount).toLocaleString('fa-IR');
      summaryBox.innerHTML = `
        <div><strong>Ù…Ø¨Ù„Øº:</strong> ${amount} â›</div>
        <div><strong>Ø§Ø² Ú©Ø§Ø±Øª:</strong> ${maskId(d.from)}</div>
        <div><strong>Ø¨Ù‡ Ù¾Ø°ÛŒØ±Ù†Ø¯Ù‡:</strong> ${maskId(d.to)}</div>
        <div class="small muted" style="margin-top:10px;">
            <strong>Ø´Ù†Ø§Ø³Ù‡ ØªØ±Ø§Ú©Ù†Ø´:</strong> ${d.id} 
            <br><strong>Ø²Ù…Ø§Ù†:</strong> ${new Date(d.ts).toLocaleString('fa-IR')}
        </div>
      `;
    }
    // hide other sections and show summary
    showSection(summarySection);
    // store last tx in sessionStorage (volatile) for potential use â€“ won't be visible until after tx
    sessionStorage.setItem('mahr_last_tx', txId);
  }catch(e){ 
    summaryBox.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø®Ù„Ø§ØµÙ‡: '+e; 
    showSection(summarySection); 
  }
}

/* --------------------------- cancel / new pay / finish handlers --------------------------- */
cancelTx.addEventListener('click', ()=>{ // go back to scan
  scannedCardId = null; maskedCardEl.textContent = 'â€”'; merchantInput_scan.value = merchantInput.value = ''; amountInput.value = ''; pinInput.value=''; otpInput.value=''; txStatus.textContent='ØªØ±Ø§Ú©Ù†Ø´ Ù„ØºÙˆ Ø´Ø¯.'; showSection(scanSection); });

newPayBtn.addEventListener('click', ()=>{ // reset and go to scan for new payment
  scannedCardId = null; maskedCardEl.textContent = 'â€”'; merchantInput_scan.value = merchantInput.value = ''; amountInput.value = ''; pinInput.value=''; otpInput.value=''; summaryBox.textContent='â€”'; txStatus.textContent='Ù¾Ø±Ø¯Ø§Ø®Øª Ø¬Ø¯ÛŒØ¯ Ø¢ØºØ§Ø² Ø´Ø¯.'; showSection(scanSection); });

finishBtn.addEventListener('click', ()=>{ // final step: clean and remain on summary
  // clear any local sensitive traces
  scannedCardId = null; pinInput.value=''; otpInput.value=''; amountInput.value='';
  // keep summary visible but clean
  txStatus.textContent = '';
});

/* --------------------------- init --------------------------- */
showSection(scanSection);
window.addEventListener('beforeunload', ()=>{ if(html5QrcodeScanner) html5QrcodeScanner.stop().catch(()=>{}); });

</script>
</body>
</html>