<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی حدس عدد و پنل شرط‌بندی ریسپانسیو</title>
    
    <!-- بارگذاری Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#1D4ED8', // آبی تیره اصلی
                        'accent': '#10B981',  // سبز زمردی (برای برد)
                        'danger': '#EF4444',  // قرمز (برای باخت)
                        'dark-bg': '#F3F4F6', // پس زمینه خاکستری روشن
                        'card-bg': '#FFFFFF', // پس زمینه کارت
                    },
                    fontFamily: {
                        sans: ['Vazirmatn', 'Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        'xl': '0 10px 20px rgba(0, 0, 0, 0.1), 0 6px 6px rgba(0, 0, 0, 0.05)',
                        '3xl': '0 35px 60px -15px rgba(0, 0, 0, 0.3)',
                    },
                }
            }
        }
    </script>
    <style>
        /* تنظیم فونت Vazirmatn برای زیبایی فارسی */
        @import url('https://cdn.fontcdn.ir/Font/Persian/Vazirmatn/Vazirmatn.css');
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--tw-colors-dark-bg);
            direction: rtl;
        }

        /* استایل اختصاصی برای دکمه‌ها */
        .btn-primary {
            background-color: var(--tw-colors-primary);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #1E40AF;
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(29, 78, 216, 0.3);
        }
        .btn-secondary {
            border: 1px solid #D1D5DB;
            background-color: #F9FAFB;
            color: #374151;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #E5E7EB;
            transform: translateY(-1px);
        }

        /* استایل نمایشگر عدد شانس */
        .random-number-display {
            width: 120px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #E0E7FF;
            border: 4px solid var(--tw-colors-primary);
            color: var(--tw-colors-primary);
            font-size: 56px;
            font-weight: 900;
            line-height: 1;
            transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            animation: pulse 2s infinite;
        }

        .random-number-display.win {
            background-color: #D1FAE5;
            border-color: var(--tw-colors-accent);
            color: var(--tw-colors-accent);
            animation: win-glow 1s ease forwards;
        }
        .random-number-display.lose {
            background-color: #FEE2E2;
            border-color: var(--tw-colors-danger);
            color: var(--tw-colors-danger);
        }
        
        .result-box.win {
            background-color: #D1FAE5;
            color: var(--tw-colors-accent);
            border-right: 5px solid var(--tw-colors-accent);
        }
        .result-box.lose {
            background-color: #FEE2E2;
            color: var(--tw-colors-danger);
            border-right: 5px solid var(--tw-colors-danger);
        }

        @keyframes win-glow {
            0% { box-shadow: 0 0 10px var(--tw-colors-accent); }
            50% { box-shadow: 0 0 25px var(--tw-colors-accent); }
            100% { box-shadow: none; }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 sm:p-8">

    <!-- کانتینر اصلی کارت ریسپانسیو -->
    <div class="w-full max-w-6xl bg-card-bg rounded-2xl shadow-3xl overflow-hidden mt-8">
        
        <!-- Grid Layout for Desktop (md:flex-row) -->
        <div class="flex flex-col md:flex-row">
            
            <!-- پنل اصلی بازی (سمت راست در دسکتاپ) -->
            <div class="w-full md:w-3/5 p-6 sm:p-10 space-y-6">
                
                <!-- هدر -->
                <header class="border-b border-gray-200 pb-4">
                    <h1 class="text-3xl font-extrabold text-gray-800">
                        بازی حدس عدد 🎲
                    </h1>
                    <p class="text-sm text-gray-500 mt-1">
                        شانس خود را امتحان کنید: ۱ تا ۳۰
                    </p>
                </header>

                <!-- --- بخش ۱: صفحه ورود --- -->
                <div id="loginScreen" class="space-y-5">
                    <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-primary text-sm text-primary font-medium">
                        برای شروع بازی و دیدن موجودی، با Chat ID تلگرام خود وارد شوید.
                    </div>
                    
                    <div>
                        <label for="chatIdInput" class="block mb-1 text-sm font-medium text-gray-700">شناسه کاربری تلگرام</label>
                        <input id="chatIdInput" type="number" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition" placeholder="Chat ID (مثلاً: 123456789)" />
                    </div>
                    
                    <div class="flex gap-3">
                        <button id="sendCodeBtn" class="btn-primary flex-1 p-3 text-white font-bold rounded-lg transition">
                            ارسال کد ورود
                        </button>
                        <button id="checkCodeBtn" class="btn-secondary flex-1 p-3 font-bold rounded-lg transition">
                            اعتبارسنجی کد
                        </button>
                    </div>
                    
                    <div>
                        <label for="codeInput" class="block mb-1 text-sm font-medium text-gray-700">کد تأیید دریافتی</label>
                        <input id="codeInput" type="number" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition" placeholder="کد ۵ رقمی" />
                    </div>
                </div>

                <!-- --- بخش ۲: صفحه بازی --- -->
                <div id="gameScreen" class="space-y-6" style="display:none">
                    
                    <!-- نمایشگر اصلی عدد -->
                    <div class="flex justify-center">
                        <div class="random-number-display rounded-full shadow-lg" id="randomNumberBox">
                            <span class="value">?</span>
                        </div>
                    </div>
                    
                    <!-- ورودی‌ها -->
                    <div>
                        <label for="guessInput" class="block mb-1 text-sm font-medium text-gray-700">حدس شما (بین ۱ تا ۳۰)</label>
                        <input id="guessInput" type="number" min="1" max="30" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent transition" placeholder="عدد مورد نظر" />
                    </div>
                    
                    <div>
                        <label for="betAmount" class="block mb-1 text-sm font-medium text-gray-700">مقدار شرط (حداقل 10,000 ⛁)</label>
                        <input id="betAmount" type="number" min="10000" value="10000" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition" />
                    </div>

                    <!-- دکمه‌های اقدام -->
                    <div class="flex gap-3">
                        <button id="placeBetBtn" class="btn-primary flex-1 p-3 text-white font-bold rounded-lg shadow-md hover:shadow-lg transition">
                            ثبت شرط 💸
                        </button>
                        <button id="guessBtn" class="btn-secondary w-1/3 p-3 font-bold rounded-lg shadow-md transition" disabled>
                            حدس بزن!
                        </button>
                    </div>

                    <!-- جعبه نتیجه -->
                    <div id="result" class="result-box p-4 rounded-lg text-center font-bold text-gray-700 bg-gray-100 border border-gray-300">
                        نتیجه: آماده برای ثبت شرط جدید.
                    </div>
                    
                    <button id="logoutBtn" class="text-sm text-gray-500 hover:text-danger transition">
                        خروج از حساب
                    </button>
                </div>

            </div>

            <!-- پنل اطلاعات جانبی (سمت چپ در دسکتاپ) -->
            <aside class="w-full md:w-2/5 p-6 sm:p-10 bg-gray-50 border-t md:border-t-0 md:border-r border-gray-200 space-y-6">
                
                <!-- وضعیت موجودی -->
                <div class="p-5 bg-card-bg rounded-xl shadow-lg border border-gray-200 text-center">
                    <p class="text-lg font-bold text-gray-700">موجودی حساب</p>
                    <span id="balance" class="block mt-2 text-5xl font-black text-primary">— ⛁</span>
                    <div class="text-xs text-gray-500 mt-4">
                        <span class="font-semibold">Chat ID:</span> <strong id="currentChat" class="ml-1">—</strong>
                    </div>
                    <div class="text-xs text-gray-400 mt-1" id="lastUpdate">
                        آخرین بروزرسانی: —
                    </div>
                    <button id="refreshBtn" class="btn-secondary w-full mt-4 p-2 text-sm font-semibold rounded-lg transition">
                        بروزرسانی موجودی
                    </button>
                </div>
                
                <!-- قوانین بازی -->
                <div class="space-y-3">
                    <h2 class="text-xl font-bold text-gray-800 border-b pb-2">📜 قوانین</h2>
                    <ul class="text-sm text-gray-600 list-disc pr-5 space-y-2">
                        <li>حدس باید عددی بین **۱ تا ۳۰** باشد.</li>
                        <li>حداقل شرط **۱۰۰۰۰** سکه است.</li>
                        <li>در صورت برد، **۵ برابر** مبلغ شرط را دریافت می‌کنید.</li>
                        <li>اگر ببازید، مبلغ شرط به حساب سیستم واریز می‌شود.</li>
                    </ul>
                </div>

                <!-- هشدار -->
                <div class="p-3 bg-red-100 border border-danger text-danger font-medium text-sm rounded-lg">
                    ⚠️ شرط‌بندی ریسک دارد و مبلغ از دست رفته قابل برگشت نیست.
                </div>
            </aside>
        </div>
    </div>

    <!-- Firebase Imports -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        /* ---------- تنظیمات (کدهای JS) ---------- */
        // ** توجه: این توکن تنها برای محیط‌های آزمایشی است و در حالت واقعی باید در سمت سرور مدیریت شود. **
        const XOR_KEY = 'rasan_key_42';
        const ENCODED_TOKEN_XOR = 'RVhEWVZnU1NNaA5zMyQ9CA0uBAM0JWFnGy5KU11uXDIjG25iNBtGNiI8WjQBKA=='; // رمزگذاری شده برای جلوگیری از مشاهده مستقیم
        
        function base64Decode(s){ try{ return atob(s); }catch(e){ return null; } }
        function xorString(str, key){ 
            let out=''; 
            for(let i=0;i<str.length;i++){ 
                out += String.fromCharCode(str.charCodeAt(i) ^ key.charCodeAt(i % key.length)); 
            } 
            return out; 
        }
        function getBotToken(){ 
            const step1 = base64Decode(ENCODED_TOKEN_XOR); 
            if(!step1) return null; 
            return xorString(step1, XOR_KEY); 
        }

        async function sendTelegramMessage(chatId, text){
            const token = getBotToken();
            if(!token) { console.error('Token decode failed'); return { ok:false, error:'Token decode failed' } }
            
            const url = `https://api.telegram.org/bot${encodeURIComponent(token)}/sendMessage`;
            try{
                const res = await fetch(url, { 
                    method:'POST', 
                    headers:{ 'Content-Type':'application/json' }, 
                    body: JSON.stringify({ chat_id: chatId, text }) 
                });
                const data = await res.json(); 
                return data;
            }catch(err){ 
                console.error('Telegram API Error:', err);
                return { ok:false, error: err.message } 
            }
        }

        /* ---------- Firebase config (Production Keys) ---------- */
        const firebaseConfig = {
            apiKey: "AIzaSyBiHkCAzkTzUO7weLsKGXc917JNob-dhO4",
            authDomain: "rasancoin.firebaseapp.com",
            projectId: "rasancoin",
            storageBucket: "rasancoin.firebasestorage.app",
            messagingSenderId: "289625483659",
            appId: "1:289625483659:web:b7e170072cf09a7157678e",
            measurementId: "G-KNNM4FF9MS"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        auth.signInAnonymously().catch(e=>console.warn("Firebase Anonymous Sign-In Error:", e));
        
        // Log firestore messages to console
        firebase.firestore.setLogLevel('debug');


        /* ---------- کمک‌کننده‌ها و منطق حسابی ---------- */
        const MIN_BET = 10000;
        const MIN_NUMBER = 1; 
        const MAX_NUMBER = 30;
        
        function genCode(){ return Math.floor(10000 + Math.random()*90000).toString() }
        function formatDate(ts){ 
            if(!ts) return '—'; 
            return new Date(ts).toLocaleString('fa-IR', { hour: '2-digit', minute: '2-digit', year: 'numeric', month: 'numeric', day: 'numeric' }); 
        }

        async function getUser(chatId){ 
            try {
                const doc = await db.collection('users').doc(chatId).get(); 
                return doc.exists ? doc.data() : null;
            } catch (e) {
                console.error("Error fetching user:", e);
                return null;
            }
        }
        async function setUser(chatId, userObj){ 
            try {
                await db.collection('users').doc(chatId).set(userObj, { merge:true });
            } catch (e) {
                console.error("Error setting user data:", e);
            }
        }

        // محاسبه سکه بر اساس زمان (هر ساعت ۱۰ سکه)
        async function accrueFor(user){ 
            const now = Date.now(); 
            if(!user.lastUpdated){ 
                user.lastUpdated = now; 
                return; 
            } 
            const elapsed = now - user.lastUpdated; 
            const hours = elapsed / 3600000;
            const coins = hours * 10;
            user.balance = (user.balance||0) + coins; 
            user.lastUpdated = now; 
        }

        /* ---------- UI عناصر و منطق بازی ---------- */
        const chatIdInput = document.getElementById('chatIdInput');
        const codeInput = document.getElementById('codeInput');
        const sendCodeBtn = document.getElementById('sendCodeBtn');
        const checkCodeBtn = document.getElementById('checkCodeBtn');
        const loginScreen = document.getElementById('loginScreen');
        const gameScreen = document.getElementById('gameScreen');
        const balanceEl = document.getElementById('balance');
        const lastUpdateEl = document.getElementById('lastUpdate');
        const currentChatEl = document.getElementById('currentChat');
        const placeBetBtn = document.getElementById('placeBetBtn');
        const guessBtn = document.getElementById('guessBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const betAmountInput = document.getElementById('betAmount');
        const guessInput = document.getElementById('guessInput');
        const resultEl = document.getElementById('result');
        const refreshBtn = document.getElementById('refreshBtn');
        const randomNumberBox = document.getElementById('randomNumberBox');

        let currentChatId = null;
        let pendingBet = null;
        let isProcessing = false;

        // --- جایگزین alert برای نمایش پیام به کاربر ---
        function displayMessage(message, isError = false) {
            // از کنسول استفاده می‌کنیم، اما در محیط واقعی باید با Modal یا Toast نمایش داده شود.
            if (isError) {
                console.error("USER ALERT (Error):", message);
            } else {
                console.log("USER ALERT (Info):", message);
            }
            alert(message); 
        }
        
        // --- مدیریت دکمه ارسال کد ---
        sendCodeBtn.addEventListener('click', async ()=>{
            if(isProcessing) return;
            const chatId = chatIdInput.value.trim(); 
            if(!chatId) return displayMessage('خطا: Chat ID را وارد کنید.', true);
            isProcessing = true;
            sendCodeBtn.disabled = true;

            try {
                const code = genCode();
                await db.collection('codes').doc(chatId).set({ code, created: Date.now() });
                const text = `کد ورود شما: ${code}\n(Mahr coin)`;
                const resp = await sendTelegramMessage(chatId, text);
                
                if(resp && resp.ok) {
                    displayMessage('✅ کد امنیتی با موفقیت به تلگرام شما ارسال شد. لطفاً کد را وارد کنید.', false);
                } else {
                    displayMessage('❌ خطا در ارسال کد. مطمئن شوید Chat ID صحیح است و ربات را Start کرده‌اید.', true);
                }
            } catch (e) {
                console.error("Send Code Error:", e);
                displayMessage('❌ خطای سیستمی هنگام ارسال کد.', true);
            } finally {
                isProcessing = false;
                sendCodeBtn.disabled = false;
            }
        });

        // --- مدیریت دکمه اعتبارسنجی کد ---
        checkCodeBtn.addEventListener('click', async ()=>{
            if(isProcessing) return;
            const chatId = chatIdInput.value.trim(); 
            const code = codeInput.value.trim(); 
            if(!chatId || !code) return displayMessage('خطا: Chat ID و کد را کامل وارد کنید.', true);
            isProcessing = true;
            checkCodeBtn.disabled = true;

            try {
                const snap = await db.collection('codes').doc(chatId).get(); 
                if(!snap.exists) return displayMessage('خطا: ابتدا «ارسال کد ورود» را بزنید.', true);
                
                const e = snap.data(); 
                if(e.code !== code) return displayMessage('خطا: کد اشتباه است.', true);

                let u = await getUser(chatId);
                if(!u) u = { balance: 100000, lastUpdated: Date.now(), telegramId: chatId }; // موجودی اولیه برای کاربر جدید
                
                await accrueFor(u); // بروزرسانی موجودی قبل از ورود
                await setUser(chatId, u);
                await db.collection('codes').doc(chatId).delete();
                
                currentChatId = chatId; 
                localStorage.setItem('natcoin_last_chat', chatId);
                showGame(); 
                await renderAccount();
                displayMessage('✅ ورود موفقیت‌آمیز. خوش آمدید.');
            } catch (e) {
                console.error("Check Code Error:", e);
                displayMessage('❌ خطای سیستمی هنگام ورود.', true);
            } finally {
                isProcessing = false;
                checkCodeBtn.disabled = false;
            }
        });

        // --- رندر کردن اطلاعات حساب کاربری ---
        async function renderAccount(){ 
            if(!currentChatId){ 
                balanceEl.textContent = '— ⛁'; 
                lastUpdateEl.textContent = 'آخرین بروزرسانی: —'; 
                currentChatEl.textContent='—'; 
                return; 
            }
            
            let u = await getUser(currentChatId); 
            if(!u) { // اگر به هر دلیلی اطلاعات از دست رفت
                currentChatId = null; 
                localStorage.removeItem('natcoin_last_chat');
                showLogin();
                return;
            }
            
            await accrueFor(u); // محاسبه موجودی جدید
            await setUser(currentChatId, u); // ذخیره موجودی جدید

            // نمایش موجودی و اطلاعات
            balanceEl.textContent = Math.floor(u.balance).toLocaleString('fa-IR') + ' ⛁'; 
            lastUpdateEl.textContent = 'آخرین بروزرسانی: ' + formatDate(u.lastUpdated); 
            currentChatEl.textContent = currentChatId;
        }

        refreshBtn.addEventListener('click', async ()=>{ 
            if(!currentChatId) return displayMessage('وارد نشده‌اید.', true); 
            refreshBtn.disabled = true;
            await renderAccount(); 
            refreshBtn.disabled = false;
            displayMessage('✅ موجودی به‌روزرسانی شد.'); 
        });

        logoutBtn.addEventListener('click', ()=>{ 
            currentChatId=null; 
            localStorage.removeItem('natcoin_last_chat'); 
            showLogin(); 
            renderAccount(); 
            displayMessage('✅ خروج امن انجام شد.'); 
        });

        // --- مدیریت دکمه ثبت شرط ---
        placeBetBtn.addEventListener('click', async ()=>{
            if(isProcessing || !currentChatId) return displayMessage('خطا: ابتدا وارد حساب کاربری شوید.', true);
            const amt = Math.floor(Number(betAmountInput.value) || 0);
            const guess = Math.floor(Number(guessInput.value) || 0);

            if(amt < MIN_BET) return displayMessage('خطا: حداقل شرط '+MIN_BET.toLocaleString('fa-IR')+' ⛁ است.', true);
            if(guess < MIN_NUMBER || guess > MAX_NUMBER) return displayMessage(`خطا: عدد حدسی باید بین ${MIN_NUMBER} تا ${MAX_NUMBER} باشد.`, true);
            
            isProcessing = true;
            placeBetBtn.disabled = true;

            try{
                const userRef = db.collection('users').doc(currentChatId);
                let balanceSufficient = false;

                // تراکنش برای کسر موجودی
                await db.runTransaction(async (tx)=>{
                    const doc = await tx.get(userRef);
                    if(!doc.exists) throw 'حساب یافت نشد';
                    const data = doc.data(); 
                    await accrueFor(data); // محاسبه سود ساعتی
                    
                    if((data.balance||0) < amt) throw 'moneynot';
                    
                    data.balance = (data.balance||0) - amt; 
                    data.lastUpdated = Date.now();
                    tx.update(userRef, { balance: data.balance, lastUpdated: data.lastUpdated });
                    balanceSufficient = true;
                });
                
                if (balanceSufficient) {
                    pendingBet = { amount: amt, guess: guess };
                    resultEl.textContent = `شرط شما ثبت شد: ${amt.toLocaleString('fa-IR')} ⛁ | حدس شما: ${guess} — حالا «حدس بزن!» را بزنید.`;
                    resultEl.classList.remove('win', 'lose');
                    resultEl.classList.add('bg-blue-100', 'border-blue-300'); // وضعیت انتظار
                    guessBtn.disabled = false; 
                    await renderAccount();
                }

            }catch(err){ 
                placeBetBtn.disabled = false;
                if(err==='moneynot') displayMessage('خطا: موجودی کافی نیست.', true); 
                else { console.error("Bet Transaction Error:", err); displayMessage('❌ خطا هنگام ثبت شرط.', true); } 
            } finally {
                isProcessing = false;
            }
        });

        function generateRandomNumber(){ 
            return Math.floor(Math.random() * (MAX_NUMBER - MIN_NUMBER + 1)) + MIN_NUMBER;
        }
        
        // --- انیمیشن شمارش معکوس عدد ---
        function animateNumberBox(){ 
            let count = 0;
            const maxCount = 20;
            const originalColor = randomNumberBox.style.color;
            randomNumberBox.classList.add('spinning');
            
            const interval = setInterval(()=>{
                if(count < maxCount) {
                    randomNumberBox.querySelector('.value').textContent = generateRandomNumber();
                    randomNumberBox.style.transform = `scale(${1 + Math.sin(count * 0.5) * 0.05})`;
                    count++;
                } else {
                    clearInterval(interval);
                    randomNumberBox.classList.remove('spinning');
                    randomNumberBox.style.transform = 'scale(1)';
                }
            }, 80);
            return interval;
        }

        // --- مدیریت دکمه حدس بزن ---
        guessBtn.addEventListener('click', async ()=>{
            if(isProcessing || !pendingBet) return displayMessage('خطا: ابتدا شرط را قرار دهید.', true);
            
            isProcessing = true;
            guessBtn.disabled = true;
            placeBetBtn.disabled = true;

            const animationInterval = animateNumberBox();

            const ANIMATION_DURATION = 80 * 20 + 200; // مدت زمان انیمیشن
            
            setTimeout(async ()=>{
                clearInterval(animationInterval);
                randomNumberBox.classList.remove('spinning');
                
                const winningNumber = generateRandomNumber();
                randomNumberBox.querySelector('.value').textContent = winningNumber;
                
                const userGuess = pendingBet.guess;
                const win = userGuess === winningNumber;
                
                const stake = pendingBet.amount; 
                pendingBet = null;
                placeBetBtn.disabled = false;
                
                try{
                    const userRef = db.collection('users').doc(currentChatId);
                    
                    if(win){
                        const winAmount = stake * 5; 
                        
                        await db.runTransaction(async (tx)=>{
                            const doc = await tx.get(userRef);
                            const data = doc.exists ? doc.data() : { balance:0, lastUpdated: Date.now() };
                            await accrueFor(data);
                            data.balance = (data.balance||0) + winAmount; 
                            data.lastUpdated = Date.now();
                            tx.set(userRef, data, { merge:true });
                        });

                        resultEl.textContent = `🎉 تبریک! عدد شانسی: ${winningNumber} (حدس شما: ${userGuess}) — جایزه: ${ winAmount.toLocaleString('fa-IR') } ⛁`;
                        resultEl.classList.remove('lose', 'bg-blue-100', 'border-blue-300');
                        resultEl.classList.add('win');
                        randomNumberBox.classList.remove('lose', 'bg-blue-100', 'border-blue-300');
                        randomNumberBox.classList.add('win');
                        
                    } else {
                        // در صورت باخت، موجودی قبلاً کسر شده است (در placeBetBtn)
                        resultEl.textContent = `😔 باخت. عدد شانسی: ${winningNumber} (حدس شما: ${userGuess}) — ${stake.toLocaleString('fa-IR')} ⛁ از دست رفت.`;
                        resultEl.classList.remove('win', 'bg-blue-100', 'border-blue-300');
                        resultEl.classList.add('lose');
                        randomNumberBox.classList.remove('win', 'bg-blue-100', 'border-blue-300');
                        randomNumberBox.classList.add('lose');
                    }
                    
                    // حذف افکت‌های رنگی پس از نمایش
                    setTimeout(() => {
                        randomNumberBox.classList.remove('win', 'lose');
                        resultEl.classList.remove('win', 'lose');
                        resultEl.classList.add('bg-gray-100', 'border-gray-300');
                        randomNumberBox.querySelector('.value').textContent = '?';
                    }, 3000);

                }catch(e){ 
                    console.error("Game Result Error:", e); 
                    resultEl.textContent = `❌ خطا در به‌روزرسانی حساب: لطفاً دوباره تلاش کنید.`;
                    resultEl.classList.remove('win', 'lose');
                }
                
                await renderAccount();
                isProcessing = false;
            }, ANIMATION_DURATION);
        });

        // --- توابع مدیریت وضعیت UI ---
        function showGame(){ 
            loginScreen.style.display='none'; 
            gameScreen.style.display='block'; 
            placeBetBtn.disabled=false; 
            guessBtn.disabled=true;
            randomNumberBox.querySelector('.value').textContent = '?';
            resultEl.textContent = `نتیجه: آماده برای ثبت شرط جدید.`;
            resultEl.classList.remove('win', 'lose', 'bg-blue-100', 'border-blue-300');
            resultEl.classList.add('bg-gray-100', 'border-gray-300');
            randomNumberBox.classList.remove('win', 'lose');
        }
        function showLogin(){ 
            loginScreen.style.display='block'; 
            gameScreen.style.display='none'; 
            pendingBet = null;
        }

        // --- شروع برنامه ---
        (async function init(){
            const last = localStorage.getItem('natcoin_last_chat'); 
            if(last) chatIdInput.value = last;
            
            if(last){
                currentChatId = last;
                try{ 
                    await renderAccount(); 
                    showGame(); 
                }catch(e){ 
                    console.error("Initialization Error:", e);
                    showLogin(); 
                }
            } else {
                showLogin();
            }
        })();
        
    </script>
</body>
</html>
