<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨Ø§Ø²ÛŒ Ø­Ø¯Ø³ Ø¹Ø¯Ø¯ Ùˆ Ù¾Ù†Ù„ Ø´Ø±Ø·â€ŒØ¨Ù†Ø¯ÛŒ Ø±ÛŒØ³Ù¾Ø§Ù†Ø³ÛŒÙˆ</title>
    
    <!-- Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#1D4ED8', // Ø¢Ø¨ÛŒ ØªÛŒØ±Ù‡ Ø§ØµÙ„ÛŒ
                        'accent': '#10B981',  // Ø³Ø¨Ø² Ø²Ù…Ø±Ø¯ÛŒ (Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø¯)
                        'danger': '#EF4444',  // Ù‚Ø±Ù…Ø² (Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø®Øª)
                        'dark-bg': '#F3F4F6', // Ù¾Ø³ Ø²Ù…ÛŒÙ†Ù‡ Ø®Ø§Ú©Ø³ØªØ±ÛŒ Ø±ÙˆØ´Ù†
                        'card-bg': '#FFFFFF', // Ù¾Ø³ Ø²Ù…ÛŒÙ†Ù‡ Ú©Ø§Ø±Øª
                    },
                    fontFamily: {
                        sans: ['Vazirmatn', 'Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        'xl': '0 10px 20px rgba(0, 0, 0, 0.1), 0 6px 6px rgba(0, 0, 0, 0.05)',
                        '3xl': '0 35px 60px -15px rgba(0, 0, 0, 0.3)',
                    },
                }
            }
        }
    </script>
    <style>
        /* ØªÙ†Ø¸ÛŒÙ… ÙÙˆÙ†Øª Vazirmatn Ø¨Ø±Ø§ÛŒ Ø²ÛŒØ¨Ø§ÛŒÛŒ ÙØ§Ø±Ø³ÛŒ */
        @import url('https://cdn.fontcdn.ir/Font/Persian/Vazirmatn/Vazirmatn.css');
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--tw-colors-dark-bg);
            direction: rtl;
        }

        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø§Ø®ØªØµØ§ØµÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
        .btn-primary {
            background-color: var(--tw-colors-primary);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #1E40AF;
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(29, 78, 216, 0.3);
        }
        .btn-secondary {
            border: 1px solid #D1D5DB;
            background-color: #F9FAFB;
            color: #374151;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #E5E7EB;
            transform: translateY(-1px);
        }

        /* Ø§Ø³ØªØ§ÛŒÙ„ Ù†Ù…Ø§ÛŒØ´Ú¯Ø± Ø¹Ø¯Ø¯ Ø´Ø§Ù†Ø³ */
        .random-number-display {
            width: 120px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #E0E7FF;
            border: 4px solid var(--tw-colors-primary);
            color: var(--tw-colors-primary);
            font-size: 56px;
            font-weight: 900;
            line-height: 1;
            transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            animation: pulse 2s infinite;
        }

        .random-number-display.win {
            background-color: #D1FAE5;
            border-color: var(--tw-colors-accent);
            color: var(--tw-colors-accent);
            animation: win-glow 1s ease forwards;
        }
        .random-number-display.lose {
            background-color: #FEE2E2;
            border-color: var(--tw-colors-danger);
            color: var(--tw-colors-danger);
        }
        
        .result-box.win {
            background-color: #D1FAE5;
            color: var(--tw-colors-accent);
            border-right: 5px solid var(--tw-colors-accent);
        }
        .result-box.lose {
            background-color: #FEE2E2;
            color: var(--tw-colors-danger);
            border-right: 5px solid var(--tw-colors-danger);
        }

        @keyframes win-glow {
            0% { box-shadow: 0 0 10px var(--tw-colors-accent); }
            50% { box-shadow: 0 0 25px var(--tw-colors-accent); }
            100% { box-shadow: none; }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 sm:p-8">

    <!-- Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø§ØµÙ„ÛŒ Ú©Ø§Ø±Øª Ø±ÛŒØ³Ù¾Ø§Ù†Ø³ÛŒÙˆ -->
    <div class="w-full max-w-6xl bg-card-bg rounded-2xl shadow-3xl overflow-hidden mt-8">
        
        <!-- Grid Layout for Desktop (md:flex-row) -->
        <div class="flex flex-col md:flex-row">
            
            <!-- Ù¾Ù†Ù„ Ø§ØµÙ„ÛŒ Ø¨Ø§Ø²ÛŒ (Ø³Ù…Øª Ø±Ø§Ø³Øª Ø¯Ø± Ø¯Ø³Ú©ØªØ§Ù¾) -->
            <div class="w-full md:w-3/5 p-6 sm:p-10 space-y-6">
                
                <!-- Ù‡Ø¯Ø± -->
                <header class="border-b border-gray-200 pb-4">
                    <h1 class="text-3xl font-extrabold text-gray-800">
                        Ø¨Ø§Ø²ÛŒ Ø­Ø¯Ø³ Ø¹Ø¯Ø¯ ğŸ²
                    </h1>
                    <p class="text-sm text-gray-500 mt-1">
                        Ø´Ø§Ù†Ø³ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯: Û± ØªØ§ Û³Û°
                    </p>
                </header>

                <!-- --- Ø¨Ø®Ø´ Û±: ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ --- -->
                <div id="loginScreen" class="space-y-5">
                    <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-primary text-sm text-primary font-medium">
                        Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ Ùˆ Ø¯ÛŒØ¯Ù† Ù…ÙˆØ¬ÙˆØ¯ÛŒØŒ Ø¨Ø§ Chat ID ØªÙ„Ú¯Ø±Ø§Ù… Ø®ÙˆØ¯ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.
                    </div>
                    
                    <div>
                        <label for="chatIdInput" class="block mb-1 text-sm font-medium text-gray-700">Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ ØªÙ„Ú¯Ø±Ø§Ù…</label>
                        <input id="chatIdInput" type="number" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition" placeholder="Chat ID (Ù…Ø«Ù„Ø§Ù‹: 123456789)" />
                    </div>
                    
                    <div class="flex gap-3">
                        <button id="sendCodeBtn" class="btn-primary flex-1 p-3 text-white font-bold rounded-lg transition">
                            Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ ÙˆØ±ÙˆØ¯
                        </button>
                        <button id="checkCodeBtn" class="btn-secondary flex-1 p-3 font-bold rounded-lg transition">
                            Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ú©Ø¯
                        </button>
                    </div>
                    
                    <div>
                        <label for="codeInput" class="block mb-1 text-sm font-medium text-gray-700">Ú©Ø¯ ØªØ£ÛŒÛŒØ¯ Ø¯Ø±ÛŒØ§ÙØªÛŒ</label>
                        <input id="codeInput" type="number" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition" placeholder="Ú©Ø¯ Ûµ Ø±Ù‚Ù…ÛŒ" />
                    </div>
                </div>

                <!-- --- Ø¨Ø®Ø´ Û²: ØµÙØ­Ù‡ Ø¨Ø§Ø²ÛŒ --- -->
                <div id="gameScreen" class="space-y-6" style="display:none">
                    
                    <!-- Ù†Ù…Ø§ÛŒØ´Ú¯Ø± Ø§ØµÙ„ÛŒ Ø¹Ø¯Ø¯ -->
                    <div class="flex justify-center">
                        <div class="random-number-display rounded-full shadow-lg" id="randomNumberBox">
                            <span class="value">?</span>
                        </div>
                    </div>
                    
                    <!-- ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ -->
                    <div>
                        <label for="guessInput" class="block mb-1 text-sm font-medium text-gray-700">Ø­Ø¯Ø³ Ø´Ù…Ø§ (Ø¨ÛŒÙ† Û± ØªØ§ Û³Û°)</label>
                        <input id="guessInput" type="number" min="1" max="30" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent transition" placeholder="Ø¹Ø¯Ø¯ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø±" />
                    </div>
                    
                    <div>
                        <label for="betAmount" class="block mb-1 text-sm font-medium text-gray-700">Ù…Ù‚Ø¯Ø§Ø± Ø´Ø±Ø· (Ø­Ø¯Ø§Ù‚Ù„ 10,000 â›)</label>
                        <input id="betAmount" type="number" min="10000" value="10000" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition" />
                    </div>

                    <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù‚Ø¯Ø§Ù… -->
                    <div class="flex gap-3">
                        <button id="placeBetBtn" class="btn-primary flex-1 p-3 text-white font-bold rounded-lg shadow-md hover:shadow-lg transition">
                            Ø«Ø¨Øª Ø´Ø±Ø· ğŸ’¸
                        </button>
                        <button id="guessBtn" class="btn-secondary w-1/3 p-3 font-bold rounded-lg shadow-md transition" disabled>
                            Ø­Ø¯Ø³ Ø¨Ø²Ù†!
                        </button>
                    </div>

                    <!-- Ø¬Ø¹Ø¨Ù‡ Ù†ØªÛŒØ¬Ù‡ -->
                    <div id="result" class="result-box p-4 rounded-lg text-center font-bold text-gray-700 bg-gray-100 border border-gray-300">
                        Ù†ØªÛŒØ¬Ù‡: Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ø´Ø±Ø· Ø¬Ø¯ÛŒØ¯.
                    </div>
                    
                    <button id="logoutBtn" class="text-sm text-gray-500 hover:text-danger transition">
                        Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨
                    </button>
                </div>

            </div>

            <!-- Ù¾Ù†Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¬Ø§Ù†Ø¨ÛŒ (Ø³Ù…Øª Ú†Ù¾ Ø¯Ø± Ø¯Ø³Ú©ØªØ§Ù¾) -->
            <aside class="w-full md:w-2/5 p-6 sm:p-10 bg-gray-50 border-t md:border-t-0 md:border-r border-gray-200 space-y-6">
                
                <!-- ÙˆØ¶Ø¹ÛŒØª Ù…ÙˆØ¬ÙˆØ¯ÛŒ -->
                <div class="p-5 bg-card-bg rounded-xl shadow-lg border border-gray-200 text-center">
                    <p class="text-lg font-bold text-gray-700">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø­Ø³Ø§Ø¨</p>
                    <span id="balance" class="block mt-2 text-5xl font-black text-primary">â€” â›</span>
                    <div class="text-xs text-gray-500 mt-4">
                        <span class="font-semibold">Chat ID:</span> <strong id="currentChat" class="ml-1">â€”</strong>
                    </div>
                    <div class="text-xs text-gray-400 mt-1" id="lastUpdate">
                        Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: â€”
                    </div>
                    <button id="refreshBtn" class="btn-secondary w-full mt-4 p-2 text-sm font-semibold rounded-lg transition">
                        Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ
                    </button>
                </div>
                
                <!-- Ù‚ÙˆØ§Ù†ÛŒÙ† Ø¨Ø§Ø²ÛŒ -->
                <div class="space-y-3">
                    <h2 class="text-xl font-bold text-gray-800 border-b pb-2">ğŸ“œ Ù‚ÙˆØ§Ù†ÛŒÙ†</h2>
                    <ul class="text-sm text-gray-600 list-disc pr-5 space-y-2">
                        <li>Ø­Ø¯Ø³ Ø¨Ø§ÛŒØ¯ Ø¹Ø¯Ø¯ÛŒ Ø¨ÛŒÙ† **Û± ØªØ§ Û³Û°** Ø¨Ø§Ø´Ø¯.</li>
                        <li>Ø­Ø¯Ø§Ù‚Ù„ Ø´Ø±Ø· **Û±Û°Û°Û°Û°** Ø³Ú©Ù‡ Ø§Ø³Øª.</li>
                        <li>Ø¯Ø± ØµÙˆØ±Øª Ø¨Ø±Ø¯ØŒ **Ûµ Ø¨Ø±Ø§Ø¨Ø±** Ù…Ø¨Ù„Øº Ø´Ø±Ø· Ø±Ø§ Ø¯Ø±ÛŒØ§ÙØª Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯.</li>
                        <li>Ø§Ú¯Ø± Ø¨Ø¨Ø§Ø²ÛŒØ¯ØŒ Ù…Ø¨Ù„Øº Ø´Ø±Ø· Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ø³ÛŒØ³ØªÙ… ÙˆØ§Ø±ÛŒØ² Ù…ÛŒâ€ŒØ´ÙˆØ¯.</li>
                    </ul>
                </div>

                <!-- Ù‡Ø´Ø¯Ø§Ø± -->
                <div class="p-3 bg-red-100 border border-danger text-danger font-medium text-sm rounded-lg">
                    âš ï¸ Ø´Ø±Ø·â€ŒØ¨Ù†Ø¯ÛŒ Ø±ÛŒØ³Ú© Ø¯Ø§Ø±Ø¯ Ùˆ Ù…Ø¨Ù„Øº Ø§Ø² Ø¯Ø³Øª Ø±ÙØªÙ‡ Ù‚Ø§Ø¨Ù„ Ø¨Ø±Ú¯Ø´Øª Ù†ÛŒØ³Øª.
                </div>
            </aside>
        </div>
    </div>

    <!-- Firebase Imports -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        /* ---------- ØªÙ†Ø¸ÛŒÙ…Ø§Øª (Ú©Ø¯Ù‡Ø§ÛŒ JS) ---------- */
        // ** ØªÙˆØ¬Ù‡: Ø§ÛŒÙ† ØªÙˆÚ©Ù† ØªÙ†Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ù…Ø­ÛŒØ·â€ŒÙ‡Ø§ÛŒ Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ Ø§Ø³Øª Ùˆ Ø¯Ø± Ø­Ø§Ù„Øª ÙˆØ§Ù‚Ø¹ÛŒ Ø¨Ø§ÛŒØ¯ Ø¯Ø± Ø³Ù…Øª Ø³Ø±ÙˆØ± Ù…Ø¯ÛŒØ±ÛŒØª Ø´ÙˆØ¯. **
        const XOR_KEY = 'rasan_key_42';
        const ENCODED_TOKEN_XOR = 'RVhEWVZnU1NNaA5zMyQ9CA0uBAM0JWFnGy5KU11uXDIjG25iNBtGNiI8WjQBKA=='; // Ø±Ù…Ø²Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù…Ø³ØªÙ‚ÛŒÙ…
        
        function base64Decode(s){ try{ return atob(s); }catch(e){ return null; } }
        function xorString(str, key){ 
            let out=''; 
            for(let i=0;i<str.length;i++){ 
                out += String.fromCharCode(str.charCodeAt(i) ^ key.charCodeAt(i % key.length)); 
            } 
            return out; 
        }
        function getBotToken(){ 
            const step1 = base64Decode(ENCODED_TOKEN_XOR); 
            if(!step1) return null; 
            return xorString(step1, XOR_KEY); 
        }

        async function sendTelegramMessage(chatId, text){
            const token = getBotToken();
            if(!token) { console.error('Token decode failed'); return { ok:false, error:'Token decode failed' } }
            
            const url = `https://api.telegram.org/bot${encodeURIComponent(token)}/sendMessage`;
            try{
                const res = await fetch(url, { 
                    method:'POST', 
                    headers:{ 'Content-Type':'application/json' }, 
                    body: JSON.stringify({ chat_id: chatId, text }) 
                });
                const data = await res.json(); 
                return data;
            }catch(err){ 
                console.error('Telegram API Error:', err);
                return { ok:false, error: err.message } 
            }
        }

        /* ---------- Firebase config (Production Keys) ---------- */
        const firebaseConfig = {
            apiKey: "AIzaSyBiHkCAzkTzUO7weLsKGXc917JNob-dhO4",
            authDomain: "rasancoin.firebaseapp.com",
            projectId: "rasancoin",
            storageBucket: "rasancoin.firebasestorage.app",
            messagingSenderId: "289625483659",
            appId: "1:289625483659:web:b7e170072cf09a7157678e",
            measurementId: "G-KNNM4FF9MS"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        auth.signInAnonymously().catch(e=>console.warn("Firebase Anonymous Sign-In Error:", e));
        
        // Log firestore messages to console
        firebase.firestore.setLogLevel('debug');


        /* ---------- Ú©Ù…Ú©â€ŒÚ©Ù†Ù†Ø¯Ù‡â€ŒÙ‡Ø§ Ùˆ Ù…Ù†Ø·Ù‚ Ø­Ø³Ø§Ø¨ÛŒ ---------- */
        const MIN_BET = 10000;
        const MIN_NUMBER = 1; 
        const MAX_NUMBER = 30;
        
        function genCode(){ return Math.floor(10000 + Math.random()*90000).toString() }
        function formatDate(ts){ 
            if(!ts) return 'â€”'; 
            return new Date(ts).toLocaleString('fa-IR', { hour: '2-digit', minute: '2-digit', year: 'numeric', month: 'numeric', day: 'numeric' }); 
        }

        async function getUser(chatId){ 
            try {
                const doc = await db.collection('users').doc(chatId).get(); 
                return doc.exists ? doc.data() : null;
            } catch (e) {
                console.error("Error fetching user:", e);
                return null;
            }
        }
        async function setUser(chatId, userObj){ 
            try {
                await db.collection('users').doc(chatId).set(userObj, { merge:true });
            } catch (e) {
                console.error("Error setting user data:", e);
            }
        }

        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ú©Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø²Ù…Ø§Ù† (Ù‡Ø± Ø³Ø§Ø¹Øª Û±Û° Ø³Ú©Ù‡)
        async function accrueFor(user){ 
            const now = Date.now(); 
            if(!user.lastUpdated){ 
                user.lastUpdated = now; 
                return; 
            } 
            const elapsed = now - user.lastUpdated; 
            const hours = elapsed / 3600000;
            const coins = hours * 10;
            user.balance = (user.balance||0) + coins; 
            user.lastUpdated = now; 
        }

        /* ---------- UI Ø¹Ù†Ø§ØµØ± Ùˆ Ù…Ù†Ø·Ù‚ Ø¨Ø§Ø²ÛŒ ---------- */
        const chatIdInput = document.getElementById('chatIdInput');
        const codeInput = document.getElementById('codeInput');
        const sendCodeBtn = document.getElementById('sendCodeBtn');
        const checkCodeBtn = document.getElementById('checkCodeBtn');
        const loginScreen = document.getElementById('loginScreen');
        const gameScreen = document.getElementById('gameScreen');
        const balanceEl = document.getElementById('balance');
        const lastUpdateEl = document.getElementById('lastUpdate');
        const currentChatEl = document.getElementById('currentChat');
        const placeBetBtn = document.getElementById('placeBetBtn');
        const guessBtn = document.getElementById('guessBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const betAmountInput = document.getElementById('betAmount');
        const guessInput = document.getElementById('guessInput');
        const resultEl = document.getElementById('result');
        const refreshBtn = document.getElementById('refreshBtn');
        const randomNumberBox = document.getElementById('randomNumberBox');

        let currentChatId = null;
        let pendingBet = null;
        let isProcessing = false;

        // --- Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† alert Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± ---
        function displayMessage(message, isError = false) {
            // Ø§Ø² Ú©Ù†Ø³ÙˆÙ„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…ØŒ Ø§Ù…Ø§ Ø¯Ø± Ù…Ø­ÛŒØ· ÙˆØ§Ù‚Ø¹ÛŒ Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Modal ÛŒØ§ Toast Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯.
            if (isError) {
                console.error("USER ALERT (Error):", message);
            } else {
                console.log("USER ALERT (Info):", message);
            }
            alert(message); 
        }
        
        // --- Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ú©Ù…Ù‡ Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ ---
        sendCodeBtn.addEventListener('click', async ()=>{
            if(isProcessing) return;
            const chatId = chatIdInput.value.trim(); 
            if(!chatId) return displayMessage('Ø®Ø·Ø§: Chat ID Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.', true);
            isProcessing = true;
            sendCodeBtn.disabled = true;

            try {
                const code = genCode();
                await db.collection('codes').doc(chatId).set({ code, created: Date.now() });
                const text = `Ú©Ø¯ ÙˆØ±ÙˆØ¯ Ø´Ù…Ø§: ${code}\n(Mahr coin)`;
                const resp = await sendTelegramMessage(chatId, text);
                
                if(resp && resp.ok) {
                    displayMessage('âœ… Ú©Ø¯ Ø§Ù…Ù†ÛŒØªÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù… Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.', false);
                } else {
                    displayMessage('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯. Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Chat ID ØµØ­ÛŒØ­ Ø§Ø³Øª Ùˆ Ø±Ø¨Ø§Øª Ø±Ø§ Start Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.', true);
                }
            } catch (e) {
                console.error("Send Code Error:", e);
                displayMessage('âŒ Ø®Ø·Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ Ù‡Ù†Ú¯Ø§Ù… Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯.', true);
            } finally {
                isProcessing = false;
                sendCodeBtn.disabled = false;
            }
        });

        // --- Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ú©Ù…Ù‡ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ú©Ø¯ ---
        checkCodeBtn.addEventListener('click', async ()=>{
            if(isProcessing) return;
            const chatId = chatIdInput.value.trim(); 
            const code = codeInput.value.trim(); 
            if(!chatId || !code) return displayMessage('Ø®Ø·Ø§: Chat ID Ùˆ Ú©Ø¯ Ø±Ø§ Ú©Ø§Ù…Ù„ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.', true);
            isProcessing = true;
            checkCodeBtn.disabled = true;

            try {
                const snap = await db.collection('codes').doc(chatId).get(); 
                if(!snap.exists) return displayMessage('Ø®Ø·Ø§: Ø§Ø¨ØªØ¯Ø§ Â«Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ ÙˆØ±ÙˆØ¯Â» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.', true);
                
                const e = snap.data(); 
                if(e.code !== code) return displayMessage('Ø®Ø·Ø§: Ú©Ø¯ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.', true);

                let u = await getUser(chatId);
                if(!u) u = { balance: 100000, lastUpdated: Date.now(), telegramId: chatId }; // Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
                
                await accrueFor(u); // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù‚Ø¨Ù„ Ø§Ø² ÙˆØ±ÙˆØ¯
                await setUser(chatId, u);
                await db.collection('codes').doc(chatId).delete();
                
                currentChatId = chatId; 
                localStorage.setItem('natcoin_last_chat', chatId);
                showGame(); 
                await renderAccount();
                displayMessage('âœ… ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ². Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯.');
            } catch (e) {
                console.error("Check Code Error:", e);
                displayMessage('âŒ Ø®Ø·Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ Ù‡Ù†Ú¯Ø§Ù… ÙˆØ±ÙˆØ¯.', true);
            } finally {
                isProcessing = false;
                checkCodeBtn.disabled = false;
            }
        });

        // --- Ø±Ù†Ø¯Ø± Ú©Ø±Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ ---
        async function renderAccount(){ 
            if(!currentChatId){ 
                balanceEl.textContent = 'â€” â›'; 
                lastUpdateEl.textContent = 'Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: â€”'; 
                currentChatEl.textContent='â€”'; 
                return; 
            }
            
            let u = await getUser(currentChatId); 
            if(!u) { // Ø§Ú¯Ø± Ø¨Ù‡ Ù‡Ø± Ø¯Ù„ÛŒÙ„ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø² Ø¯Ø³Øª Ø±ÙØª
                currentChatId = null; 
                localStorage.removeItem('natcoin_last_chat');
                showLogin();
                return;
            }
            
            await accrueFor(u); // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¬Ø¯ÛŒØ¯
            await setUser(currentChatId, u); // Ø°Ø®ÛŒØ±Ù‡ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¬Ø¯ÛŒØ¯

            // Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
            balanceEl.textContent = Math.floor(u.balance).toLocaleString('fa-IR') + ' â›'; 
            lastUpdateEl.textContent = 'Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ' + formatDate(u.lastUpdated); 
            currentChatEl.textContent = currentChatId;
        }

        refreshBtn.addEventListener('click', async ()=>{ 
            if(!currentChatId) return displayMessage('ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯.', true); 
            refreshBtn.disabled = true;
            await renderAccount(); 
            refreshBtn.disabled = false;
            displayMessage('âœ… Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.'); 
        });

        logoutBtn.addEventListener('click', ()=>{ 
            currentChatId=null; 
            localStorage.removeItem('natcoin_last_chat'); 
            showLogin(); 
            renderAccount(); 
            displayMessage('âœ… Ø®Ø±ÙˆØ¬ Ø§Ù…Ù† Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.'); 
        });

        // --- Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ú©Ù…Ù‡ Ø«Ø¨Øª Ø´Ø±Ø· ---
        placeBetBtn.addEventListener('click', async ()=>{
            if(isProcessing || !currentChatId) return displayMessage('Ø®Ø·Ø§: Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø´ÙˆÛŒØ¯.', true);
            const amt = Math.floor(Number(betAmountInput.value) || 0);
            const guess = Math.floor(Number(guessInput.value) || 0);

            if(amt < MIN_BET) return displayMessage('Ø®Ø·Ø§: Ø­Ø¯Ø§Ù‚Ù„ Ø´Ø±Ø· '+MIN_BET.toLocaleString('fa-IR')+' â› Ø§Ø³Øª.', true);
            if(guess < MIN_NUMBER || guess > MAX_NUMBER) return displayMessage(`Ø®Ø·Ø§: Ø¹Ø¯Ø¯ Ø­Ø¯Ø³ÛŒ Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† ${MIN_NUMBER} ØªØ§ ${MAX_NUMBER} Ø¨Ø§Ø´Ø¯.`, true);
            
            isProcessing = true;
            placeBetBtn.disabled = true;

            try{
                const userRef = db.collection('users').doc(currentChatId);
                let balanceSufficient = false;

                // ØªØ±Ø§Ú©Ù†Ø´ Ø¨Ø±Ø§ÛŒ Ú©Ø³Ø± Ù…ÙˆØ¬ÙˆØ¯ÛŒ
                await db.runTransaction(async (tx)=>{
                    const doc = await tx.get(userRef);
                    if(!doc.exists) throw 'Ø­Ø³Ø§Ø¨ ÛŒØ§ÙØª Ù†Ø´Ø¯';
                    const data = doc.data(); 
                    await accrueFor(data); // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³ÙˆØ¯ Ø³Ø§Ø¹ØªÛŒ
                    
                    if((data.balance||0) < amt) throw 'moneynot';
                    
                    data.balance = (data.balance||0) - amt; 
                    data.lastUpdated = Date.now();
                    tx.update(userRef, { balance: data.balance, lastUpdated: data.lastUpdated });
                    balanceSufficient = true;
                });
                
                if (balanceSufficient) {
                    pendingBet = { amount: amt, guess: guess };
                    resultEl.textContent = `Ø´Ø±Ø· Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯: ${amt.toLocaleString('fa-IR')} â› | Ø­Ø¯Ø³ Ø´Ù…Ø§: ${guess} â€” Ø­Ø§Ù„Ø§ Â«Ø­Ø¯Ø³ Ø¨Ø²Ù†!Â» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.`;
                    resultEl.classList.remove('win', 'lose');
                    resultEl.classList.add('bg-blue-100', 'border-blue-300'); // ÙˆØ¶Ø¹ÛŒØª Ø§Ù†ØªØ¸Ø§Ø±
                    guessBtn.disabled = false; 
                    await renderAccount();
                }

            }catch(err){ 
                placeBetBtn.disabled = false;
                if(err==='moneynot') displayMessage('Ø®Ø·Ø§: Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª.', true); 
                else { console.error("Bet Transaction Error:", err); displayMessage('âŒ Ø®Ø·Ø§ Ù‡Ù†Ú¯Ø§Ù… Ø«Ø¨Øª Ø´Ø±Ø·.', true); } 
            } finally {
                isProcessing = false;
            }
        });

        function generateRandomNumber(){ 
            return Math.floor(Math.random() * (MAX_NUMBER - MIN_NUMBER + 1)) + MIN_NUMBER;
        }
        
        // --- Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø´Ù…Ø§Ø±Ø´ Ù…Ø¹Ú©ÙˆØ³ Ø¹Ø¯Ø¯ ---
        function animateNumberBox(){ 
            let count = 0;
            const maxCount = 20;
            const originalColor = randomNumberBox.style.color;
            randomNumberBox.classList.add('spinning');
            
            const interval = setInterval(()=>{
                if(count < maxCount) {
                    randomNumberBox.querySelector('.value').textContent = generateRandomNumber();
                    randomNumberBox.style.transform = `scale(${1 + Math.sin(count * 0.5) * 0.05})`;
                    count++;
                } else {
                    clearInterval(interval);
                    randomNumberBox.classList.remove('spinning');
                    randomNumberBox.style.transform = 'scale(1)';
                }
            }, 80);
            return interval;
        }

        // --- Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ú©Ù…Ù‡ Ø­Ø¯Ø³ Ø¨Ø²Ù† ---
        guessBtn.addEventListener('click', async ()=>{
            if(isProcessing || !pendingBet) return displayMessage('Ø®Ø·Ø§: Ø§Ø¨ØªØ¯Ø§ Ø´Ø±Ø· Ø±Ø§ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯.', true);
            
            isProcessing = true;
            guessBtn.disabled = true;
            placeBetBtn.disabled = true;

            const animationInterval = animateNumberBox();

            const ANIMATION_DURATION = 80 * 20 + 200; // Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ø§Ù†ÛŒÙ…ÛŒØ´Ù†
            
            setTimeout(async ()=>{
                clearInterval(animationInterval);
                randomNumberBox.classList.remove('spinning');
                
                const winningNumber = generateRandomNumber();
                randomNumberBox.querySelector('.value').textContent = winningNumber;
                
                const userGuess = pendingBet.guess;
                const win = userGuess === winningNumber;
                
                const stake = pendingBet.amount; 
                pendingBet = null;
                placeBetBtn.disabled = false;
                
                try{
                    const userRef = db.collection('users').doc(currentChatId);
                    
                    if(win){
                        const winAmount = stake * 5; 
                        
                        await db.runTransaction(async (tx)=>{
                            const doc = await tx.get(userRef);
                            const data = doc.exists ? doc.data() : { balance:0, lastUpdated: Date.now() };
                            await accrueFor(data);
                            data.balance = (data.balance||0) + winAmount; 
                            data.lastUpdated = Date.now();
                            tx.set(userRef, data, { merge:true });
                        });

                        resultEl.textContent = `ğŸ‰ ØªØ¨Ø±ÛŒÚ©! Ø¹Ø¯Ø¯ Ø´Ø§Ù†Ø³ÛŒ: ${winningNumber} (Ø­Ø¯Ø³ Ø´Ù…Ø§: ${userGuess}) â€” Ø¬Ø§ÛŒØ²Ù‡: ${ winAmount.toLocaleString('fa-IR') } â›`;
                        resultEl.classList.remove('lose', 'bg-blue-100', 'border-blue-300');
                        resultEl.classList.add('win');
                        randomNumberBox.classList.remove('lose', 'bg-blue-100', 'border-blue-300');
                        randomNumberBox.classList.add('win');
                        
                    } else {
                        // Ø¯Ø± ØµÙˆØ±Øª Ø¨Ø§Ø®ØªØŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù‚Ø¨Ù„Ø§Ù‹ Ú©Ø³Ø± Ø´Ø¯Ù‡ Ø§Ø³Øª (Ø¯Ø± placeBetBtn)
                        resultEl.textContent = `ğŸ˜” Ø¨Ø§Ø®Øª. Ø¹Ø¯Ø¯ Ø´Ø§Ù†Ø³ÛŒ: ${winningNumber} (Ø­Ø¯Ø³ Ø´Ù…Ø§: ${userGuess}) â€” ${stake.toLocaleString('fa-IR')} â› Ø§Ø² Ø¯Ø³Øª Ø±ÙØª.`;
                        resultEl.classList.remove('win', 'bg-blue-100', 'border-blue-300');
                        resultEl.classList.add('lose');
                        randomNumberBox.classList.remove('win', 'bg-blue-100', 'border-blue-300');
                        randomNumberBox.classList.add('lose');
                    }
                    
                    // Ø­Ø°Ù Ø§ÙÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ø±Ù†Ú¯ÛŒ Ù¾Ø³ Ø§Ø² Ù†Ù…Ø§ÛŒØ´
                    setTimeout(() => {
                        randomNumberBox.classList.remove('win', 'lose');
                        resultEl.classList.remove('win', 'lose');
                        resultEl.classList.add('bg-gray-100', 'border-gray-300');
                        randomNumberBox.querySelector('.value').textContent = '?';
                    }, 3000);

                }catch(e){ 
                    console.error("Game Result Error:", e); 
                    resultEl.textContent = `âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø­Ø³Ø§Ø¨: Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.`;
                    resultEl.classList.remove('win', 'lose');
                }
                
                await renderAccount();
                isProcessing = false;
            }, ANIMATION_DURATION);
        });

        // --- ØªÙˆØ§Ø¨Ø¹ Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¶Ø¹ÛŒØª UI ---
        function showGame(){ 
            loginScreen.style.display='none'; 
            gameScreen.style.display='block'; 
            placeBetBtn.disabled=false; 
            guessBtn.disabled=true;
            randomNumberBox.querySelector('.value').textContent = '?';
            resultEl.textContent = `Ù†ØªÛŒØ¬Ù‡: Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ø´Ø±Ø· Ø¬Ø¯ÛŒØ¯.`;
            resultEl.classList.remove('win', 'lose', 'bg-blue-100', 'border-blue-300');
            resultEl.classList.add('bg-gray-100', 'border-gray-300');
            randomNumberBox.classList.remove('win', 'lose');
        }
        function showLogin(){ 
            loginScreen.style.display='block'; 
            gameScreen.style.display='none'; 
            pendingBet = null;
        }

        // --- Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡ ---
        (async function init(){
            const last = localStorage.getItem('natcoin_last_chat'); 
            if(last) chatIdInput.value = last;
            
            if(last){
                currentChatId = last;
                try{ 
                    await renderAccount(); 
                    showGame(); 
                }catch(e){ 
                    console.error("Initialization Error:", e);
                    showLogin(); 
                }
            } else {
                showLogin();
            }
        })();
        
    </script>
</body>
</html>
