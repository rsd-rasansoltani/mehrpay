<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Number Guessing Game — پنل شرط‌بندی</title>
  
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <style>
        :root{
  /* پالِت رنگی مدرن — می‌تونی این‌ها رو به دلخواه تغییر بدی */
  --bg: #0b0d10;
  --surface: linear-gradient(180deg, rgba(20,22,26,0.9), rgba(14,16,20,0.9));
  --glass: rgba(255,255,255,0.03);
  --muted: #9aa4b2;
  --primary: #5fb0ff;
  --primary-2: #3a86ff;
  --accent: #9b6bff;
  --success: #34d399;
  --danger: #fb7185;
  --border: rgba(255,255,255,0.04);
  --card-shadow: 0 8px 30px rgba(3,6,15,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
  --glass-border: rgba(255,255,255,0.04);
  --glass-glow: 0 6px 30px rgba(74,158,255,0.07);
  --radius-lg: 18px;
  --radius-md: 12px;
  --glass-blur: 10px;
  --trans-quick: 160ms;
  --trans-std: 260ms;
  --max-width: 1100px;
}

/* base */
*{box-sizing:border-box}
html,body{height:100%}
body{
  font-family: 'Vazirmatn', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background:
    radial-gradient(1200px 600px at 10% 10%, rgba(58,134,255,0.06), transparent 8%),
    radial-gradient(900px 400px at 90% 90%, rgba(155,107,255,0.04), transparent 6%),
    var(--bg);
  color: #e6eef8;
  margin:0;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  direction: rtl;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
  padding: 28px;
}

/* container + card */
.container{ width:95%; max-width:var(--max-width); margin: 10px auto; }
.card{
  display:flex;
  flex-direction:column;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius: calc(var(--radius-lg) + 4px);
  overflow: hidden;
  box-shadow: var(--card-shadow);
  border: 1px solid var(--glass-border);
}

/* layout */
.flex{ display:flex; gap: 18px; align-items:stretch; padding:20px; flex-wrap:wrap; }
.col.panel{ flex:1; padding:28px; min-width:320px; }
.right.panel{
  width:360px; min-width:280px; padding:24px;
  background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));
  border-left: 6px solid transparent;
  display:flex; flex-direction:column; gap:18px;
  align-items:stretch;
}

/* headers */
h1, h2{
  margin:0 0 8px 0;
  font-weight:800;
  letter-spacing:0.2px;
  color: linear-gradient(90deg,var(--primary),var(--accent));
  background: linear-gradient(90deg,var(--primary),var(--accent));
  -webkit-background-clip: text;
  background-clip:text;
  color:transparent;
  font-size: clamp(20px, 2.2vw, 26px);
}

/* text */
.muted{ color:var(--muted); font-size:14px; line-height:1.6; }
.muted.small{ font-size:13px; opacity:0.95 }

/* inputs */
input{
  appearance:none;
  -webkit-appearance:none;
  width:100%;
  padding:12px 14px;
  border-radius:10px;
  background: linear-gradient(180deg, rgba(255,255,255,0.012), rgba(0,0,0,0.03));
  border: 1px solid var(--border);
  color: #e9f2ff;
  font-size:15px;
  outline:none;
  transition: box-shadow var(--trans-std), border-color var(--trans-std), transform var(--trans-quick);
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.02);
}
input::placeholder{ color: rgba(230,238,255,0.18) }
input:focus{
  border-color: rgba(95,176,255,0.95);
  box-shadow: var(--glass-glow);
  transform: translateY(-1px);
}

/* buttons */
button{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:10px 14px;
  border-radius: 12px;
  font-weight:700;
  letter-spacing:0.2px;
  transition: transform var(--trans-quick), box-shadow var(--trans-quick), opacity var(--trans-std);
  border: none;
  background: transparent;
  color:inherit;
}
button:active{ transform: translateY(1px) scale(0.995) }
button:disabled{ opacity:0.5; cursor:not-allowed; transform:none }

/* primary / ghost */
button.primary{
  background: linear-gradient(90deg, var(--primary), var(--primary-2));
  color: #041027;
  box-shadow: 0 6px 22px rgba(58,134,255,0.12);
  border: 1px solid rgba(255,255,255,0.04);
}
button.primary:hover{ transform: translateY(-3px); box-shadow: 0 14px 40px rgba(58,134,255,0.14) }

button.ghost{
  background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
  border: 1px dashed rgba(255,255,255,0.04);
  color: var(--primary);
}
button.ghost:hover{ transform: translateY(-2px); border-color: rgba(95,176,255,0.45) }

/* controls */
.controls{ display:flex; gap:12px; margin-top:12px; align-items:center; }

/* balance box */
.balance-box{
  background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03));
  padding:18px;
  border-radius:14px;
  text-align:center;
  border:1px solid rgba(255,255,255,0.02);
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.02);
}
.balance-box .muted{ font-size:13px; color:var(--muted) }
#balance{
  display:block;
  margin-top:10px;
  font-size:28px;
  font-weight:900;
  color: #dff4ff;
  letter-spacing:0.6px;
  text-shadow: 0 8px 30px rgba(58,134,255,0.05);
}

/* small helpers */
hr{ border:none; border-top:1px dashed rgba(255,255,255,0.03); margin:18px 0; }

/* lists */
ul{ padding:0; margin:0; list-style:none; }
ul li{ margin:10px 0; color:var(--muted); font-weight:600; position:relative; padding-right:18px; }
ul li::before{
  content: "";
  width:8px; height:8px; border-radius:50%;
  background: linear-gradient(180deg,var(--primary),var(--accent));
  position:absolute; right:0; top:9px;
  box-shadow:0 6px 18px rgba(58,134,255,0.08);
}

/* alert */
.alert-box{
  background: linear-gradient(180deg, rgba(255,50,50,0.04), rgba(255,50,50,0.02));
  color: var(--danger);
  padding:12px;
  border-radius:10px;
  font-weight:700;
  border:1px solid rgba(251,113,133,0.06);
  box-shadow: 0 6px 20px rgba(251,113,133,0.03);
}

/* ----- بازی حدس عدد ----- */
.number-display{ display:flex; justify-content:center; align-items:center; margin-top:18px; }

.random-number-box{
  width:110px; height:110px; border-radius:18px;
  display:flex; align-items:center; justify-content:center;
  background: linear-gradient(180deg, rgba(255,255,255,0.016), rgba(0,0,0,0.06));
  border: 1px solid rgba(255,255,255,0.03);
  box-shadow: 0 12px 40px rgba(2,6,23,0.6), inset 0 -6px 18px rgba(0,0,0,0.4);
  position:relative;
  transition: transform var(--trans-std), box-shadow var(--trans-std);
  transform-origin:center center;
}
.random-number-box .value{
  display:inline-block;
  font-weight:900; font-size:44px;
  letter-spacing:1px;
  color: #e8f9ff;
  text-shadow:
    0 6px 30px rgba(90,170,255,0.06),
    0 2px 6px rgba(0,0,0,0.6);
}

/* neon glow for win state (toggle via .win on .status) */
.random-number-box.glow{
  box-shadow: 0 20px 60px rgba(58,134,255,0.12), 0 0 40px rgba(58,134,255,0.06);
  transform: translateY(-4px) scale(1.02);
}

/* spinning animation — keep quick and subtle */
.random-number-box.spinning{ animation: wobble 600ms ease-in-out infinite; }
@keyframes wobble{
  0%{ transform: rotate(-2deg) }
  50%{ transform: rotate(2deg) }
  100%{ transform: rotate(-2deg) }
}

/* status box */
.status{
  margin-top:16px;
  padding:12px;
  border-radius:12px;
  text-align:center;
  font-weight:800;
  background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));
  border:1px solid rgba(255,255,255,0.02);
}
.status.win{
  color: var(--success);
  border-color: rgba(52,211,153,0.12);
  background: linear-gradient(180deg, rgba(52,211,153,0.03), rgba(0,0,0,0.02));
}
.status.lose{
  color: var(--danger);
  border-color: rgba(251,113,133,0.08);
  background: linear-gradient(180deg, rgba(251,113,133,0.02), rgba(0,0,0,0.02));
}

/* confetti — سبک، ریسپانسیو و با افکت چرخش */
.confetti{ position: fixed; inset:0; pointer-events:none; z-index:9999; overflow:hidden; }
.confetti i{
  position:absolute; top:-20px; width:10px; height:14px; border-radius:4px;
  opacity:0.95;
  transform-origin:center;
  animation: fall 1200ms cubic-bezier(.2,.7,.2,1) forwards;
  will-change: transform, opacity;
}
@keyframes fall{
  0%{ transform: translateY(-10vh) rotate(0deg); opacity:1 }
  70%{ opacity:1 }
  100%{ transform: translateY(110vh) rotate(720deg); opacity:0 }
}

/* responsive */
@media (max-width:980px){
  .flex{ flex-direction:column; padding:18px; }
  .right.panel{ width:100%; border-left:none; border-top:6px solid rgba(58,134,255,0.06); padding-top:18px; }
  .random-number-box{ width:96px; height:96px; }
  #balance{ font-size:22px; }
}

/* reduced motion accessibility */
@media (prefers-reduced-motion: reduce){
  .random-number-box.spinning, .confetti i, .random-number-box{ animation: none !important; transition: none !important; transform:none !important; }
}

/* tiny helpers */
.hidden{ display:none !important }
.center{ display:flex; align-items:center; justify-content:center }

    </style>

</head>
<body>
  <div class="container">
    <div class="card">
      <div class="flex">
        
        <div class="col panel" id="uiArea" style="border: none; box-shadow: none;">
          
          <div id="loginScreen">
            <h1>ورود امن به پنل حدس عدد</h1>
            <p class="muted">برای دسترسی به بازی، Chat ID تلگرام خود را وارد کنید تا کد تأیید برای شما ارسال و حساب شما بارگذاری شود.</p>
            
            <div style="margin-top:20px">
              <label for="chatIdInput">شناسه کاربری تلگرام (Chat ID)</label>
              <input id="chatIdInput" placeholder="مثلاً: 123456789" />
            </div>
            
            <div class="controls">
              <button id="sendCodeBtn" class="primary" style="flex: 1;">ارسال کد (تلگرام)</button>
              <button id="checkCodeBtn" class="ghost" style="flex: 1;">اعتبارسنجی کد</button>
            </div>
            
            <div style="margin-top:15px">
              <label for="codeInput">کد تأیید دریافتی</label>
              <input id="codeInput" placeholder="کد 5 رقمی ارسالی" />
            </div>
            
            <div class="muted small" style="margin-top:15px">حداقل شرط برای شروع بازی <strong>10,000 ⛁</strong> است.</div>
          </div>

          <div id="gameScreen" style="display:none">
            <h2>🔢 بازی حدس عدد (۱ تا ۳۰)</h2>
            <p class="muted">موجودی و شرط خود را مدیریت کرده و شانس خود را با حدس عدد امتحان کنید.</p>

            <div class="number-display">
              <div class="random-number-box" id="randomNumberBox">
                <span class="value">?</span>
              </div>
            </div>

            <div style="margin-top:15px">
              <label for="guessInput">عدد حدسی شما (بین ۱ تا ۳۰)</label>
              <input id="guessInput" type="number" min="1" max="30" placeholder="عدد مورد نظر خود را وارد کنید" />
            </div>

            <div style="margin-top:15px">
              <label for="betAmount">مقدار شرط (حداقل 10,000)</label>
              <input id="betAmount" type="number" min="10000" value="10000" />
            </div>

            <div class="controls">
              <button id="placeBetBtn" class="primary" style="flex: 2;">قرار دادن شرط و کسر موجودی</button>
              <button id="guessBtn" class="ghost" disabled style="flex: 1;">🤔 حدس بزن</button>
            </div>

            <div id="result" class="status">نتیجه: هنوز شرطی بسته نشده است.</div>
            
            <div style="margin-top:20px" class="controls">
                 <button id="logoutBtn" class="ghost" style="width: 150px;">خروج امن از حساب</button>
            </div>
          </div>
        </div>

        <aside class="right panel" style="background: var(--color-background); border-left: 4px solid var(--color-secondary);">
          
          <div class="balance-box">
            <div class="muted">موجودی لحظه‌ای حساب</div>
            <span id="balance">— ⛁</span>
            <div class="muted" style="margin-top:10px;">شناسه شما: <strong id="currentChat">—</strong></div>
            <div class="muted" id="lastUpdate">آخرین بروزرسانی: —</div>
            
            <div style="margin-top:15px" class="controls">
              <button id="refreshBtn" class="primary" style="flex:1;">بروزرسانی موجودی</button>
            </div>
          </div>
          
          <hr style="margin:25px 0;border:none;border-top:1px dashed var(--color-border);" />

          <div>
            <h2>📝 قوانین و راهنما</h2>
            <ul class="muted">
              <li>۱) ابتدا احراز هویت را از طریق تلگرام انجام دهید.</li>
              <li>۲) حداقل شرط ۱۰۰۰۰ است. مبلغ شرط هنگام «قرار دادن شرط» از موجودی شما کسر می‌شود.</li>
              <li>۳) عددی بین **۱ تا ۳۰** را حدس بزنید و مقدار شرط را مشخص کنید.</li>
              <li>۴) اگر عدد شما با عدد تصادفی تولید شده **یکسان** باشد، برنده شده و **۳ برابر** مبلغ شرط به حساب شما واریز می‌شود.</li>
              <li>۵) در غیر این صورت، مبلغ شرط حذف می‌شود.</li>
            </ul>
          </div>
          
          <div class="alert-box">
             ⚠️ **هشدار:** بعد از «قرار دادن شرط»، مبلغ غیرقابل برگشت است. با مسئولیت خود اقدام کنید.
          </div>
        </aside>
      </div>
    </div>
  </div>

  <div id="confetti" class="confetti" aria-hidden="true"></div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script>
    /* ---------- تنظیمات (کدهای JS بدون تغییر باقی می‌مانند) ---------- */
    const XOR_KEY = 'rasan_key_42';
    const ENCODED_TOKEN_XOR = 'RVhEWVZnU1NNaA5zMyQ9CA0uBAM0JWFnGy5KU11uXDIjG25iNBtGNiI8WjQBKA==';

    function base64Decode(s){ try{ return atob(s); }catch(e){ return null; } }
    function xorString(str, key){ let out=''; for(let i=0;i<str.length;i++){ out += String.fromCharCode(str.charCodeAt(i) ^ key.charCodeAt(i % key.length)); } return out; }
    function getBotToken(){ const step1 = base64Decode(ENCODED_TOKEN_XOR); if(!step1) return null; return xorString(step1, XOR_KEY); }

    async function sendTelegramMessage(chatId, text){
      const token = getBotToken();
      if(!token) { console.error('token decode failed'); return { ok:false, error:'token decode failed' } }
      const url = `https://api.telegram.org/bot${encodeURIComponent(token)}/sendMessage`;
      try{
        const res = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ chat_id: chatId, text }) });
        const data = await res.json(); return data;
      }catch(err){ return { ok:false, error: err.message } }
    }

    /* ---------- Firebase config ---------- */
    const firebaseConfig = {
      apiKey: "AIzaSyBiHkCAzkTzUO7weLsKGXc917JNob-dhO4",
      authDomain: "rasancoin.firebaseapp.com",
      projectId: "rasancoin",
      storageBucket: "rasancoin.firebasestorage.app",
      messagingSenderId: "289625483659",
      appId: "1:289625483659:web:b7e170072cf09a7157678e",
      measurementId: "G-KNNM4FF9MS"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    auth.signInAnonymously().catch(e=>console.warn(e));

    /* ---------- کمک‌کننده‌ها و منطق حسابی (تغییر یافته) ---------- */
    const MIN_BET = 10000;
    // MIN_NUMBER و MAX_NUMBER برای بازی حدس عدد جدید
    const MIN_NUMBER = 1; 
    const MAX_NUMBER = 30;
    
    function genCode(){ return Math.floor(10000 + Math.random()*90000).toString() }
    function formatDate(ts){ if(!ts) return '—'; return new Date(ts).toLocaleString('fa-IR', { hour: '2-digit', minute: '2-digit', year: 'numeric', month: 'numeric', day: 'numeric' }); }

    async function getUser(chatId){ const doc = await db.collection('users').doc(chatId).get(); return doc.exists ? doc.data() : null }
    async function setUser(chatId, userObj){ await db.collection('users').doc(chatId).set(userObj, { merge:true }) }

    async function accrueFor(user){ const now = Date.now(); if(!user.lastUpdated){ user.lastUpdated = now; return; } const elapsed = now - user.lastUpdated; const coins = elapsed / 3600000 * 10;
      user.balance = (user.balance||0) + coins; user.lastUpdated = now; }

    /* ---------- UI عناصر ---------- */
    const chatIdInput = document.getElementById('chatIdInput');
    const codeInput = document.getElementById('codeInput');
    const sendCodeBtn = document.getElementById('sendCodeBtn');
    const checkCodeBtn = document.getElementById('checkCodeBtn');
    const loginScreen = document.getElementById('loginScreen');
    const gameScreen = document.getElementById('gameScreen');
    const balanceEl = document.getElementById('balance');
    const lastUpdateEl = document.getElementById('lastUpdate');
    const currentChatEl = document.getElementById('currentChat');
    const placeBetBtn = document.getElementById('placeBetBtn');
    const guessBtn = document.getElementById('guessBtn'); // تغییر نام دکمه
    const logoutBtn = document.getElementById('logoutBtn');
    const betAmountInput = document.getElementById('betAmount');
    const guessInput = document.getElementById('guessInput'); // ورودی جدید حدس
    const resultEl = document.getElementById('result');
    const refreshBtn = document.getElementById('refreshBtn');
    const randomNumberBox = document.getElementById('randomNumberBox');

    let currentChatId = null;
    let pendingBet = null; // { amount, guess }

    /* ---------- ارسال/دریافت کد (بدون تغییر) ---------- */
    sendCodeBtn.addEventListener('click', async ()=>{
      const chatId = chatIdInput.value.trim(); if(!chatId) return alert('خطا: Chat ID را وارد کنید.');
      const code = genCode();
      await db.collection('codes').doc(chatId).set({ code, created: Date.now() });
      const text = `کد ورود شما: ${code}\n(Mahr coin)`;
      const resp = await sendTelegramMessage(chatId, text);
      if(resp && resp.ok) alert('✅ کد امنیتی با موفقیت به تلگرام شما ارسال شد.'); 
      else alert('❌ خطا در ارسال کد. مطمئن شوید Chat ID صحیح است.');
    });

    checkCodeBtn.addEventListener('click', async ()=>{
      const chatId = chatIdInput.value.trim(); const code = codeInput.value.trim(); if(!chatId||!code) return alert('خطا: Chat ID و کد را کامل وارد کنید.');
      const snap = await db.collection('codes').doc(chatId).get(); if(!snap.exists) return alert('خطا: ابتدا «ارسال کد» را بزنید.');
      const e = snap.data(); if(e.code !== code) return alert('خطا: کد اشتباه است.');

      let u = await getUser(chatId);
      if(!u) u = { balance:0, lastUpdated: Date.now() };
      await setUser(chatId, u);
      await db.collection('codes').doc(chatId).delete();
      currentChatId = chatId; localStorage.setItem('natcoin_last_chat', chatId);
      showGame(); await renderAccount();
      alert('✅ ورود موفقیت‌آمیز.');
    });

    /* ---------- رندر حساب (بدون تغییر) ---------- */
    async function renderAccount(){ 
        if(!currentChatId){ 
            balanceEl.textContent = '— ⛁'; 
            lastUpdateEl.textContent = 'آخرین بروزرسانی: —'; 
            currentChatEl.textContent='—'; 
            return; 
        }
        let u = await getUser(currentChatId); 
        if(!u) u = { balance:0, lastUpdated: Date.now() };
        await accrueFor(u); await setUser(currentChatId, u);
        
        balanceEl.textContent = Math.floor(u.balance).toLocaleString('fa-IR') + ' ⛁'; 
        lastUpdateEl.textContent = 'آخرین بروزرسانی: ' + formatDate(u.lastUpdated); 
        currentChatEl.textContent = currentChatId;
    }

    refreshBtn.addEventListener('click', async ()=>{ if(!currentChatId) return alert('وارد نشده‌اید.'); await renderAccount(); alert('✅ موجودی به‌روزرسانی شد.'); });

    logoutBtn.addEventListener('click', ()=>{ 
        currentChatId=null; 
        localStorage.removeItem('natcoin_last_chat'); 
        showLogin(); 
        renderAccount(); 
        alert('✅ خروج امن انجام شد.'); 
    });

    /* ---------- قرار دادن شرط (Transaction) - تغییر کوچک برای دریافت حدس ---------- */
    placeBetBtn.addEventListener('click', async ()=>{
      if(!currentChatId) return alert('خطا: ابتدا وارد حساب کاربری شوید.');
      const amt = Math.floor(Number(betAmountInput.value) || 0);
      const guess = Math.floor(Number(guessInput.value) || 0);

      if(amt < MIN_BET) return alert('خطا: حداقل شرط '+MIN_BET.toLocaleString()+' ⛁ است.');
      if(guess < MIN_NUMBER || guess > MAX_NUMBER) return alert(`خطا: عدد حدسی باید بین ${MIN_NUMBER} تا ${MAX_NUMBER} باشد.`);

      try{
        const userRef = db.collection('users').doc(currentChatId);
        await db.runTransaction(async (tx)=>{
          const doc = await tx.get(userRef);
          if(!doc.exists) throw 'حساب یافت نشد';
          const data = doc.data(); await accrueFor(data);
          if((data.balance||0) < amt) throw 'moneynot';
          data.balance = (data.balance||0) - amt; data.lastUpdated = Date.now();
          tx.update(userRef, { balance: data.balance, lastUpdated: data.lastUpdated });
        });
        pendingBet = { amount: amt, guess: guess }; // ذخیره حدس
        resultEl.textContent = `شرط گذاشته شد: ${amt.toLocaleString('fa-IR')} ⛁ | حدس شما: ${guess} — حالا حدس بزنید.`;
        resultEl.classList.remove('win', 'lose');
        guessBtn.disabled = false; placeBetBtn.disabled = true; await renderAccount();
      }catch(err){ 
          if(err==='moneynot') alert('خطا: موجودی کافی نیست.'); 
          else { console.error(err); alert('❌ خطا هنگام ثبت شرط.'); } 
      }
    });

    /* ---------- منطق حدس زدن (جدید) ---------- */
    function generateRandomNumber(){ 
        // تولید عدد تصادفی بین ۱ تا ۳۰
        return Math.floor(Math.random() * (MAX_NUMBER - MIN_NUMBER + 1)) + MIN_NUMBER;
    }
    function animateNumberBox(){ 
        randomNumberBox.classList.add('spinning'); 
        randomNumberBox.querySelector('.value').textContent = '?';
        // هر ۵۰ میلی‌ثانیه یک عدد تصادفی موقت نمایش داده می‌شود
        const interval = setInterval(()=>{
          randomNumberBox.querySelector('.value').textContent = generateRandomNumber();
        }, 50);
        return interval;
    }
    function makeConfetti(){ 
        const conf = document.getElementById('confetti'); 
        for(let i=0;i<40;i++){ 
            const piece = document.createElement('i'); 
            piece.style.left = Math.random()*100 + 'vw'; 
            piece.style.top = '-10px'; 
            piece.style.width = (6+Math.random()*10)+'px'; 
            piece.style.height = (8+Math.random()*10)+'px'; 
            piece.style.background = `hsl(${Math.floor(Math.random()*360)} 90% 60%)`; 
            piece.style.position='absolute'; 
            piece.style.opacity='0.95'; 
            piece.style.animation='fall 1200ms linear forwards'; 
            conf.appendChild(piece); 
            setTimeout(()=>piece.remove(),1600); 
        } 
    }

    guessBtn.addEventListener('click', async ()=>{
      if(!pendingBet) return alert('خطا: ابتدا شرط را قرار دهید.');
      
      guessBtn.disabled = true;
      const animationInterval = animateNumberBox(); // شروع انیمیشن

      setTimeout(async ()=>{
        clearInterval(animationInterval); // توقف انیمیشن
        randomNumberBox.classList.remove('spinning');
        
        const winningNumber = generateRandomNumber();
        randomNumberBox.querySelector('.value').textContent = winningNumber; // نمایش عدد نهایی
        
        const userGuess = pendingBet.guess;
        const win = userGuess === winningNumber; // منطق برد جدید
        
        const stake = pendingBet.amount; pendingBet = null;
        placeBetBtn.disabled = false;
        
        try{
          const userRef = db.collection('users').doc(currentChatId);
          
          if(win){
            // جایزه ۳ برابر مبلغ شرط (2*stake سود + 1*stake برگشت)
            const winAmount = stake * 3; 
            await db.runTransaction(async (tx)=>{
              const doc = await tx.get(userRef);
              const data = doc.exists ? doc.data() : { balance:0, lastUpdated: Date.now() };
              await accrueFor(data);
              // اضافه کردن کل مبلغ (شرط اصلی + ۲ برابر سود)
              data.balance = (data.balance||0) + winAmount; 
              data.lastUpdated = Date.now();
              tx.set(userRef, data, { merge:true });
            });
            resultEl.textContent = `🎉 **برد!** عدد تصادفی: **${winningNumber}** (حدس شما: ${userGuess}) — جایزه: **${ winAmount.toLocaleString('fa-IR') } ⛁** اضافه شد.`;
            resultEl.classList.remove('lose');
            resultEl.classList.add('win');
            makeConfetti();
          } else {
            resultEl.textContent = `😔 **باخت.** عدد تصادفی: **${winningNumber}** (حدس شما: ${userGuess}) — مبلغ ${stake.toLocaleString('fa-IR')} ⛁ از دست رفت.`;
            resultEl.classList.remove('win');
            resultEl.classList.add('lose');
          }
        }catch(e){ 
            console.error(e); 
            resultEl.textContent = `❌ خطا در به‌روزرسانی حساب: لطفاً دوباره تلاش کنید.`;
            resultEl.classList.remove('win', 'lose');
        }
        await renderAccount();
      }, 1500); // افزایش زمان برای انیمیشن
    });

    /* ---------- یک‌بار اجرا: بازیابی localStorage و init (بدون تغییر) ---------- */
    (async function init(){
      const last = localStorage.getItem('natcoin_last_chat'); if(last) chatIdInput.value = last;
      if(localStorage.getItem('natcoin_last_chat')){
        currentChatId = localStorage.getItem('natcoin_last_chat');
        try{ await renderAccount(); showGame(); }catch(e){ showLogin(); }
      } else {
        showLogin();
      }
    })();

    function showGame(){ 
        loginScreen.style.display='none'; 
        gameScreen.style.display='block'; 
        placeBetBtn.disabled=false; 
        guessBtn.disabled=true;
        // اطمینان از مقداردهی اولیه برای بازی جدید
        randomNumberBox.querySelector('.value').textContent = '?';
        resultEl.textContent = `نتیجه: هنوز شرطی بسته نشده است.`;
        resultEl.classList.remove('win', 'lose');
    }
    function showLogin(){ 
        loginScreen.style.display='block'; 
        gameScreen.style.display='none'; 
        pendingBet = null;
    }
    
  </script>
</body>
</html>